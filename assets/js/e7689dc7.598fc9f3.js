"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[6896],{6888:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"golang/tutorials/step-tutorial","title":"Steps","description":"When using DBOS workflows, you should call any function that performs complex operations or accesses external APIs or services as a step.","source":"@site/docs/golang/tutorials/step-tutorial.md","sourceDirName":"golang/tutorials","slug":"/golang/tutorials/step-tutorial","permalink":"/golang/tutorials/step-tutorial","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":20,"frontMatter":{"sidebar_position":20,"title":"Steps"},"sidebar":"tutorialSidebar","previous":{"title":"Workflows","permalink":"/golang/tutorials/workflow-tutorial"},"next":{"title":"Queues & Concurrency","permalink":"/golang/tutorials/queue-tutorial"}}');var s=n(4848),o=n(8453);const i={sidebar_position:20,title:"Steps"},a=void 0,l={},c=[{value:"Configurable Retries",id:"configurable-retries",level:3}];function u(e){const t={a:"a",code:"code",em:"em",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["When using DBOS workflows, you should call any function that performs complex operations or accesses external APIs or services as a ",(0,s.jsx)(t.em,{children:"step"}),".\nIf a workflow is interrupted, upon restart it automatically resumes execution from the ",(0,s.jsx)(t.strong,{children:"last completed step"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["You can use ",(0,s.jsx)(t.a,{href:"../reference/workflows-steps#runasstep",children:(0,s.jsx)(t.code,{children:"RunAsStep"})})," to call a function as a step.\nFor a function to be used as a step, it should return a serializable (",(0,s.jsx)(t.a,{href:"https://pkg.go.dev/encoding/gob",children:"gob-encodable"}),") value and an error and have this signature:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:"type Step[R any] func(ctx context.Context) (R, error)\n"})}),"\n",(0,s.jsx)(t.p,{children:"Here's a simple example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func generateRandomNumber(ctx context.Context) (int, error) {\n\treturn rand.Int(), nil\n}\n\nfunc workflowFunction(ctx dbos.DBOSContext, n int) (int, error) {\n\trandomNumber, err := dbos.RunAsStep(\n        ctx,\n\t\tgenerateRandomNumber,\n\t\tdbos.WithStepName("generateRandomNumber"),\n\t)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\treturn randomNumber, nil\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"You can pass arguments into a step by wrapping it in an anonymous function, like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func generateRandomNumber(ctx context.Context, n int) (int, error) {\n\treturn rand.IntN(n), nil\n}\n\nfunc workflowFunction(ctx dbos.DBOSContext, n int) (int, error) {\n\trandomNumber, err := dbos.RunAsStep(\n\t\tctx,\n\t\tfunc(stepCtx context.Context) (int, error) {\n\t\t\treturn generateRandomNumber(stepCtx, n)\n\t\t},\n\t\tdbos.WithStepName("generateRandomNumber")\n\t)\n\tif err != nil {\n\t\treturn 0, err\n\t}\n\treturn randomNumber, nil\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You should make a function a step if you're using it in a DBOS workflow and it performs a ",(0,s.jsx)(t.a,{href:"/golang/tutorials/workflow-tutorial#determinism",children:(0,s.jsx)(t.strong,{children:"nondeterministic"})})," operation.\nA nondeterministic operation is one that may return different outputs given the same inputs.\nCommon nondeterministic operations include:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Accessing an external API or service, like serving a file from ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/s3/",children:"AWS S3"}),", calling an external API like ",(0,s.jsx)(t.a,{href:"https://stripe.com/",children:"Stripe"}),", or accessing an external data store like ",(0,s.jsx)(t.a,{href:"https://www.elastic.co/elasticsearch/",children:"Elasticsearch"}),"."]}),"\n",(0,s.jsx)(t.li,{children:"Accessing files on disk."}),"\n",(0,s.jsx)(t.li,{children:"Generating a random number."}),"\n",(0,s.jsx)(t.li,{children:"Getting the current time."}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["You ",(0,s.jsx)(t.strong,{children:"cannot"})," call, start, or enqueue workflows from within steps.\nYou also cannot call DBOS methods like ",(0,s.jsx)(t.code,{children:"Send"})," or ",(0,s.jsx)(t.code,{children:"SetEvent"})," from within steps.\nThese operations should be performed from workflow functions.\nYou can call one step from another step, but the called step becomes part of the calling step's execution rather than functioning as a separate step."]}),"\n",(0,s.jsx)(t.h3,{id:"configurable-retries",children:"Configurable Retries"}),"\n",(0,s.jsxs)(t.p,{children:["You can optionally configure a step to automatically retry any error a set number of times with exponential backoff.\nThis is useful for automatically handling transient failures, like making requests to unreliable APIs.\nRetries are configurable through step options that can be passed to ",(0,s.jsx)(t.code,{children:"RunAsStep"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Available retry configuration options include:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"../reference/workflows-steps#withstepname",children:(0,s.jsx)(t.code,{children:"WithStepName"})})," - Custom name for the step (default to the ",(0,s.jsx)(t.a,{href:"https://pkg.go.dev/runtime#FuncForPC",children:"Go runtime reflection value"}),")"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"../reference/workflows-steps#withstepmaxretries",children:(0,s.jsx)(t.code,{children:"WithStepMaxRetries"})})," - Maximum number of times this step is automatically retried on failure (default 0)"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"../reference/workflows-steps#withmaxinterval",children:(0,s.jsx)(t.code,{children:"WithMaxInterval"})})," - Maximum delay between retries (default 5s)"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"../reference/workflows-steps#withbackofffactor",children:(0,s.jsx)(t.code,{children:"WithBackoffFactor"})})," - Exponential backoff multiplier between retries (default 2.0)"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"../reference/workflows-steps#withbaseinterval",children:(0,s.jsx)(t.code,{children:"WithBaseInterval"})})," - Initial delay between retries (default 100ms)"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"For example, let's configure this step to retry failures (such as if the site to be fetched is temporarily down) up to 10 times:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'func fetchStep(ctx context.Context, url string) (string, error) {\n\tresp, err := http.Get(url)\n\tif err != nil {\n\t\treturn "", err\n\t}\n\tdefer resp.Body.Close()\n\n\tbody, err := io.ReadAll(resp.Body)\n\tif err != nil {\n\t\treturn "", err\n\t}\n\n\treturn string(body), nil\n}\n\nfunc fetchWorkflow(ctx dbos.DBOSContext, inputURL string) (string, error) {\n\treturn dbos.RunAsStep(\n\t\tctx,\n\t\tfunc(stepCtx context.Context) (string, error) {\n\t\t\treturn fetchStep(stepCtx, inputURL)\n\t\t},\n\t\tdbos.WithStepName("fetchFunction"),\n\t\tdbos.WithStepMaxRetries(10),\n\t\tdbos.WithMaxInterval(30*time.Second),\n\t\tdbos.WithBackoffFactor(2.0),\n\t\tdbos.WithBaseInterval(500*time.Millisecond),\n\t)\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"If a step exhausts all retry attempts, it returns an error to the calling workflow."})]})}function d(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(6540);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);