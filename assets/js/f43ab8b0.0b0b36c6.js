"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[9453],{4924:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"typescript/examples/checkout-tutorial","title":"Fault-Tolerant Checkout","description":"In this example, we use DBOS and Fastify to deploy an online storefront that\'s resilient to any failure.","source":"@site/docs/typescript/examples/checkout-tutorial.md","sourceDirName":"typescript/examples","slug":"/typescript/examples/checkout-tutorial","permalink":"/typescript/examples/checkout-tutorial","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":1,"title":"Fault-Tolerant Checkout"},"sidebar":"examplesSidebar","previous":{"title":"Hacker News Slackbot","permalink":"/python/examples/hacker-news-bot"},"next":{"title":"Kafka Alert Queue","permalink":"/typescript/examples/kafka-alert-queue"}}');var s=t(4848),o=t(8453);const i={displayed_sidebar:"examplesSidebar",sidebar_position:1,title:"Fault-Tolerant Checkout"},a=void 0,d={},c=[{value:"The Checkout Workflow",id:"the-checkout-workflow",level:2},{value:"The Checkout and Payment Endpoints",id:"the-checkout-and-payment-endpoints",level:2},{value:"Database Operations",id:"database-operations",level:2},{value:"Finishing Up",id:"finishing-up",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2},{value:"Deploying to DBOS Cloud",id:"deploying-to-dbos-cloud",level:3},{value:"Running Locally",id:"running-locally",level:3}];function l(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,o.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"In this example, we use DBOS and Fastify to deploy an online storefront that's resilient to any failure."}),"\n",(0,s.jsxs)(n.p,{children:["You can see the application live ",(0,s.jsx)(n.a,{href:"https://demo-widget-store.cloud.dbos.dev/",children:"here"}),".\nTry playing with it and pressing the crash button as often as you want.\nWithin a few seconds, the app will recover and resume as if nothing happened."]}),"\n",(0,s.jsxs)(n.p,{children:["All source code is ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript/widget-store",children:"available on GitHub"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Widget store UI",src:t(8662).A+"",width:"2818",height:"1200"})}),"\n",(0,s.jsx)(n.h2,{id:"the-checkout-workflow",children:"The Checkout Workflow"}),"\n",(0,s.jsx)(n.p,{children:"First, let's write the checkout workflow.\nThis workflow is triggered whenever a customer buys a widget.\nIt creates a new order, then reserves inventory, then processes payment, then marks the order as paid and dispatches the order for fulfillment.\nIf any step fails, it backs out, returning reserved inventory and marking the order as cancelled."}),"\n",(0,s.jsxs)(n.p,{children:["DBOS ",(0,s.jsx)(n.em,{children:"durably executes"})," this workflow: each of its steps executes exactly-once and if it's ever interrupted, it automatically resumes from where it left off.\nYou can try this yourself!\nOn the ",(0,s.jsx)(n.a,{href:"https://demo-widget-store.cloud.dbos.dev/",children:"live application"}),", start an order and press the crash button at any time.\nWithin seconds, your app will recover to exactly the state it was in before the crash and continue as if nothing happened."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"export class Shop {\n  @DBOS.workflow()\n  static async paymentWorkflow(): Promise<void> {\n    // Attempt to reserve inventory, failing if no inventory remains\n    try {\n      await ShopUtilities.subtractInventory();\n    } catch (error) {\n      DBOS.logger.error(`Failed to update inventory: ${(error as Error).message}`);\n      await DBOS.setEvent(PAYMENT_ID_EVENT, null);\n      return;\n    }\n\n    // Create a new order\n    const orderID = await ShopUtilities.createOrder();\n\n    // Send a unique payment ID to the checkout endpoint so it can\n    // redirect the customer to the payments page\n    await DBOS.setEvent(PAYMENT_ID_EVENT, DBOS.workflowID);\n    const notification = await DBOS.recv<string>(PAYMENT_TOPIC, 120);\n\n    // If payment succeeded, mark the order as paid and start the order dispatch workflow.\n    // Otherwise, return reserved inventory and cancel the order.\n    if (notification && notification === 'paid') {\n      DBOS.logger.info(`Payment successful!`);\n      await ShopUtilities.markOrderPaid(orderID);\n      await DBOS.startWorkflow(ShopUtilities).dispatchOrder(orderID);\n    } else {\n      DBOS.logger.warn(`Payment failed...`);\n      await ShopUtilities.errorOrder(orderID);\n      await ShopUtilities.undoSubtractInventory();\n    }\n\n    // Finally, send the order ID to the payment endpoint so it can redirect\n    // the customer to the order status page.\n    await DBOS.setEvent(ORDER_ID_EVENT, orderID);\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"the-checkout-and-payment-endpoints",children:"The Checkout and Payment Endpoints"}),"\n",(0,s.jsx)(n.p,{children:"Now, let's use Fastify to write the HTTP endpoint for checkout."}),"\n",(0,s.jsx)(n.p,{children:'This endpoint receives a request when a customer presses the "Buy Now" button.\nIt starts the checkout workflow in the background, then waits for the workflow to generate and send it a unique payment ID.\nIt then returns the payment ID so the browser can redirect the user to the payments page.'}),"\n",(0,s.jsxs)(n.p,{children:["The endpoint accepts an ",(0,s.jsx)(n.a,{href:"/typescript/tutorials/workflow-tutorial#workflow-ids-and-idempotency",children:"idempotency key"}),' so that even if the customer presses "buy now" multiple times, only one checkout workflow is started.']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const fastify = Fastify({logger: true});\n\nfastify.post<{\n  Params: { key: string };\n}>('/checkout/:key', async (req, reply) => {\n  const key = req.params.key;\n  // Idempotently start the checkout workflow in the background.\n  const handle = await DBOS.startWorkflow(Shop, { workflowID: key }).paymentWorkflow();\n  // Wait for the checkout workflow to send a payment ID, then return it.\n  const paymentID = await DBOS.getEvent<string | null>(handle.workflowID, PAYMENT_ID_EVENT);\n  if (paymentID === null) {\n    DBOS.logger.error('checkout failed');\n    return reply.code(500).send('Error starting checkout');\n  }\n  return paymentID;\n});\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"Let's also write the HTTP endpoint for payments.\nIt listens for any payment event generated by the user.\nIt uses the payment ID to signal the checkout workflow whether the payment succeeded or failed.\nIt then retrieves the order ID from the checkout workflow so the browser can redirect the customer to the order status page."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"fastify.post<{\n  Params: { key: string; status: string };\n}>('/payment_webhook/:key/:status', async (req, reply) => {\n  const { key, status } = req.params;\n  // Send the payment status to the checkout workflow.\n  await DBOS.send(key, status, PAYMENT_TOPIC);\n  // Wait for the checkout workflow to send an order ID, then return it.\n  const orderID = await DBOS.getEvent<string>(key, ORDER_ID_EVENT);\n  if (orderID === null) {\n    DBOS.logger.error('retrieving order ID failed');\n    return reply.code(500).send('Error retrieving order ID');\n  }\n  return orderID;\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"database-operations",children:"Database Operations"}),"\n",(0,s.jsxs)(n.p,{children:["Next, let's write some database operations.\nEach of these functions performs a simple CRUD operation, like retrieving product information or updating inventory.\nWe apply the ",(0,s.jsx)(n.a,{href:"/typescript/tutorials/transaction-tutorial",children:(0,s.jsx)(n.code,{children:"@DBOS.transaction"})})," to each of them to give them access to a pre-configured database connection.\nWe also add HTTP endpoints for some of them with Fastify."]}),"\n",(0,s.jsxs)(r,{children:[(0,s.jsx)("summary",{children:"Database Operations and HTTP Endpoints"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"export class ShopUtilities {\n  @DBOS.transaction()\n  static async subtractInventory(): Promise<void> {\n    const numAffected = await DBOS.knexClient<Product>('products')\n      .where('product_id', PRODUCT_ID)\n      .andWhere('inventory', '>=', 1)\n      .update({\n        inventory: DBOS.knexClient.raw('inventory - ?', 1),\n      });\n    if (numAffected <= 0) {\n      throw new Error('Insufficient Inventory');\n    }\n  }\n\n  @DBOS.transaction()\n  static async undoSubtractInventory(): Promise<void> {\n    await DBOS.knexClient<Product>('products')\n      .where({ product_id: PRODUCT_ID })\n      .update({ inventory: DBOS.knexClient.raw('inventory + ?', 1) });\n  }\n\n  @DBOS.transaction()\n  static async setInventory(inventory: number): Promise<void> {\n    await DBOS.knexClient<Product>('products').where({ product_id: PRODUCT_ID }).update({ inventory });\n  }\n\n  @DBOS.transaction()\n  static async retrieveProduct(): Promise<Product> {\n    const item = await DBOS.knexClient<Product>('products').select('*').where({ product_id: PRODUCT_ID });\n    if (!item.length) {\n      throw new Error(`Product ${PRODUCT_ID} not found`);\n    }\n    return item[0];\n  }\n\n  @DBOS.transaction()\n  static async createOrder(): Promise<number> {\n    const orders = await DBOS.knexClient<Order>('orders')\n      .insert({\n        order_status: OrderStatus.PENDING,\n        product_id: PRODUCT_ID,\n        last_update_time: DBOS.knexClient.fn.now(),\n        progress_remaining: 10,\n      })\n      .returning('order_id');\n    const orderID = orders[0].order_id;\n    return orderID;\n  }\n\n  @DBOS.transaction()\n  static async markOrderPaid(order_id: number): Promise<void> {\n    await DBOS.knexClient<Order>('orders').where({ order_id: order_id }).update({\n      order_status: OrderStatus.PAID,\n      last_update_time: DBOS.knexClient.fn.now(),\n    });\n  }\n\n  @DBOS.transaction()\n  static async errorOrder(order_id: number): Promise<void> {\n    await DBOS.knexClient<Order>('orders').where({ order_id: order_id }).update({\n      order_status: OrderStatus.CANCELLED,\n      last_update_time: DBOS.knexClient.fn.now(),\n    });\n  }\n\n  @DBOS.transaction()\n  static async retrieveOrder(order_id: number): Promise<Order> {\n    const item = await DBOS.knexClient<Order>('orders').select('*').where({ order_id: order_id });\n    if (!item.length) {\n      throw new Error(`Order ${order_id} not found`);\n    }\n    return item[0];\n  }\n\n  @DBOS.transaction()\n  static async retrieveOrders() {\n    return DBOS.knexClient<Order>('orders').select('*');\n  }\n}\n\n// Fastify HTTP endpoints\n\nfastify.get('/product', async () => {\n  return await ShopUtilities.retrieveProduct();\n});\n\nfastify.get<{\n  Params: { order_id: string };\n}>('/order/:order_id', async (req) => {\n  const order_id = Number(req.params.order_id);\n  return await ShopUtilities.retrieveOrder(order_id);\n});\n\nfastify.get('/orders', async () => {\n  return await ShopUtilities.retrieveOrders();\n});\n\nfastify.post('/restock', async () => {\n  return await ShopUtilities.setInventory(12);\n});\n\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"finishing-up",children:"Finishing Up"}),"\n",(0,s.jsx)(n.p,{children:"A few more functions to go!"}),"\n",(0,s.jsxs)(n.p,{children:['First, let\'s write a workflow to dispatch orders that have been paid for.\nThis function is responsible for the "progress bar" you see for paid orders on the ',(0,s.jsx)(n.a,{href:"https://demo-widget-store.cloud.dbos.dev/",children:"live demo page"}),".\nEvery second, it updates the progress of a paid order, then dispatches the order if it is fully progressed."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"export class ShopUtilities {\n  @DBOS.workflow()\n  static async dispatchOrder(order_id: number) {\n    for (let i = 0; i < 10; i++) {\n      await DBOS.sleep(1000);\n      await ShopUtilities.update_order_progress(order_id);\n    }\n  }\n\n  @DBOS.transaction()\n  static async update_order_progress(order_id: number): Promise<void> {\n    const orders = await DBOS.knexClient<Order>('orders').where({\n      order_id: order_id,\n      order_status: OrderStatus.PAID,\n    });\n    if (!orders.length) {\n      throw new Error(`No PAID order with ID ${order_id} found`);\n    }\n\n    const order = orders[0];\n    if (order.progress_remaining > 1) {\n      await DBOS.knexClient<Order>('orders')\n        .where({ order_id: order_id })\n        .update({ progress_remaining: order.progress_remaining - 1 });\n    } else {\n      await DBOS.knexClient<Order>('orders').where({ order_id: order_id }).update({\n        order_status: OrderStatus.DISPATCHED,\n        progress_remaining: 0,\n      });\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Let's also serve the app's frontend from an HTML file using Fastify.\nIn production, we recommend using DBOS primarily for the backend, with your frontend deployed elsewhere."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"fastify.get('/', async (req, reply) => {\n  async function render(file: string, ctx?: object): Promise<string> {\n    const engine = new Liquid({\n      root: path.resolve(__dirname, '..', 'public'),\n    });\n    return (await engine.renderFile(file, ctx)) as string;\n  }\n  const html = await render('app.html', {});\n  return reply.type('text/html').send(html);\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"Here is the crash endpoint. It crashes your app. Trigger it as many times as you want\u2014DBOS always comes back, resuming from exactly where it left off!"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"fastify.post('/crash_application', () => {\n  process.exit(1);\n});\n"})}),"\n",(0,s.jsx)(n.p,{children:"Finally, let's start DBOS and the Fastify server:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"async function main() {\n  const PORT = 3000;\n  DBOS.setConfig({\n    name: 'widget-store-node',\n    databaseUrl: process.env.DBOS_DATABASE_URL,\n  });\n  await DBOS.launch();\n  await fastify.listen({ port: PORT, host: \"0.0.0.0\" });\n  console.log(`\ud83d\ude80 Server is running on http://localhost:${PORT}`);\n}\n\nmain().catch(console.log);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,s.jsx)(n.h3,{id:"deploying-to-dbos-cloud",children:"Deploying to DBOS Cloud"}),"\n",(0,s.jsx)(n.p,{children:"To deploy this example to DBOS Cloud, first install the Cloud CLI (requires Node):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm i -g @dbos-inc/dbos-cloud\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then clone the ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository and deploy:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd typescript/widget-store\ndbos-cloud app deploy\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This command outputs a URL\u2014visit it to see your app!\nYou can also visit the ",(0,s.jsx)(n.a,{href:"https://console.dbos.dev/login-redirect",children:"DBOS Cloud Console"})," to see your app's status and logs."]}),"\n",(0,s.jsx)(n.h3,{id:"running-locally",children:"Running Locally"}),"\n",(0,s.jsxs)(n.p,{children:["First, clone and enter the ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd typescript/widget-store\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then install dependencies, build your app, and set up its database tables:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm install\nnpm run build\nnpx knex migrate:latest\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then, start it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm run start\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, run it in dev mode using ",(0,s.jsx)(n.code,{children:"nodemon"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm install\nnpm run dev\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Visit ",(0,s.jsx)(n.a,{href:"http://localhost:3000",children:(0,s.jsx)(n.code,{children:"http://localhost:3000"})})," to see your app!"]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8662:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/widget_store_ui-79bb688e390e2df7d21955f49e6bd036.png"},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const s={},o=r.createContext(s);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);