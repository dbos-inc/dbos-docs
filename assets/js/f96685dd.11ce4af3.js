"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[2241],{6666:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"typescript/upgrading","title":"Upgrading to TSv3","description":"With the release of DBOS Transact TypeScript version 3 (DBOS TSv3), some APIs that were marked as deprecated in v2 have been removed.","source":"@site/docs/typescript/upgrading.md","sourceDirName":"typescript","slug":"/typescript/upgrading","permalink":"/typescript/upgrading","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":200,"frontMatter":{"sidebar_position":200,"title":"Upgrading to TSv3"},"sidebar":"tutorialSidebar","previous":{"title":"DBOS Task Scheduler","permalink":"/typescript/examples/task-scheduler"},"next":{"title":"Deploying To Production","permalink":"/production/"}}');var t=n(4848),o=n(8453);const a={sidebar_position:200,title:"Upgrading to TSv3"},i=void 0,c={},d=[{value:"Clean Up <code>dbos-config.yaml</code>",id:"clean-up-dbos-configyaml",level:2},{value:"Use Start Commands And <code>DBOS.launch</code>",id:"use-start-commands-and-dboslaunch",level:3},{value:"Update Context-based Methods",id:"update-context-based-methods",level:2},{value:"Accessing Context",id:"accessing-context",level:2},{value:"Datasources",id:"datasources",level:2},{value:"HTTP Package",id:"http-package",level:2},{value:"Remove Deprecated Step Packages",id:"remove-deprecated-step-packages",level:2},{value:"@dbos-inc/dbos-datetime Package",id:"dbos-incdbos-datetime-package",level:3},{value:"@dbos-inc/dbos-random Package",id:"dbos-incdbos-random-package",level:3},{value:"@dbos-inc/dbos-bcrypt Package",id:"dbos-incdbos-bcrypt-package",level:3},{value:"Other Packages",id:"other-packages",level:2},{value:"Kafka Consumer Packages",id:"kafka-consumer-packages",level:3},{value:"AWS SQS Receiver Package",id:"aws-sqs-receiver-package",level:3},{value:"AWS S3 Workflow Package",id:"aws-s3-workflow-package",level:3},{value:"AWS SES (Simple Email Service)",id:"aws-ses-simple-email-service",level:3}];function l(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.p,{children:"With the release of DBOS Transact TypeScript version 3 (DBOS TSv3), some APIs that were marked as deprecated in v2 have been removed.\nAdditionally, there are APIs that have been deprecated in v3 that will be removed in a future version of DBOS TS.\nThis document explains how to update your existing DBOS TS app to recommended v3 APIs."}),"\n",(0,t.jsxs)(s.h2,{id:"clean-up-dbos-configyaml",children:["Clean Up ",(0,t.jsx)(s.code,{children:"dbos-config.yaml"})]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"dbos-config.yaml"})," is no longer required and no longer supports the ",(0,t.jsx)(s.code,{children:"application:"}),", ",(0,t.jsx)(s.code,{children:"env:"}),", and some other sections.  Application configuration should use other approaches, such as direct use of environment variables that are set using tools such as ",(0,t.jsx)(s.code,{children:"dotenv"})," or DBOS Cloud ",(0,t.jsx)(s.a,{href:"/production/dbos-cloud/secrets",children:"secrets"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"dbos-config.yaml"}),", if in use, should only be used to provide the information needed by DBOS Cloud, the debugger, and other tools that start your app.  If ",(0,t.jsx)(s.code,{children:"dbos-config.yaml"})," is not used, be sure to set important configuration information in a call to ",(0,t.jsx)(s.a,{href:"/typescript/reference/dbos-class#dbossetconfig",children:(0,t.jsx)(s.code,{children:"DBOS.setConfig"})}),", prior to ",(0,t.jsx)(s.a,{href:"/typescript/reference/dbos-class#dboslaunch",children:(0,t.jsx)(s.code,{children:"DBOS.launch"})}),"."]}),"\n",(0,t.jsxs)(s.h3,{id:"use-start-commands-and-dboslaunch",children:["Use Start Commands And ",(0,t.jsx)(s.code,{children:"DBOS.launch"})]}),"\n",(0,t.jsxs)(s.p,{children:['Previous versions of DBOS TS offered a "runtime", which loaded specified code files and then started a runtime for you.  This "entrypoints"-based runtime configuration is no longer available.  If your ',(0,t.jsx)(s.code,{children:"dbos-config.yaml"})," does not have a ",(0,t.jsx)(s.code,{children:"start:"})," or currently uses ",(0,t.jsx)(s.code,{children:"entrypoints:"})," or ",(0,t.jsx)(s.code,{children:"port:"}),", it should be changed to use ",(0,t.jsx)(s.code,{children:"start:"}),"."]}),"\n",(0,t.jsx)(s.p,{children:"For example:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"runtimeConfig:\n  port: 8086\n"})}),"\n",(0,t.jsx)(s.p,{children:"Would become:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'runtimeConfig:\n  start:\n    - "node dist/main.js"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["It may be necessary to create a suitable main file containing setup and a call to ",(0,t.jsx)(s.code,{children:"DBOS.launch"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-typescript",children:'// Note that port is no longer set in the runtime,\n//   and should come from the environment and default to 3000\nconst PORT = parseInt(process.env.NODE_PORT ?? \'3000\');\n\nasync function main() {\n  DBOS.setConfig({\n    "name": "alert-center", // Setting app name is required\n  });\n\n  await DBOS.launch();\n  DBOS.logRegisteredEndpoints();\n\n  const app = new Koa();\n  const appRouter = new Router();\n  dkoa.registerWithApp(app, appRouter);\n\n  app.listen(PORT, () => {\n    console.log(`Server running at http://localhost:${PORT}`);\n  });\n}\n\nmain().then(()=>{}).catch(console.error);\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Similarly, within unit tests the ",(0,t.jsx)(s.code,{children:"TestingRuntime"})," approach is no longer available, and a combination of ",(0,t.jsx)(s.code,{children:"DBOS.setConfig"})," and ",(0,t.jsx)(s.code,{children:"DBOS.launch"})," should be used instead."]}),"\n",(0,t.jsx)(s.p,{children:"For additional information, see:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/configuration",children:"Configuration"})}),"\n",(0,t.jsxs)(s.li,{children:["Configuring for ",(0,t.jsx)(s.a,{href:"/production/dbos-cloud/deploying-to-cloud",children:"DBOS Cloud"})]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["For examples that use ",(0,t.jsx)(s.code,{children:"start"})," commands, see:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-transact-ts/tree/main/packages/create/templates",children:"Template Apps"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript",children:"Demo Apps"})}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"update-context-based-methods",children:"Update Context-based Methods"}),"\n",(0,t.jsxs)(s.p,{children:["In DBOS TS v1, DBOS application methods had an explicit context parameter.\nFor example, the ",(0,t.jsx)(s.code,{children:"paymentWorkflow"})," from the v1 Widget Store demo app was declared like this:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"@Workflow()\nstatic async paymentWorkflow(ctxt: WorkflowContext): Promise<void>\n"})}),"\n",(0,t.jsx)(s.p,{children:"Having an explicit context parameter made it impossible to invoke these DBOS application methods directly.\nDBOS TS v1 required an invocation helper method to call these methods."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"await ctxt.invoke(ShopUtilities).subtractInventory();\n"})}),"\n",(0,t.jsx)(s.p,{children:"In DBOS TS v2, a new set of decorators were introduced that did not use explicit context parameters.\nHere is the same declaration from the DBOS TS v2 Widget Store demo app:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"@DBOS.workflow()\nstatic async paymentWorkflow(): Promise<void>;\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Since they no longer have an explicit context parameter, v2 DBOS application methods can be invoked normally.\nFor example, the method call that previously needed the ",(0,t.jsx)(s.code,{children:"WorkflowContext.invoke"})," helper can now be called directly."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"await ShopUtilities.subtractInventory();\n"})}),"\n",(0,t.jsx)(s.p,{children:"To migrate a DBOS TS v1 app, you need to remove the explicit context parameters from your DBOS application methods\nand replace the original decorators with the new DBOS class static decorators.\nHere are some of the more common v1 decorators that have been removed and their v2 and v3 equivalents."}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"v1 Decorator (Removed)"}),(0,t.jsx)(s.th,{children:"v2 Decorator (Supported)"}),(0,t.jsx)(s.th,{children:"v3 (Recommended)"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@Workflow"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosworkflow",children:(0,t.jsx)(s.code,{children:"@DBOS.workflow"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosworkflow",children:(0,t.jsx)(s.code,{children:"@DBOS.workflow"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@Step"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosstep",children:(0,t.jsx)(s.code,{children:"@DBOS.step"})})}),(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosstep",children:(0,t.jsx)(s.code,{children:"@DBOS.step"})}),", ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:(0,t.jsx)(s.code,{children:"DBOS.runStep"})})]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@Communicator"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosstep",children:(0,t.jsx)(s.code,{children:"@DBOS.step"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosstep",children:(0,t.jsx)(s.code,{children:"@DBOS.step"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@Transaction"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@DBOS.transaction"})}),(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.a,{href:"#datasources",children:"Data Sources"})," (see section below)"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@GetApi"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@DBOS.getApi"})}),(0,t.jsxs)(s.td,{children:[(0,t.jsxs)(s.a,{href:"https://github.com/dbos-inc/dbos-transact-ts/tree/main/packages/koa-serve#serve-dbos-functions-over-http-with-koa",children:[(0,t.jsx)(s.code,{children:"koa-serve"})," external package "]})," (see HTTP section below)"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@PostApi"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"@DBOS.postApi"})}),(0,t.jsxs)(s.td,{children:[(0,t.jsxs)(s.a,{href:"https://github.com/dbos-inc/dbos-transact-ts/tree/main/packages/koa-serve#serve-dbos-functions-over-http-with-koa",children:[(0,t.jsx)(s.code,{children:"koa-serve"})," external package "]})," (see HTTP section below)"]})]})]})]}),"\n",(0,t.jsx)(s.admonition,{type:"tip",children:(0,t.jsxs)(s.p,{children:["In addition to the context-free DBOS v2 APIs, DBOS TS v3 also introduces decorator-free APIs such as\n",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosregisterworkflow",children:(0,t.jsx)(s.code,{children:"DBOS.registerWorkflow"})}),"\nand ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:(0,t.jsx)(s.code,{children:"DBOS.runStep"})}),".\nUse of the decoratorless API is not required, but supports a broad range of programming styles and allows DBOS to be used in JavaScript code."]})}),"\n",(0,t.jsx)(s.h2,{id:"accessing-context",children:"Accessing Context"}),"\n",(0,t.jsxs)(s.p,{children:["In v1, DBOS methods had a subclass of ",(0,t.jsx)(s.code,{children:"DBOSContext"})," (",(0,t.jsx)(s.code,{children:"StepContext"}),", ",(0,t.jsx)(s.code,{children:"TransactionContext"}),", ",(0,t.jsx)(s.code,{children:"WorkflowContext"}),", etc.) as their first parameter.  Capabilities that were originally accessed via these context parameters are now accessed via ",(0,t.jsx)(s.code,{children:"DBOS"})," class static functions and properties.\nFor example, methods like ",(0,t.jsx)(s.code,{children:"setEvent"})," and ",(0,t.jsx)(s.code,{children:"recv"})," were accessed via the explicit ",(0,t.jsx)(s.code,{children:"WorkflowContext"})," parameter in v1, but are now static methods on the ",(0,t.jsx)(s.code,{children:"DBOS"})," class.\nSee ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/workflow-tutorial#workflow-events",children:"WorkflowEvents"}),"\nand ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/workflow-tutorial#workflow-messaging-and-notifications",children:"Workflow Messaging"})," for more information."]}),"\n",(0,t.jsx)(s.p,{children:"In DBOS TS v2, the explicit context parameter types and the decorators associated with DBOS application methods that\nused them were marked as deprecated. In DBOS TS v3, those types and decorators have been removed."}),"\n",(0,t.jsx)(s.p,{children:"Here are some of the common v1 context methods and properties that have been removed and their v2 replacement."}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"v1 Context API"}),(0,t.jsx)(s.th,{children:"v2/v3 API"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"DBOSContext.workflowUUID"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbosworkflowid",children:(0,t.jsx)(s.code,{children:"DBOS.workflowID"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"DBOSContext.logger"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dboslogger",children:(0,t.jsx)(s.code,{children:"DBOS.logger"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"WorkflowContext.invoke"})," / ",(0,t.jsx)(s.code,{children:"HandlerContext.invoke"})]}),(0,t.jsx)(s.td,{children:"call method directly"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"WorkflowContext.startWorkflow"})," / ",(0,t.jsx)(s.code,{children:"HandlerContext.startWorkflow"})]}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbosstartworkflow",children:(0,t.jsx)(s.code,{children:"DBOS.startWorkflow"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"WorkflowContext.send"})," / ",(0,t.jsx)(s.code,{children:"HandlerContext.send"})]}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbossend",children:(0,t.jsx)(s.code,{children:"DBOS.send"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"WorkflowContext.recv"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbosrecv",children:(0,t.jsx)(s.code,{children:"DBOS.recv"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"WorkflowContext.getEvent"})," / ",(0,t.jsx)(s.code,{children:"HandlerContext.getEvent"})]}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbosgetevent",children:(0,t.jsx)(s.code,{children:"DBOS.getEvent"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"WorkflowContext.setEvent"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbossetevent",children:(0,t.jsx)(s.code,{children:"DBOS.setEvent"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"WorkflowContext.sleepms"})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"./reference/methods#dbossleep",children:(0,t.jsx)(s.code,{children:"DBOS.sleep"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.code,{children:"TransactionContext.client"})}),(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.code,{children:"DBOS.sqlClient"})," (Deprecated. see ",(0,t.jsx)(s.a,{href:"#datasources",children:"Data Sources"})," section below)"]})]})]})]}),"\n",(0,t.jsx)(s.h2,{id:"datasources",children:"Datasources"}),"\n",(0,t.jsxs)(s.p,{children:["DBOS TS v1 and v2 provide built-in support for a single Postgres database for application data, and offer a choice of built-in access libraries.  This database can be used as the application sees fit.  For example, the ",(0,t.jsx)(s.a,{href:"/typescript/examples/checkout-tutorial",children:"Fault-tolerant Checkout example application"})," stores both products and orders in this application database, and accesses it with Knex.\nDBOS transactions, decorated with ",(0,t.jsx)(s.code,{children:"@Transaction"})," (v1) or ",(0,t.jsx)(s.code,{children:"@DBOS.transaction"})," (v2), are steps that update the application database and durably record execution history."]}),"\n",(0,t.jsxs)(s.p,{children:["While DBOS TS v3 continues to support a single v2-style application database, it introduces support ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/transaction-tutorial",children:"Datasource"})," extension packages.  Datasources have two primary benefits over the built-in app database support."]}),"\n",(0,t.jsx)(s.p,{children:"First, while the core DBOS package only supports a single application database, DBOS TS v3 support multiple datasources.  Each datasource is independent, so you could not only connect to different application databases, each could use one or more clients that would be appropriate for that database."}),"\n",(0,t.jsxs)(s.p,{children:["Second, since they are external to core DBOS library, datasources can support additional database drivers, query builders, and object-relational mappers without a release of the main library.  The core DBOS package only supports five different clients: ",(0,t.jsx)(s.a,{href:"https://node-postgres.com/",children:"node-postgres"}),", ",(0,t.jsx)(s.a,{href:"https://knexjs.org/",children:"Knex.js"}),",\n",(0,t.jsx)(s.a,{href:"https://orm.drizzle.team/",children:"Drizzle"}),", ",(0,t.jsx)(s.a,{href:"https://www.prisma.io/",children:"Prisma"})," and ",(0,t.jsx)(s.a,{href:"https://typeorm.io/",children:"TypeORM"}),", and adding support for some other package like ",(0,t.jsx)(s.a,{href:"https://github.com/porsager/postgres",children:"Postgres.js"})," was not feasible.  However, adding an ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-transact-ts/tree/main/packages/postgres-datasource",children:"external Postgres.js datasource"})," was straightforward, and since it's an external package, it could even be implemented by an independent person or organization without involvement from DBOS, Inc."]}),"\n",(0,t.jsxs)(s.p,{children:["Upgrading to datasources is generally as simple as configuring and constructing a datasource object, and then switching the ",(0,t.jsx)(s.code,{children:"@DBOS.transaction"})," decorators to use that object instead, and using the ",(0,t.jsx)(s.code,{children:".client"})," property of the datasource object instead of ",(0,t.jsx)(s.code,{children:"DBOS.sqlClient"})," et al."]}),"\n",(0,t.jsx)(s.p,{children:"For example:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.transaction()\n  static async cleanAlerts() {\n    await DBOS.knexClient<AlertEmployee>('alert_employee').where({alert_status: AlertStatus.RESOLVED}).delete();\n  }\n"})}),"\n",(0,t.jsx)(s.p,{children:"Becomes:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-typescript",children:"  @knexds.transaction()\n  static async cleanAlerts() {\n    await knexds.client<AlertEmployee>('alert_employee').where({alert_status: AlertStatus.RESOLVED}).delete();\n  }\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Datasources also require ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/transaction-tutorial#installing-the-dbos-schema",children:"installation of a transaction checkpoint table"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["For more information on datasources, please see the ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/transaction-tutorial",children:"tutorial"})," and\n",(0,t.jsx)(s.a,{href:"/typescript/reference/datasource",children:"reference documentation"}),"."]}),"\n",(0,t.jsx)(s.h2,{id:"http-package",children:"HTTP Package"}),"\n",(0,t.jsxs)(s.p,{children:["DBOS TS v3 is a library that is intended to support usage by any JavaScript application desiring lightweight durable execution.  However, previous versions of DBOS TS included a simple, decorator-based (",(0,t.jsx)(s.code,{children:"@DBOS.getApi"}),", ",(0,t.jsx)(s.code,{children:"@DBOS.postApi"}),", etc.) framework for registering HTTP endpoints and middleware.  While DBOS TS v3 still includes this ",(0,t.jsx)(s.a,{href:"https://koajs.com/",children:"Koa"}),"-based HTTP server, its use is entirely optional and it is not launched by default.  Going forward, these HTTP capabilities are moving to an external package, ",(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/koa-serve/v/3.0.56-preview",children:(0,t.jsx)(s.code,{children:"@dbos-inc/koa-serve"})}),", which is available for use in v3.\nA future version of DBOS TS (likely v4) will remove the built-in capabilities in favor of this external package.\nIf you are using the included HTTP server, you are encouraged, but not required, to move to the external package."]}),"\n",(0,t.jsx)(s.p,{children:"First, install the new external package:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"npm install @dbos-inc/koa-serve\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Then, in your code, create a ",(0,t.jsx)(s.code,{children:"DBOSKoa"})," instance.\nReplace all DBOS HTTP decorators (such as @DBOS.getApi) with decorators from the ",(0,t.jsx)(s.code,{children:"DBOSKoa"})," instance.\nAnyplace you were accessing the Koa web context via ",(0,t.jsx)(s.code,{children:"DBOS.koaContext"})," must change to using ",(0,t.jsx)(s.code,{children:"DBOSKoa.koaContext"}),"."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"const dhttp = new DBOSKoa();\n\nexport class HTTPEndpoints {\n  @dhttp.getApi('/')\n  static async homepage() {\n    const { userid } = DBOSKoa.koaContext.request.query;\n    // use query string user id param in response\n  }\n}\n"})}),"\n",(0,t.jsxs)(s.p,{children:["For further information about the ",(0,t.jsx)(s.code,{children:"koa-serve"})," package, please see the ",(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/koa-serve/v/3.0.56-preview",children:"package's documentation"}),"."]}),"\n",(0,t.jsx)(s.h2,{id:"remove-deprecated-step-packages",children:"Remove Deprecated Step Packages"}),"\n",(0,t.jsx)(s.p,{children:"DBOS TS v2 offered several additional step packages for common scenarios like bcrypt hashing, random number generation,\nand retrieving the current time.  These have all been deprecated in v3 as the functionality has much simpler equivalents."}),"\n",(0,t.jsx)(s.h3,{id:"dbos-incdbos-datetime-package",children:"@dbos-inc/dbos-datetime Package"}),"\n",(0,t.jsxs)(s.p,{children:["DBOS TS v3 introduces ",(0,t.jsx)(s.code,{children:"DBOS.now()"})," method, which is just a checkpointed version of ",(0,t.jsx)(s.code,{children:"Date.now()"}),".\nOnce you have the checkpointed timestamp, you can deterministically create a date object from that value."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"// DBOS.now() is checkpointed, so will always return the same timestamp\nconst now = DBOS.now();\n// creating a date object from a timestamp is deterministic, \n// so it does not need to be checkpointed\nconst dateObj = new Date(now)\n"})}),"\n",(0,t.jsx)(s.h3,{id:"dbos-incdbos-random-package",children:"@dbos-inc/dbos-random Package"}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"dbos-random"})," package provided a checkpointed version of ",(0,t.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random",children:(0,t.jsx)(s.code,{children:"Math.random"})}),".\nYou can build your own checkpointed random number generator with ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:(0,t.jsx)(s.code,{children:"DBOS.runStep"})}),"."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:'// Generate a checkpointed random value inside of a workflow function\nconst value = await DBOS.runStep(() => Promise.resolve(Math.random()), { name: "random" });\n'})}),"\n",(0,t.jsxs)(s.p,{children:["If you want to use the random function multiple times, you can use ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosregisterstep",children:(0,t.jsx)(s.code,{children:"DBOS.registerStep"})}),"\nto create a checkpointed step function."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:'// create a checkpointed random number generator function\nconst random = DBOS.registerStep(() => Promise.resolve(Math.random()), { name: "math.random" });\n'})}),"\n",(0,t.jsx)(s.h3,{id:"dbos-incdbos-bcrypt-package",children:"@dbos-inc/dbos-bcrypt Package"}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"dbos-bcrypt"})," package provided checkpointed versions of the ",(0,t.jsx)(s.code,{children:"genSalt"})," and ",(0,t.jsx)(s.code,{children:"hash"})," functions from\nthe ",(0,t.jsxs)(s.a,{href:"https://github.com/dcodeIO/bcrypt.js",children:[(0,t.jsx)(s.code,{children:"bcrypt.js"})," package"]}),".\nAs detailed above for dbos-random, you can build your own checkpointed bcrypt methods with\n",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:(0,t.jsx)(s.code,{children:"DBOS.runStep"})})," or ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosregisterstep",children:(0,t.jsx)(s.code,{children:"DBOS.registerStep"})}),"."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:'// generate checkpointed salt value inside of a workflow function\nconst salt = await DBOS.runStep(async (saltRounds: number = 10) => await bcryptjs.genSalt(saltRounds), { name: "bcrypt.genSalt" });\n\n// generate a checkpointed bcrypt.hash function\nconst hashFunc = DBOS.registerStep((txt: string, saltRounds: number = 10) => bcryptjs.hash(txt, saltRounds), { name: "bcrypt.hash" });\n'})}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"bcrypt.compare"})," is deterministic, so it can be called directly in a workflow or step function\nwithout needing to wrap it with ",(0,t.jsx)(s.code,{children:"DBOS.runStep"})," or ",(0,t.jsx)(s.code,{children:"DBOS.registerStep"})," ."]})}),"\n",(0,t.jsx)(s.h2,{id:"other-packages",children:"Other Packages"}),"\n",(0,t.jsx)(s.p,{children:"For DBOS v3, several other external packages were completely rewritten, generally simplifying their configuration and improving ease of use.  The general guidance for upgrading to v3 is:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Configure and create objects using the underlying library (KafkaJS, AWS SQS, AWS SES, etc.)"}),"\n",(0,t.jsxs)(s.li,{children:["For sending requests (Kafka messages, SQS requests, S3 commands, emails, etc.) use ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:(0,t.jsx)(s.code,{children:"runStep"})})," or register a step wrapper."]}),"\n",(0,t.jsx)(s.li,{children:"For running DBOS workflows in response to inbound events or messages, use the new v3 package."}),"\n"]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"v1/v2 Package (Discontinued)"}),(0,t.jsx)(s.th,{children:"v3 (Recommended)"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/dbos-kafkajs",children:(0,t.jsx)(s.code,{children:"@dbos-inc/dbos-kafkjs"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/kafkajs-receive",children:(0,t.jsx)(s.code,{children:"@dbos-inc/kafkajs-receive"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/dbos-confluent-kafka",children:(0,t.jsx)(s.code,{children:"@dbos-inc/dbos-confluent-kafka"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/confluent-kafka-receive",children:(0,t.jsx)(s.code,{children:"@dbos-inc/confluent-kafka-receive"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/dbos-sqs",children:(0,t.jsx)(s.code,{children:"@dbos-inc/dbos-sqs"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/sqs-receive",children:(0,t.jsx)(s.code,{children:"@dbos-inc/sqs-receive"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/component-aws-s3",children:(0,t.jsx)(s.code,{children:"@dbos-inc/component-aws-s3"})})}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/aws-s3-workflows",children:(0,t.jsx)(s.code,{children:"@dbos-inc/aws-s3-workflows"})})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/dbos-email-ses",children:(0,t.jsx)(s.code,{children:"@dbos-inc/dbos-email-ses"})})}),(0,t.jsx)(s.td,{children:"unnecessary"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:"The documentation for these packages currently resides in their package README files."}),"\n",(0,t.jsx)(s.h3,{id:"kafka-consumer-packages",children:"Kafka Consumer Packages"}),"\n",(0,t.jsx)(s.p,{children:"The packages for working with Kafka were replaced with simpler ones.  While the previous packages provided step wrappers for Kafka producers, you should now just produce messages in your own steps."}),"\n",(0,t.jsx)(s.p,{children:"DBOS does provide two packages for connecting workflows to Kafka consumers:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/kafkajs-receive",children:(0,t.jsx)(s.code,{children:"@dbos-inc/kafkajs-receive"})})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.npmjs.com/package/@dbos-inc/confluent-kafka-receive",children:(0,t.jsx)(s.code,{children:"@dbos-inc/confluent-kafka-receive"})})}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["Except for the underlying Kafka client library, these packages are similar, and use a ",(0,t.jsx)(s.code,{children:"consume"})," decorator to connect ",(0,t.jsx)(s.code,{children:"DBOS.workflow"})," methods to message topics:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.workflow()\n  @kafkaReceiver.consumer(respondTopic)\n  static async inboundAlertWorkflow(_topic: string, _partition: number, message: KafkaMessage) { ... }\n"})}),"\n",(0,t.jsxs)(s.p,{children:["For a detailed example of using DBOS and Kafka together to publish and consume messages, see ",(0,t.jsx)(s.a,{href:"/typescript/examples/kafka-alert-queue",children:"Kafka Alert Queue"}),"."]}),"\n",(0,t.jsx)(s.h3,{id:"aws-sqs-receiver-package",children:"AWS SQS Receiver Package"}),"\n",(0,t.jsx)(s.p,{children:"Similar to the Kafka package changes, the SQS package was changed to include only a message receiver.  This is simpler to work with, as it allows much more flexibility in configuration of the SQS client.  After a client is constructed, SQS message receivers can be added to workflows using decorators:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-typescript",children:"// Create a receiver (can configure now, or later...)\nconst sqsReceiver = new SQSReceiver();\n\n// Optionally, configure the receiver at the class level\n@sqsReceiver.configure({client: .../*SQS client or function to retrieve client goes here*/})\nclass SQSEventProcessor {\n  @sqsReceiver.messageConsumer({ queueUrl: process.env['SQS_QUEUE_URL'] })\n  @DBOS.workflow()\n  static async recvMessage(msg: Message) {\n    // Workflow code goes here...\n  }\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"aws-s3-workflow-package",children:"AWS S3 Workflow Package"}),"\n",(0,t.jsx)(s.p,{children:"The package for working with AWS S3 was replaced with a much simpler one.  While the previous package attempted to configure and instantiate the S3 client and provided step wrappers for some S3 commands, the new package only provides the workflows for keeping the contents of an S3 bucket in sync with a list kept in a database table.  This allows much more flexibility in configuring S3, while demonstrating how DBOS workflows can be used to synchronize multiple external systems."}),"\n",(0,t.jsx)(s.h3,{id:"aws-ses-simple-email-service",children:"AWS SES (Simple Email Service)"}),"\n",(0,t.jsxs)(s.p,{children:["With the simplified v3 ",(0,t.jsx)(s.a,{href:"/typescript/reference/workflows-steps#dbosrunstep",children:"step"})," syntax and requirements, it was no longer deemed helpful to provide a step library for interacting with AWS SES.  Configuring SES and sending mail is much more flexible when done directly with the library, as demonstrated in the ",(0,t.jsx)(s.a,{href:"/typescript/examples/task-scheduler#sending-email-with-amazon-ses",children:"example code"}),"."]})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>i});var r=n(6540);const t={},o=r.createContext(t);function a(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);