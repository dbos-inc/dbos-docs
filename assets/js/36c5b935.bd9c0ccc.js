"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[6287],{688:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>h});var o=n(4848),r=n(8453);const s={sidebar_position:1,title:"Learn DBOS Python",pagination_next:"python/tutorials/workflow-tutorial",pagination_prev:"quickstart"},i=void 0,a={id:"python/programming-guide",title:"Learn DBOS Python",description:"This tutorial shows you how to build a simple Python app with DBOS.",source:"@site/docs/python/programming-guide.md",sourceDirName:"python",slug:"/python/programming-guide",permalink:"/python/programming-guide",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Learn DBOS Python",pagination_next:"python/tutorials/workflow-tutorial",pagination_prev:"quickstart"},sidebar:"tutorialSidebar",previous:{title:"Get Started with DBOS",permalink:"/quickstart"},next:{title:"Workflows",permalink:"/python/tutorials/workflow-tutorial"}},l={},h=[{value:"1. Starting Out",id:"1-starting-out",level:2},{value:"2. Adding Some Steps",id:"2-adding-some-steps",level:2},{value:"3. Durable Execution with Workflows",id:"3-durable-execution-with-workflows",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{BrowserWindow:n,TabItem:s,Tabs:i}=t;return n||c("BrowserWindow",!0),s||c("TabItem",!0),i||c("Tabs",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["This tutorial shows you how to build a simple Python app with DBOS.\nIt highlights how DBOS ",(0,o.jsx)(t.strong,{children:"durable execution"})," makes your apps resilient to any temporary failure.\nWe'll build an app that records greetings to two different systems: Postgres and an online guestbook.\nThanks to DBOS durable execution, the app always writes to both systems consistently, even if it is interrupted or restarted at any point."]}),"\n",(0,o.jsxs)(t.p,{children:["This guide assumes you have a Postgres database running locally.\nIf not, see the ",(0,o.jsx)(t.a,{href:"/quickstart",children:"quickstart"})," for instructions on how to set it up."]}),"\n",(0,o.jsx)(t.h2,{id:"1-starting-out",children:"1. Starting Out"}),"\n",(0,o.jsx)(t.p,{children:"Create a folder for your app with a virtual environment, then enter the folder and activate the virtual environment."}),"\n",(0,o.jsxs)(i,{groupId:"operating-systems",children:[(0,o.jsx)(s,{value:"maclinux",label:"macOS or Linux",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\nsource .venv/bin/activate\n"})})}),(0,o.jsx)(s,{value:"win-ps",label:"Windows (PowerShell)",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\n.venv\\Scripts\\activate.ps1\n"})})}),(0,o.jsx)(s,{value:"win-cmd",label:"Windows (cmd)",children:(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\n.venv\\Scripts\\activate.bat\n"})})})]}),"\n",(0,o.jsx)(t.p,{children:"Then, install and initialize DBOS:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"pip install dbos\ndbos init\ndbos migrate\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Next, use ",(0,o.jsx)(t.a,{href:"https://github.com/fastapi/fastapi",children:"FastAPI"})," to write a simple HTTP endpoint to greet friends.\nIn your app folder, change the file ",(0,o.jsx)(t.code,{children:"greeting_guestbook/main.py"})," to contain only the following:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'from dbos import DBOS\nfrom fastapi import FastAPI\nfrom fastapi.responses import HTMLResponse\n\napp = FastAPI()\nDBOS(fastapi=app)\n\n@app.get("/greeting/{name}")\ndef greeting_endpoint(name: str) -> str:\n    return f"Thank you for being awesome, {name}!"\n'})}),"\n",(0,o.jsxs)(t.p,{children:["Start your app with ",(0,o.jsx)(t.code,{children:"dbos start"}),".\nTo see that it's is working, visit this URL: ",(0,o.jsx)(t.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"})]}),"\n",(0,o.jsx)(n,{url:"http://localhost:8000/greeting/Mike",children:(0,o.jsx)(t.p,{children:'"Thank you for being awesome, Mike!"'})}),"\n",(0,o.jsx)(t.h2,{id:"2-adding-some-steps",children:"2. Adding Some Steps"}),"\n",(0,o.jsx)(t.p,{children:"Now, let's update the app so that every time it receives a greeting, it performs two steps:"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsx)(t.li,{children:"Sign an online guestbook with the greeting."}),"\n",(0,o.jsx)(t.li,{children:"Record the greeting in the database."}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["Copy the following code into your ",(0,o.jsx)(t.code,{children:"greeting_guestbook/main.py"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'import logging\n\nimport requests\nfrom dbos import DBOS\nfrom fastapi import FastAPI\n\nfrom .schema import dbos_hello\n\napp = FastAPI()\nDBOS(fastapi=app)\n\nlogging.basicConfig(level=logging.INFO)\n\n@DBOS.step()\ndef sign_guestbook(name: str):\n    requests.post(\n        "https://demo-guestbook.cloud.dbos.dev/record_greeting",\n        headers={"Content-Type": "application/json"},\n        json={"name": name},\n    )\n    logging.info(f">>> STEP 1: Signed the guestbook for {name}")\n\n@DBOS.transaction()\ndef insert_greeting(name: str) -> str:\n    query = dbos_hello.insert().values(name=name)\n    DBOS.sql_session.execute(query)\n    logging.info(f">>> STEP 2: Greeting to {name} recorded in the database!")\n\n@app.get("/greeting/{name}")\ndef greeting_endpoint(name: str):\n    sign_guestbook(name)\n    insert_greeting(name)\n    return f"Thank you for being awesome, {name}!"\n'})}),"\n",(0,o.jsx)(t.p,{children:"We add two new functions."}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"sign_guestbook"})," \u2014 Signs the online guestbook with an HTTP POST request"]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.code,{children:"insert_greeting"})," \u2014 Uses ",(0,o.jsx)(t.a,{href:"https://docs.sqlalchemy.org/en/20/core/",children:"SQLAlchemy"})," to record the greeting in the database."]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["Both are ordinary Python functions, but we ",(0,o.jsx)(t.strong,{children:"annotate"})," them so we can durably execute them later:"]}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.a,{href:"/python/tutorials/step-tutorial",children:(0,o.jsx)(t.code,{children:"DBOS.step"})})," is an annotation we can apply to ",(0,o.jsx)(t.strong,{children:"any function"})," to use it as a step in a durable workflow."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.a,{href:"/python/tutorials/transaction-tutorial",children:(0,o.jsx)(t.code,{children:"DBOS.transaction"})})," is a special type of step optimized for performing database operations. It provides a pre-configured ",(0,o.jsx)(t.code,{children:"DBOS.sql_session"})," SQLAlchemy client."]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["To see your app working, restart it with ",(0,o.jsx)(t.code,{children:"dbos start"}),". Then, visit this URL: ",(0,o.jsx)(t.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"}),". When you visit, your app should log first that it has recorded your greeting in the guestbook, then that it has recorded your greeting in the database."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"INFO:root:>>> STEP 1: Signed the guestbook for Mike\nINFO:root:>>> STEP 2: Greeting to Mike recorded in the database!\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Now, this app has a problem: if it is interrupted after signing the guestbook, but before recording the greeting in the database, then ",(0,o.jsx)(t.strong,{children:"the greeting, though sent, will never be recorded"}),".\nThis is bad in many real-world situtations, for example if a program fails to record making or receiving a payment.\nTo fix this problem, we'll use DBOS durable execution."]}),"\n",(0,o.jsx)(t.h2,{id:"3-durable-execution-with-workflows",children:"3. Durable Execution with Workflows"}),"\n",(0,o.jsxs)(t.p,{children:["Next, we want to ",(0,o.jsx)(t.strong,{children:"durably execute"})," our application: guarantee that it inserts exactly one database record per guestbook signature, even if interrupted or restarted.\nDBOS makes this easy with ",(0,o.jsx)(t.a,{href:"/python/tutorials/workflow-tutorial",children:"workflows"}),".\nReplace your ",(0,o.jsx)(t.code,{children:"greeting_endpoint"})," with the following:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'@app.get("/greeting/{name}")\n# highlight-next-line\n@DBOS.workflow()\ndef greeting_endpoint(name: str):\n    sign_guestbook(name)\n    for _ in range(5):\n        logging.info("Press Control + C to stop the app...")\n        DBOS.sleep(1)\n    insert_greeting(name)\n    return f"Thank you for being awesome, {name}!"\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The key change we make is adding the ",(0,o.jsx)(t.a,{href:"/python/tutorials/workflow-tutorial",children:(0,o.jsx)(t.code,{children:"@DBOS.workflow"})})," annotation.\nSince we've already annotated ",(0,o.jsx)(t.code,{children:"sign_guestbook"})," and ",(0,o.jsx)(t.code,{children:"insert_greeting"})," as steps, ",(0,o.jsx)(t.strong,{children:"this single line transforms your FastAPI endpoint into a durably executed workflow!"}),"\nFor demonstration purposes, we also introduce a sleep so you can interrupt your app midway through the workflow."]}),"\n",(0,o.jsxs)(t.p,{children:["To see the power of durable execution, restart your app with ",(0,o.jsx)(t.code,{children:"dbos start"}),".\nThen, visit this URL: ",(0,o.jsx)(t.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"}),".\nIn your terminal, you should see an output like:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)\nINFO:root:>>> STEP 1: Signed the guestbook for Mike\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Now, press CTRL+C stop your app. Then, run ",(0,o.jsx)(t.code,{children:"dbos start"})," to restart it. You should see an output like:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:"INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:>>> STEP 2: Greeting to Mike recorded in the database!\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Without durable execution\u2014if you remove ",(0,o.jsx)(t.code,{children:"DBOS.workflow()"}),'\u2014your app restarts with a "clean slate" and completely forgets about your interrupted workflow.\nBy contrast, DBOS ',(0,o.jsx)(t.strong,{children:"automatically resumes your workflow from where it left off"})," and correctly completes it by recording the greeting to the database without re-signing the guestbook.\nThis is an incredibly powerful guarantee that helps you build complex, reliable applications without worrying about error handling or interruptions."]}),"\n",(0,o.jsxs)(t.p,{children:["The code for this guide is available ",(0,o.jsx)(t.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/greeting-guestbook",children:"on GitHub"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Next, to learn how to build more complex applications, check out our Python tutorials and ",(0,o.jsx)(t.a,{href:"/examples/",children:"example apps"}),"."]})]})}function p(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}function c(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var o=n(6540);const r={},s=o.createContext(r);function i(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);