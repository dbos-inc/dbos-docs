"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[5962],{7453:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"python/examples/queue-worker","title":"Queue Worker","description":"This example is also available in TypeScript.","source":"@site/docs/python/examples/queue-worker.md","sourceDirName":"python/examples","slug":"/python/examples/queue-worker","permalink":"/python/examples/queue-worker","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":35,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":35,"title":"Queue Worker"},"sidebar":"examplesSidebar","previous":{"title":"Fault-Tolerant Checkout","permalink":"/python/examples/widget-store"},"next":{"title":"Reliable Customer Service Agent","permalink":"/python/examples/customer-service"}}');var t=n(4848),o=n(8453);const i={displayed_sidebar:"examplesSidebar",sidebar_position:35,title:"Queue Worker"},l=void 0,a={},u=[{value:"Worker Service",id:"worker-service",level:2},{value:"Web Server",id:"web-server",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function c(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["This example is also available in ",(0,t.jsx)(s.a,{href:"/typescript/examples/queue-worker",children:"TypeScript"}),"."]})}),"\n",(0,t.jsx)(s.p,{children:'This example demonstrates how to run DBOS workflows in their own "queue worker" service while enqueueing and managing them from other services.\nThis design pattern lets you separate concerns and separately scale the workers that execute your durable workflows from your other services.'}),"\n",(0,t.jsxs)(s.p,{children:["Architecturally, this example contains two services: a web server and a worker service.\nThe web server uses the ",(0,t.jsx)(s.a,{href:"/python/reference/client",children:"DBOS Client"})," to enqueue workflows and monitor their status.\nThe worker service dequeues and executes workflows."]}),"\n",(0,t.jsxs)(s.p,{children:["All source code is ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/queue-worker",children:"available on GitHub"}),"."]}),"\n",(0,t.jsx)("img",{src:n(8789).A,alt:"DBOS Architecture",width:"750",className:"custom-img"}),"\n",(0,t.jsx)(s.h2,{id:"worker-service",children:"Worker Service"}),"\n",(0,t.jsxs)(s.p,{children:["The worker service implements your durable workflows and their steps.\nNotably, this workflow periodically reports its progress using ",(0,t.jsx)(s.a,{href:"/python/tutorials/workflow-communication",children:(0,t.jsx)(s.code,{children:"DBOS.set_event"})}),".\nThis lets the web server query the event to monitor workflow progress."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'@DBOS.workflow()\ndef workflow(num_steps: int):\n    progress = {\n        "steps_completed": 0,\n        "num_steps": num_steps,\n    }\n    # The server can query this event to obtain\n    # the current progress of the workflow\n    DBOS.set_event(WF_PROGRESS_KEY, progress)\n    for i in range(num_steps):\n        step(i)\n        # Update workflow progress each time a step completes\n        progress["steps_completed"] = i + 1\n        DBOS.set_event(WF_PROGRESS_KEY, progress)\n\n\n@DBOS.step()\ndef step(i: int):\n    print(f"Step {i} completed!")\n    time.sleep(1)\n'})}),"\n",(0,t.jsx)(s.p,{children:"The worker service also defines a queue on which the web server can submit workflows for execution:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'Queue("workflow-queue")\n'})}),"\n",(0,t.jsx)(s.p,{children:"In its main function, the worker service configures and launches DBOS with the registered workflows and queues then waits indefinitely, dequeuing and executing workflows:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'if __name__ == "__main__":\n    system_database_url = os.environ.get(\n        "DBOS_SYSTEM_DATABASE_URL", "sqlite:///dbos_queue_worker.sqlite"\n    )\n    config: DBOSConfig = {\n        "name": "dbos-queue-worker",\n        "system_database_url": system_database_url,\n    }\n    DBOS(config=config)\n    DBOS.launch()\n    # After launching DBOS, the worker waits indefinitely,\n    # dequeuing and executing workflows.\n    threading.Event().wait()\n'})}),"\n",(0,t.jsx)(s.h2,{id:"web-server",children:"Web Server"}),"\n",(0,t.jsx)(s.p,{children:"The web server first creates a DBOS Client:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'system_database_url = os.environ.get(\n    "DBOS_SYSTEM_DATABASE_URL", "sqlite:///dbos_queue_worker.sqlite"\n)\nclient = DBOSClient(system_database_url=system_database_url)\n'})}),"\n",(0,t.jsx)(s.p,{children:"It then enqueues workflows using the client:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'@api.post("/workflows")\ndef enqueue_workflow():\n    options: EnqueueOptions = {\n        "queue_name": "workflow-queue",\n        "workflow_name": "workflow",\n    }\n    num_steps = 10\n    client.enqueue(options, num_steps)\n    return {"status": "enqueued"}\n'})}),"\n",(0,t.jsxs)(s.p,{children:["The web server can also report workflow status.\nThis function first lists all workflows, then uses ",(0,t.jsx)(s.a,{href:"/python/tutorials/workflow-communication",children:(0,t.jsx)(s.code,{children:"get_event"})})," to query the progress of each workflow.\nThis is a useful pattern for showing workflow progress or status to end users of your application."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'@api.get("/workflows")\ndef list_workflows() -> List[WorkflowStatus]:\n    # Use the DBOS client to list all workflows\n    workflows = client.list_workflows(name="workflow", sort_desc=True)\n    statuses: List[WorkflowStatus] = []\n    for workflow in workflows:\n        # Query each workflow\'s progress event. This may not be available\n        # if the workflow has not yet started executing.\n        progress = client.get_event(\n            workflow.workflow_id, WF_PROGRESS_KEY, timeout_seconds=0\n        )\n        status = WorkflowStatus(\n            workflow_id=workflow.workflow_id,\n            workflow_status=workflow.status,\n            steps_completed=progress.get("steps_completed") if progress else None,\n            num_steps=progress.get("num_steps") if progress else None,\n        )\n        statuses.append(status)\n    return statuses\n'})}),"\n",(0,t.jsx)(s.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,t.jsxs)(s.p,{children:["Clone and enter the ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd python/queue-worker\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Then follow the instructions in the ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/queue-worker",children:"README"})," to run the app."]})]})}function p(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8789:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/queue-worker-d55ea32938eec5d1f181b9e62dfa3429.png"},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>l});var r=n(6540);const t={},o=r.createContext(t);function i(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);