"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[1326],{6480:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"python/examples/queue-patterns","title":"Advanced Queue Patterns","description":"This example demonstrates how to build several advanced queue patterns with DBOS.","source":"@site/docs/python/examples/queue-patterns.md","sourceDirName":"python/examples","slug":"/python/examples/queue-patterns","permalink":"/python/examples/queue-patterns","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":36,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":36,"title":"Advanced Queue Patterns"},"sidebar":"examplesSidebar","previous":{"title":"Queue Worker","permalink":"/python/examples/queue-worker"},"next":{"title":"Reliable Customer Service Agent","permalink":"/python/examples/customer-service"}}');var i=t(4848),r=t(8453);const a={displayed_sidebar:"examplesSidebar",sidebar_position:36,title:"Advanced Queue Patterns"},s=void 0,u={},l=[{value:"Fair Queueing",id:"fair-queueing",level:2},{value:"Rate Limiting",id:"rate-limiting",level:2},{value:"Debouncing",id:"debouncing",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["This example demonstrates how to build several advanced queue patterns with DBOS.\nFor the full queues documentation, check out the ",(0,i.jsx)(n.a,{href:"/python/tutorials/queue-tutorial",children:"queues tutorial"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["All source code is ",(0,i.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/queue-patterns",children:"available on GitHub"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"fair-queueing",children:"Fair Queueing"}),"\n",(0,i.jsx)(n.p,{children:"Often, you have a queue with limited capacity and need to fairly divide that capacity among multiple tenants.\nFor example, suppose your application can only process 5 workflows at a time and you don't want a single tenant to monopolize all that capacity.\nWith fair queueing, you can limit each tenant to 1 workflow at a time while still allowing up to 5 workflows total across all tenants."}),"\n",(0,i.jsxs)(n.p,{children:["You can implement fair queueing in DBOS by combining a ",(0,i.jsx)(n.a,{href:"/python/tutorials/queue-tutorial#partitioning-queues",children:(0,i.jsx)(n.strong,{children:"partitioned queue"})})," with a ",(0,i.jsx)(n.strong,{children:"regular (non-partitioned) queue"}),".\nYou enforce per-tenant limits on the partitioned queue and global limits on the non-partitioned queue.\nTo do that, first let's define the two queues and a workflow:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'concurrency_queue = Queue("concurrency-queue", concurrency=5)\npartitioned_queue = Queue("partitioned-queue", partition_queue=True, concurrency=1)\n\n# This workflow is fairly queued: at most five workflows can run concurrently,\n# but no more than one per tenant.\n@DBOS.workflow()\ndef fair_queue_workflow():\n    time.sleep(5)\n'})}),"\n",(0,i.jsx)(n.p,{children:'Next, let\'s create an endpoint to enqueue the workflow.\nIt does not enqueue the workflow directly, but instead enqueues a "concurrency manager" workflow to the partitioned queue to enforce per-tenant limits:'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@api.post("/workflows/fair_queue")\ndef submit_fair_queue(tenant_id: str):\n    # Enqueue a "concurrency manager" workflow to the partitioned\n    # queue to enforce per-partition limits.\n    with SetEnqueueOptions(queue_partition_key=tenant_id):\n        partitioned_queue.enqueue(fair_queue_concurrency_manager)\n'})}),"\n",(0,i.jsx)(n.p,{children:'The "concurrency manager" bridges the two queues, enqueueing the workflow on the non-partitioned queue and waiting for it to complete:'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@DBOS.workflow()\ndef fair_queue_concurrency_manager():\n    # The "concurrency manager" workflow enqueues the\n    # workflow on the non-partitioned queue and\n    # awaits its results to enforce global flow control limits.\n    return concurrency_queue.enqueue(fair_queue_workflow).get_result()\n'})}),"\n",(0,i.jsx)(n.p,{children:"Because the \"concurrency manager\" has the same lifetime as the actual workflow, this pattern ensures both the partitioned queue's per-tenant limits and the non-partitioned queue's global concurrency limits are respected.\nYou can adapt this pattern to combine any per-tenant limits with any global limits."}),"\n",(0,i.jsx)(n.h2,{id:"rate-limiting",children:"Rate Limiting"}),"\n",(0,i.jsxs)(n.p,{children:["Sometimes, you need to ",(0,i.jsx)(n.strong,{children:"rate limit"})," a workflow, limiting the number of workflows that can start in a given period.\nThis is especially useful when using a rate-limited API, like many LLM APIs.\nYou can do this by applying a rate limit to a queue.\nFor example, here's a rate-limited queue and workflow:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'rate_limited_queue = Queue("rate-limited-queue", limiter={"limit": 2, "period": 10})\n\n# This workflow is rate-limited: No more than two workflows can start per 10 seconds\n@DBOS.workflow()\ndef rate_limited_queue_workflow():\n    time.sleep(5)\n'})}),"\n",(0,i.jsx)(n.p,{children:"If a rate-limit is defined with limit X and period Y, no more than X workflows can start per Y seconds.\nRate limits are global across all DBOS processes using a queue."}),"\n",(0,i.jsx)(n.p,{children:"You can enqueue a workflow on a rate-limited queue like with any other queue:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@api.post("/workflows/rate_limited_queue")\ndef submit_rate_limited_queue():\n    rate_limited_queue.enqueue(rate_limited_queue_workflow)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"debouncing",children:"Debouncing"}),"\n",(0,i.jsx)(n.p,{children:"Sometimes, you may receive many requests to start a workflow in quick succession, but you only want to start it once.\nFor example, if a user is editing an input field, you may want to start a processing workflow only after some time has passed since the last edit."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Debouncing"})," delays a workflow's execution until some time has passed since it was last called.\nTo debounce a workflow, we define the workflow and queue and create a debouncer for the workflow:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'debouncer_queue = Queue("debouncer-queue")\n\n@DBOS.workflow()\ndef debouncer_workflow(tenant_id: str, input: str):\n    print(f"Executing debounced workflow for tenant {tenant_id} with input {input}")\n    time.sleep(5)\n\ndebouncer = Debouncer.create(debouncer_workflow, queue=debouncer_queue)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then, we submit the workflow with the debouncer.\nThis delays the workflow until a set time has passed since the last input is submitted for a tenant.\nWhen the workflow starts, it uses the last input receieved by the debouncer."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Each time a new input is submitted for a tenant, debounce debouncer_workflow.\n# The debouncer waits until 5 seconds after input stops being submitted for the tenant,\n# then enqueues the workflow with the last input submitted.\n@api.post("/workflows/debouncer")\ndef submit_debounced_workflow(tenant_id: str, input: str):\n    debounce_key = tenant_id\n    debounce_period_sec = 5\n    debouncer.debounce(debounce_key, debounce_period_sec, tenant_id, input)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Learn more about debouncing in the ",(0,i.jsx)(n.a,{href:"/python/reference/contexts#debouncing",children:"reference"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,i.jsxs)(n.p,{children:["Clone and enter the ",(0,i.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd python/queue-patterns\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then follow the instructions in the ",(0,i.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/queue-patterns",children:"README"})," to run the example."]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var o=t(6540);const i={},r=o.createContext(i);function a(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);