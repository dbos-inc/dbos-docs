"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[5896],{304:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"integrations/adding-dbos-to-next","title":"Adding DBOS to Next.js Apps","description":"Learn how to integrate DBOS into Next.js applications.","source":"@site/docs/integrations/adding-dbos-to-next.md","sourceDirName":"integrations","slug":"/integrations/adding-dbos-to-next","permalink":"/integrations/adding-dbos-to-next","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":40,"frontMatter":{"sidebar_position":40,"title":"Adding DBOS to Next.js Apps","description":"Learn how to integrate DBOS into Next.js applications."},"sidebar":"tutorialSidebar","previous":{"title":"Nest.js","permalink":"/integrations/nestjs"},"next":{"title":"How Workflows Work","permalink":"/explanations/how-workflows-work"}}');var r=s(4848),t=s(8453);const o={sidebar_position:40,title:"Adding DBOS to Next.js Apps",description:"Learn how to integrate DBOS into Next.js applications."},a="Introduction",d={},l=[{value:"Why Add DBOS To a Next.js Application?",id:"why-add-dbos-to-a-nextjs-application",level:2},{value:"Architectural Overview",id:"architectural-overview",level:2},{value:"Integration Overview",id:"integration-overview",level:2},{value:"Coding <code>server.ts</code>",id:"coding-serverts",level:2},{value:"Adding DBOS Code To an Existing <code>server.ts</code>",id:"adding-dbos-code-to-an-existing-serverts",level:3},{value:"Adding <code>server.ts</code> To a Project",id:"adding-serverts-to-a-project",level:3},{value:"Compilation Settings For DBOS Code",id:"compilation-settings-for-dbos-code",level:3},{value:"<code>package.json</code> Scripts",id:"packagejson-scripts",level:3},{value:"DBOS Configuration",id:"dbos-configuration",level:3},{value:"Calling DBOS Code From Next.js",id:"calling-dbos-code-from-nextjs",level:2},{value:"Preventing Bundling",id:"preventing-bundling",level:2},{value:"Configuring <code>webpack</code> to Treat <code>import</code>s as External",id:"configuring-webpack-to-treat-imports-as-external",level:3},{value:"Using <code>globalThis</code>",id:"using-globalthis",level:3},{value:"Placing Items In <code>globalThis</code>",id:"placing-items-in-globalthis",level:4},{value:"Retrieving Items From <code>globalThis</code>",id:"retrieving-items-from-globalthis",level:4},{value:"Applying TypeScript Types To <code>globalThis</code>",id:"applying-typescript-types-to-globalthis",level:4},{value:"Running and Troubleshooting",id:"running-and-troubleshooting",level:2},{value:"Other <code>next.config.ts</code> Options",id:"other-nextconfigts-options",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"introduction",children:"Introduction"})}),"\n",(0,r.jsx)(n.h2,{id:"why-add-dbos-to-a-nextjs-application",children:"Why Add DBOS To a Next.js Application?"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://nextjs.org/",children:"Next.js"})," is a solid choice for high-performance interactive web frontends.  By adding DBOS Transact, and running in a suitable hosting environment (such as ",(0,r.jsx)(n.a,{href:"https://www.dbos.dev/dbos-cloud",children:"DBOS Cloud"}),'), your Next.js application can implement "heavy lifting" tasks with:']}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Lightweight durable execution \u2013 DBOS ",(0,r.jsx)(n.a,{href:"../typescript/tutorials/workflow-tutorial",children:"workflows"})," run to completion exactly once."]}),"\n",(0,r.jsxs)(n.li,{children:["Simple, powerful database integration \u2013 ",(0,r.jsx)(n.a,{href:"../typescript/tutorials/transaction-tutorial",children:"Manage database data"})," with DBOS."]}),"\n",(0,r.jsxs)(n.li,{children:["Cron-style task scheduling \u2013 Automate recurring jobs with ",(0,r.jsx)(n.a,{href:"../typescript/tutorials/scheduled-workflows",children:"cron-like scheduling"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Built-in tracing and replay debugging \u2013 ",(0,r.jsx)(n.a,{href:"../cloud-tutorials/monitoring-dashboard",children:"Find workflows in the dashboard"})," and ",(0,r.jsx)(n.a,{href:"../cloud-tutorials/interactive-timetravel",children:"re-run them locally"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"architectural-overview",children:"Architectural Overview"}),"\n",(0,r.jsxs)(n.p,{children:["Next.js is a framework that optimizes where and when ",(0,r.jsx)(n.a,{href:"https://react.dev/",children:"React"})," UI components render\u2014whether on the client, server, or edge\u2014while also handling routing, data fetching, and performance optimizations.  Part of this architecture involves the creation of minimized code bundles for handling requests.  These bundles can be loaded quickly in a \u201cserverless\u201d environment, leading to minimal request latency even when the server is \u201ccold\u201d.  This \u201cserverless\u201d style of deployment precludes any long-running jobs, background tasks that execute while no client requests are pending, or long-lived server objects such as WebSockets:\n",(0,r.jsx)(n.img,{alt:"Serverless Next.js architecture",src:s(7871).A+"",width:"2480",height:"1395"})]}),"\n",(0,r.jsxs)(n.p,{children:["However, Next.js also supports \u201ccustom server\u201d deployments, which do not have limitations on long-running tasks and long-lived state.  The custom server loads code when launched, and the optimized request handler bundles can then interact with this server-side code:\n",(0,r.jsx)(n.img,{alt:"Serverlful Next.js architecture",src:s(3589).A+"",width:"2490",height:"1383"})]}),"\n",(0,r.jsxs)(n.p,{children:["The latter architecture is a requirement for using Next.js with DBOS.  This guide covers switching to a deployment with a custom ",(0,r.jsx)(n.code,{children:"server.ts"})," file, and creating, calling, building, and deploying the logic within it."]}),"\n",(0,r.jsx)(n.h2,{id:"integration-overview",children:"Integration Overview"}),"\n",(0,r.jsx)(n.p,{children:"To add DBOS to a Next.JS application:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Use your package manager to install ",(0,r.jsx)(n.code,{children:"@dbos-inc/dbos-sdk"})," into your project."]}),"\n",(0,r.jsxs)(n.li,{children:["Add DBOS startup code to the custom server file, often named ",(0,r.jsx)(n.code,{children:"server.ts"})," or similar.  (If a custom server is not in use in your project, it will be necessary to add one.  This may also affect how Next.js is launched, and additional build steps may be required.)"]}),"\n",(0,r.jsxs)(n.li,{children:["Add files containing workflow logic implemented with DBOS. Ensure that the files are being compiled, and load the code from ",(0,r.jsx)(n.code,{children:"server.ts"})," at startup."]}),"\n",(0,r.jsx)(n.li,{children:"Add calls to the DBOS code from Next.js code.  This can include server-side page renders, server actions, and route handlers."}),"\n",(0,r.jsxs)(n.li,{children:["Ensure that your workflow functions and the DBOS library code do not get bundled into the bundles used by Next.js to handle the requests.  (Failure to do this will lead to a wide variety of error messages.)  This guide covers two techniques: configuring ",(0,r.jsx)(n.code,{children:"webpack"})," to treat the files and modules as external, or using ",(0,r.jsx)(n.code,{children:"globalThis"})," to get a reference to the shared objects and code set up in ",(0,r.jsx)(n.code,{children:"server.ts"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Run and troubleshoot the development environment and production build."}),"\n"]}),"\n",(0,r.jsx)(n.h1,{id:"adding-dbos-to-nextjs-applications",children:"Adding DBOS To Next.JS Applications"}),"\n",(0,r.jsxs)(n.h2,{id:"coding-serverts",children:["Coding ",(0,r.jsx)(n.code,{children:"server.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"server.ts"})," (note that, while any file name can be used, ",(0,r.jsx)(n.code,{children:"server.ts"})," is the common convention that is used in this guide) is responsible for initializing DBOS, and launching Next.js."]}),"\n",(0,r.jsxs)(n.h3,{id:"adding-dbos-code-to-an-existing-serverts",children:["Adding DBOS Code To an Existing ",(0,r.jsx)(n.code,{children:"server.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["If you already have a ",(0,r.jsx)(n.code,{children:"server.ts"})," or similar file, add the following code to it:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// ... Other library imports ...\n// highlight-next-line\nimport { DBOS } from '@dbos-inc/dbos-sdk'; // Import DBOS\n\n//\n// ... In subsequent steps, we will also import any app code that uses DBOS.\n//  This will provide the code and other objects needed for DBOS to recover any workflows...\n\nasync function main() { // Adjust if your entrypoint is not named 'main'\n  // ... Configure anything DBOS needs prior to launch ...\n\n  // Launch DBOS after initializing DBOS logic, and before starting 'next'\n  // highlight-next-line\n  await DBOS.launch();\n\n  // ... Then proceed to start the Next.js server ...\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"adding-serverts-to-a-project",children:["Adding ",(0,r.jsx)(n.code,{children:"server.ts"})," To a Project"]}),"\n",(0,r.jsxs)(n.p,{children:["If your project does not currently have a ",(0,r.jsx)(n.code,{children:"server.ts"})," file or similar, or if you are using the default ",(0,r.jsx)(n.code,{children:"server.js"})," provided by Next.js, the first step is to create one.   This file can be created in the top level of your project, inside ",(0,r.jsx)(n.code,{children:"src/"}),", or in any sensible place within your app structure."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import next from 'next';\nimport http, { IncomingMessage, ServerResponse } from 'http';\n\n// highlight-next-line\nimport { DBOS } from '@dbos-inc/dbos-sdk';\n// highlight-next-line\n// imports of DBOS workflows and other code will go here...\n\nconst dev = process.env.NODE_ENV !== 'production';\nconst app = next({ dev });\nconst handle = app.getRequestHandler();\n\nasync function main() {\n  DBOS.logger.info('Launching...');\n  // highlight-next-line\n  await DBOS.launch();\n  DBOS.logger.info('  ...launched.');\n\n  DBOS.logger.info(`Doing Next App Prepare...`);\n  await app.prepare();\n  DBOS.logger.info(`  ...prepared.`);\n\n  // Create HTTP server\n  const server = http.createServer((req, res) => {\n    handle(req, res as ServerResponse<IncomingMessage>);\n  });\n\n  const PORT = DBOS.runtimeConfig?.port ?? 3000;\n  const ENV = process.env.NODE_ENV || 'development';\n\n  server.listen(PORT, () => {\n    DBOS.logger.info(`\ud83d\ude80 Server is running on http://localhost:${PORT}`);\n    DBOS.logger.info(`\ud83c\udf1f Environment: ${ENV}`);\n  });\n}\n\n// Only start the server when this file is run directly from Node\nif (require.main === module) {\n  main().catch((error) => {\n    console.error('\u274c Server failed to start:', error);\n    DBOS.logger.error('\u274c Server failed to start:', error);\n    process.exit(1);  // Ensure the process exits on failure\n  });\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The DBOS demo apps contain example ",(0,r.jsx)(n.code,{children:"server.ts"})," files to copy:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/blob/main/typescript/dbos-nextjs-starter/src/server.ts",children:"DBOS Next.js Template"}),": This project uses a basic ",(0,r.jsx)(n.code,{children:"server.ts"})," file."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/blob/main/typescript/nextjs-calendar/src/server.ts",children:"DBOS Task Scheduler"}),": This project uses a more sophisticated ",(0,r.jsx)(n.code,{children:"server.ts"})," file with WebSocket support, etc."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"compilation-settings-for-dbos-code",children:"Compilation Settings For DBOS Code"}),"\n",(0,r.jsxs)(n.p,{children:["DBOS and ",(0,r.jsx)(n.code,{children:"server.ts"})," require some TypeScript compiler settings.  These can either be added to your existing ",(0,r.jsx)(n.code,{children:"tsconfig.json"}),", or if they are incompatible with the existing ",(0,r.jsx)(n.code,{children:"tsconfig.json"})," settings, a separate ",(0,r.jsx)(n.code,{children:"tsconfig.server.json"})," file can be created for use with the server builds."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "compilerOptions": {\n    "experimentalDecorators": true,\n    "emitDecoratorMetadata": true,\n    "noEmit": false,\n    "outDir": "./dist",\n  },\n  "exclude": [\n    "node_modules", \n    "dist"\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Noteworthy settings:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"experimentalDecorators"}),": Used by the DBOS decorator framework"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"emitDecoratorMetadata"}),": Used by the DBOS decorator framework"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"noEmit"}),", ",(0,r.jsx)(n.code,{children:"outDir"}),", and ",(0,r.jsx)(n.code,{children:"exclude"}),": Many Next.js projects do not emit the ",(0,r.jsx)(n.code,{children:".js"})," files corresponding to the ",(0,r.jsx)(n.code,{children:".ts"})," files; the bundles hold all the code.  With a custom ",(0,r.jsx)(n.code,{children:"server.ts"}),", ",(0,r.jsx)(n.code,{children:".js"})," files are needed for server code for execution by the ",(0,r.jsx)(n.code,{children:"node"})," runtime."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"packagejson-scripts",children:[(0,r.jsx)(n.code,{children:"package.json"})," Scripts"]}),"\n",(0,r.jsxs)(n.p,{children:["Scripts such as ",(0,r.jsx)(n.code,{children:"build"}),", ",(0,r.jsx)(n.code,{children:"dev"}),", and ",(0,r.jsx)(n.code,{children:"start"})," may require modification to work with ",(0,r.jsx)(n.code,{children:"server.ts"}),".  Commands such as ",(0,r.jsx)(n.code,{children:"next dev"})," and ",(0,r.jsx)(n.code,{children:"next start"})," will not load ",(0,r.jsx)(n.code,{children:"server.ts"}),"; Next.js should be started via the ",(0,r.jsx)(n.code,{children:"server.js"})," file produced by compiling your ",(0,r.jsx)(n.code,{children:"server.ts"})," file."]}),"\n",(0,r.jsxs)(n.p,{children:["The following shows very basic scripts for ",(0,r.jsx)(n.code,{children:"package.json"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'  "scripts": {\n    "dev": "npx dbos migrate && node dist/src/server.js",\n    "build": "tsc && next build",\n    "start": "NODE_ENV=production node dist/src/server.js",\n  },\n'})}),"\n",(0,r.jsxs)(n.p,{children:["These scripts can be more sophisticated, allowing for database migrations and ",(0,r.jsx)(n.code,{children:"nodemon"}),".  See the ",(0,r.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript",children:"demo apps"})," for examples."]}),"\n",(0,r.jsx)(n.h3,{id:"dbos-configuration",children:"DBOS Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["By default, ",(0,r.jsx)(n.code,{children:"DBOS.launch()"})," will read ",(0,r.jsx)(n.a,{href:"../typescript/reference/configuration",children:(0,r.jsx)(n.code,{children:"dbos-config.yaml"})})," to get key information, such as database settings.  To configure DBOS programatically, see ",(0,r.jsx)(n.a,{href:"../typescript/reference/transactapi/dbos-class#setting-the-application-configuration",children:(0,r.jsx)(n.code,{children:"DBOS.setConfig"})}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"calling-dbos-code-from-nextjs",children:"Calling DBOS Code From Next.js"}),"\n",(0,r.jsx)(n.p,{children:"The DBOS Transact library and your workflow functions are available in all server-side request handling, including page loads, server actions, and route handlers."}),"\n",(0,r.jsx)(n.p,{children:"The following example shows a  server action that starts a workflow:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'"use server";\n\nimport { DBOS } from "@dbos-inc/dbos-sdk";\nimport { MyWorkflow } from "@dbos/operations";\n\n// This action uses DBOS to idempotently launch a crashproof background task with N steps.\nexport async function startBackgroundTask(taskID: string, steps: number) {\n  await DBOS.startWorkflow(MyWorkflow, { workflowID: taskID }).backgroundTask(steps);\n  return "Background task started!";\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"This example executes DBOS code from within a route:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { NextResponse } from 'next/server';\n\nexport async function GET() {\n  // Note: DBOSBored.getActivity() is a DBOS workflow function\n  const dbb = await globalThis.DBOSBored!.getActivity();\n  return NextResponse.json(dbb);\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"preventing-bundling",children:"Preventing Bundling"}),"\n",(0,r.jsxs)(n.p,{children:["As explained in the ",(0,r.jsx)(n.a,{href:"#architectural-overview",children:"Architectural Overview"})," above, the DBOS library, workflow functions, and related code must remain external to Next.js bundles.  If DBOS code gets bundled, the bundles will contain incomplete functions, object instances, queue definitions, etc., many of which will be duplicated across bundles.  These bundles will be loaded at runtime in response to Next.js requests, leading to a confusing mess of DBOS registration errors."]}),"\n",(0,r.jsxs)(n.p,{children:["The Next.js bundling process traces ",(0,r.jsx)(n.code,{children:"import"}),"ed dependencies from pages, actions, and API routes and then minimizes them.  To prevent DBOS code from being bundled, applications can take either or both of the following approaches, as desired:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Mark Modules as External \u2013 Configure ",(0,r.jsx)(n.code,{children:"webpack"})," to treat DBOS modules and files as external, ensuring they are not pulled into the bundles."]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"globalThis"})," \u2013 Accessing code and data through ",(0,r.jsx)(n.a,{href:"https://ja-visser.medium.com/globalreferences-in-nodejs-75f095962596",children:(0,r.jsx)(n.code,{children:"globalThis"})})," instead of ",(0,r.jsx)(n.code,{children:"import"})," effectively bypasses the bundler."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"configuring-webpack-to-treat-imports-as-external",children:["Configuring ",(0,r.jsx)(n.code,{children:"webpack"})," to Treat ",(0,r.jsx)(n.code,{children:"import"}),"s as External"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"webpack"})," should be configured to treat the following as external dependencies:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The DBOS Transact library: ",(0,r.jsx)(n.code,{children:"@dbos-inc/dbos-sdk"})]}),"\n",(0,r.jsxs)(n.li,{children:["Any DBOS ",(0,r.jsx)(n.a,{href:"/typescript/reference/libraries",children:"package libraries"}),", such as ",(0,r.jsx)(n.code,{children:"@dbos-inc/dbos-ses"})]}),"\n",(0,r.jsx)(n.li,{children:"Any application source files implementing steps, transactions, or workflows"}),"\n",(0,r.jsxs)(n.li,{children:["Any application source files that create or accesses DBOS ",(0,r.jsx)(n.a,{href:"/typescript/reference/transactapi/workflow-queues",children:"queues"}),", ",(0,r.jsx)(n.a,{href:"../typescript/tutorials/instantiated-objects",children:"object instances"}),", or other DBOS objects"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Ensure that each such module or file is covered in ",(0,r.jsx)(n.code,{children:"next.config.ts"}),", within ",(0,r.jsx)(n.code,{children:"webpack"}),"'s ",(0,r.jsx)(n.code,{children:"config.externals"})," array.  Entries in ",(0,r.jsx)(n.code,{children:"config.externals"})," must match the names used in ",(0,r.jsx)(n.code,{children:"import"})," statements for recognition to work correctly.  It is not necessary to list each external file individually, as the ",(0,r.jsx)(n.code,{children:"config.externals"})," array can also accept regular expressions and callback functions.  For example, if an application ",(0,r.jsx)(n.code,{children:"import"}),"s all DBOS logic with the module alias ",(0,r.jsx)(n.code,{children:"@dbos/"})," (such as ",(0,r.jsx)(n.code,{children:'import { MyWorkflow } from "@dbos/operations"'}),"), only a single regular expression of ",(0,r.jsx)(n.code,{children:"/^@dbos\\/.+$/"})," is needed to treat all files as external:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'  webpack: (config, { isServer, dev: _dev }) => {\n    if (isServer) {\n      config.externals = [\n        ...config.externals,\n        {\n          // highlight-next-line\n          "@dbos-inc/dbos-sdk": "commonjs @dbos-inc/dbos-sdk", // Treat the @dbos-inc/dbos-sdk module as an external\n        },\n        // highlight-next-line\n        /^@dbos\\/.+$/, // Treat ALL `@dbos/*` imports (from src/dbos) as external\n      ];\n    }\n\n    return config;\n  },\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Note that for aliases such as ",(0,r.jsx)(n.code,{children:"@dbos/"})," to work, two additional components are required.  Paths must be set up in ",(0,r.jsx)(n.code,{children:"tsconfig.json"})," so that ",(0,r.jsx)(n.code,{children:"tsc"})," resolves the imports at compile time, and ",(0,r.jsx)(n.a,{href:"https://www.npmjs.com/package/module-alias",children:(0,r.jsx)(n.code,{children:"module-alias"})})," or similar should be used so that the alias is resolved by ",(0,r.jsx)(n.code,{children:"node"})," at runtime."]}),"\n",(0,r.jsxs)(n.h3,{id:"using-globalthis",children:["Using ",(0,r.jsx)(n.code,{children:"globalThis"})]}),"\n",(0,r.jsxs)(n.p,{children:["Instead of using ",(0,r.jsx)(n.code,{children:"import"})," statements, code for Next.js actions and routes can use ",(0,r.jsx)(n.code,{children:"globalThis"})," to access data and code that has been set up by ",(0,r.jsx)(n.code,{children:"server.ts"}),'.  (Unscoped variables will not work, as each bundle will have its own set of such "global" variables; ',(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis",children:(0,r.jsx)(n.code,{children:"globalThis"})})," should be used.)"]}),"\n",(0,r.jsxs)(n.h4,{id:"placing-items-in-globalthis",children:["Placing Items In ",(0,r.jsx)(n.code,{children:"globalThis"})]}),"\n",(0,r.jsxs)(n.p,{children:["Items may be placed in ",(0,r.jsx)(n.code,{children:"globalThis"})," directly.  This should generally be done before DBOS and Next.js are started."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// Share a non-DBOS object globally\nglobalThis.webSocketClients = gss;\n\n// Share a DBOS configured object globally\nglobalThis.reportSes = DBOS.configureInstance(DBOS_SES, 'reportSES', {awscfgname: 'aws_config'});\n\n// Share an entire class globally\nimport { DBOSBored } from \"./dbos_bored\";\nglobalThis.DBOSBored = DBOSBored;\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"retrieving-items-from-globalthis",children:["Retrieving Items From ",(0,r.jsx)(n.code,{children:"globalThis"})]}),"\n",(0,r.jsxs)(n.p,{children:["Items may be read from ",(0,r.jsx)(n.code,{children:"globalThis"})," from within DBOS code and Next.js server-side renders, server actions, and route handlers.  Items stored in the server's ",(0,r.jsx)(n.code,{children:"globalThis"})," are not available on the client."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const gss = globalThis.webSocketClients;\nawait globalThis.reportSes.sendEmail({/*...*/});\nawait globalThis.DBOSBored!.getActivity();\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"applying-typescript-types-to-globalthis",children:["Applying TypeScript Types To ",(0,r.jsx)(n.code,{children:"globalThis"})]}),"\n",(0,r.jsxs)(n.p,{children:["By default, ",(0,r.jsx)(n.code,{children:"globalThis"})," has the ",(0,r.jsx)(n.code,{children:"any"})," type, which is not ideal for type safety.  While ",(0,r.jsx)(n.code,{children:"globalThis"})," can be cast to an interface at each place it is used, another solution is to place a ",(0,r.jsx)(n.code,{children:"global.d.ts"})," in your project, and list any globals there."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'/* eslint-disable no-var */\nimport WebSocket from "ws";\nimport { DBOS_SES } from "@dbos-inc/dbos-email-ses";\nimport { DBOSBored as DBOSBoredT } from "@dbos/operations";\n\nexport declare global {\n  var webSocketClients: Set<WebSocket> | undefined;\n  var reportSes: DBOS_SES | undefined;\n  var DBOSBored: typeof DBOSBoredT | undefined;\n};\n'})}),"\n",(0,r.jsx)(n.h2,{id:"running-and-troubleshooting",children:"Running and Troubleshooting"}),"\n",(0,r.jsxs)(n.p,{children:["In case of any issues, the following troubleshooting steps are suggested.  Start by diagnosing ",(0,r.jsx)(n.code,{children:"dev"}),", and then proceed to production."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Check and see if compilation is succeeding.  Check ",(0,r.jsx)(n.code,{children:"tsc"}),", ",(0,r.jsx)(n.code,{children:"next build"}),", and any other steps individually."]}),"\n",(0,r.jsxs)(n.li,{children:["Ensure that the ",(0,r.jsx)(n.code,{children:"server.js"})," file and others are is available for execution by ",(0,r.jsx)(n.code,{children:"node"}),".  If not, check ",(0,r.jsx)(n.code,{children:"tsconfig.json"})," settings, and look for any compiler errors from ",(0,r.jsx)(n.code,{children:"tsc"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Check for errors in the startup of ",(0,r.jsx)(n.code,{children:"node"})," via the ",(0,r.jsx)(n.code,{children:"dev"})," or ",(0,r.jsx)(n.code,{children:"start"})," target in ",(0,r.jsx)(n.code,{children:"package.json"}),".  Ensure that database credentials are available, that migrations have been run, and that the ",(0,r.jsx)(n.code,{children:".js"})," files are where they should be."]}),"\n",(0,r.jsxs)(n.li,{children:["If server startup is not working, look for any signs that module resolution or other settings are not correct in ",(0,r.jsx)(n.code,{children:"tsconfig.json"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["If the server is starting but is hitting an error during initialization, ensure that there are adequate logging statements in the ",(0,r.jsx)(n.code,{children:"main"})," (or similar) function.  This will narrow down whether any problems are with DBOS, Next.js, or something else."]}),"\n",(0,r.jsxs)(n.li,{children:["If DBOS is reporting errors prior to ",(0,r.jsx)(n.code,{children:"launch()"}),", the issue is likely with incomplete code in ",(0,r.jsx)(n.code,{children:"server.ts"}),", or a registration error in the decorators of the DBOS functions."]}),"\n",(0,r.jsxs)(n.li,{children:["If DBOS errors indicating duplicate or missing registrations are occurring during request processing, the cause is almost always with DBOS code getting bundled.  Use ",(0,r.jsx)(n.code,{children:"next build"})," with ",(0,r.jsx)(n.code,{children:"analyze"})," mode, or another approach, to ensure that this is not happening.  Also ensure that all code is available and loaded (directly or indirectly) from ",(0,r.jsx)(n.code,{children:"server.ts"})," prior to ",(0,r.jsx)(n.code,{children:"DBOS.launch()"}),", which in turn should precede Next.js startup."]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"other-nextconfigts-options",children:["Other ",(0,r.jsx)(n.code,{children:"next.config.ts"})," Options"]}),"\n",(0,r.jsxs)(n.p,{children:["For Next.js server actions to work, it may be necessary to configure allowed origins in ",(0,r.jsx)(n.code,{children:"next.config.ts"}),".  For example, to allow server actions to work in DBOS Cloud, the following was added:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"  experimental: {\n    serverActions: {\n      allowedOrigins: ['*.cloud.dbos.dev'], // Allow DBOS Cloud to call server actions\n    },\n  },\n"})}),"\n",(0,r.jsx)(n.h1,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If your DBOS code is accessing the application database, check out the ",(0,r.jsx)(n.a,{href:"../typescript/tutorials/transaction-tutorial",children:"transactions tutorial"})," and consider database setup using ",(0,r.jsx)(n.a,{href:"../typescript/programming-guide#5-database-operations-and-transactions",children:"schema migration"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Review the ",(0,r.jsx)(n.a,{href:"../typescript/programming-guide",children:"programming guide"})," for information on job scheduling, queues, and other DBOS features."]}),"\n",(0,r.jsxs)(n.li,{children:["Check out DBOS ",(0,r.jsx)(n.a,{href:"../examples",children:"programming examples"})]}),"\n",(0,r.jsxs)(n.li,{children:["Launch your Next.js app to ",(0,r.jsx)(n.a,{href:"../cloud-tutorials/application-management",children:"DBOS Cloud"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},3589:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/serverfulnext-d80d7e6b44a149bf469dfb693dda1489.png"},7871:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/serverlessnext-a3e70af42521203c8e87c9c9ce25732c.png"},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(6540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);