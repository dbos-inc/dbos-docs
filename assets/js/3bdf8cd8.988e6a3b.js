"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[3717],{7238:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"typescript/examples/queue-worker","title":"Queue Worker","description":"This example is also available in Python.","source":"@site/docs/typescript/examples/queue-worker.md","sourceDirName":"typescript/examples","slug":"/typescript/examples/queue-worker","permalink":"/typescript/examples/queue-worker","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":35,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":35,"title":"Queue Worker"},"sidebar":"examplesSidebar","previous":{"title":"Hacker News Research Agent","permalink":"/typescript/examples/hacker-news-agent"},"next":{"title":"Fault-Tolerant Checkout","permalink":"/golang/examples/widget-store"}}');var t=n(4848),o=n(8453);const i={displayed_sidebar:"examplesSidebar",sidebar_position:35,title:"Queue Worker"},a=void 0,l={},c=[{value:"Worker Service",id:"worker-service",level:2},{value:"Web Server",id:"web-server",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function u(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["This example is also available in ",(0,t.jsx)(s.a,{href:"/python/examples/queue-worker",children:"Python"}),"."]})}),"\n",(0,t.jsx)(s.p,{children:'This example demonstrates how to run DBOS workflows in their own "queue worker" service while enqueueing and managing them from other services.\nThis design pattern lets you separate concerns and separately scale the workers that execute your durable workflows from your other services.'}),"\n",(0,t.jsxs)(s.p,{children:["Architecturally, this example contains two services: a web server and a worker service.\nThe web server uses the ",(0,t.jsx)(s.a,{href:"/typescript/reference/client",children:"DBOS Client"})," to enqueue workflows and monitor their status.\nThe worker service dequeues and executes workflows."]}),"\n",(0,t.jsxs)(s.p,{children:["All source code is ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript/queue-worker",children:"available on GitHub"}),"."]}),"\n",(0,t.jsx)("img",{src:n(8789).A,alt:"DBOS Architecture",width:"750",className:"custom-img"}),"\n",(0,t.jsx)(s.h2,{id:"worker-service",children:"Worker Service"}),"\n",(0,t.jsxs)(s.p,{children:["The worker service implements your durable workflows and their steps.\nNotably, this workflow periodically reports its progress using ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/workflow-communication",children:(0,t.jsx)(s.code,{children:"DBOS.setEvent"})}),".\nThis lets the web server query the event to monitor workflow progress."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"DBOS.registerWorkflow(\n  async function (numSteps: number): Promise<void> {\n    const progress = {\n      steps_completed: 0,\n      num_steps: numSteps,\n    };\n    // The server can query this event to obtain\n    // the current progress of the workflow\n    await DBOS.setEvent(WF_PROGRESS_KEY, progress);\n    for (let i = 0; i < numSteps; i++) {\n      await DBOS.runStep(() => stepFunction(i));\n      // Update workflow progress each time a step completes\n      progress.steps_completed = i + 1;\n      await DBOS.setEvent(WF_PROGRESS_KEY, progress);\n    }\n  },\n  { name: 'workflow' },\n);\n\nasync function stepFunction(i: number): Promise<void> {\n  console.log(`Step ${i} completed!`);\n  // Sleep one second\n  await new Promise((resolve) => setTimeout(resolve, 1000));\n}\n"})}),"\n",(0,t.jsx)(s.p,{children:"The worker service also defines a queue on which the web server can submit workflows for execution:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"new WorkflowQueue('workflow-queue');\n"})}),"\n",(0,t.jsx)(s.p,{children:"In its main function, the worker service configures and launches DBOS with the registered workflows and queues then waits indefinitely, dequeuing and executing workflows:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"async function main(): Promise<void> {\n  const systemDatabaseUrl =\n    process.env.DBOS_SYSTEM_DATABASE_URL || 'postgresql://postgres:dbos@localhost:5432/dbos_queue_worker';\n  DBOS.setConfig({\n    name: 'dbos-queue-worker',\n    systemDatabaseUrl: systemDatabaseUrl,\n  });\n  await DBOS.launch();\n  // After launching DBOS, the worker waits indefinitely,\n  // dequeuing and executing workflows.\n  console.log('Worker started, waiting for workflows...');\n  await new Promise(() => {});\n}\n\nmain().catch(console.log);\n"})}),"\n",(0,t.jsx)(s.h2,{id:"web-server",children:"Web Server"}),"\n",(0,t.jsx)(s.p,{children:"The web server first creates a DBOS Client:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"const systemDatabaseUrl =\n  process.env.DBOS_SYSTEM_DATABASE_URL || 'postgresql://postgres:dbos@localhost:5432/dbos_queue_worker';\nconst client = await DBOSClient.create({ systemDatabaseUrl });\n"})}),"\n",(0,t.jsx)(s.p,{children:"It then enqueues workflows using the client:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"app.post('/api/workflows', async (_req: Request, res: Response) => {\n  const numSteps = 10;\n  await client.enqueue(\n    {\n      queueName: 'workflow-queue',\n      workflowName: 'workflow',\n    },\n    numSteps,\n  );\n  res.json({ status: 'enqueued' });\n});\n"})}),"\n",(0,t.jsxs)(s.p,{children:["The web server can also report workflow status.\nThis function first lists all workflows, then uses ",(0,t.jsx)(s.a,{href:"/typescript/tutorials/workflow-communication",children:(0,t.jsx)(s.code,{children:"getEvent"})})," to query the progress of each workflow.\nThis is a useful pattern for showing workflow progress or status to end users of your application."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",children:"app.get('/api/workflows', async (_req: Request, res: Response) => {\n  // Use the DBOS client to list all workflows\n  const workflows = await client.listWorkflows({\n    workflowName: 'workflow',\n    sortDesc: true,\n  });\n  const statuses: WorkflowStatus[] = [];\n  for (const workflow of workflows) {\n    // Query each workflow's progress event. This may not be available\n    // if the workflow has not yet started executing.\n    const progress = await client.getEvent<ProgressEvent>(workflow.workflowID, WF_PROGRESS_KEY, 0);\n    const status: WorkflowStatus = {\n      workflow_id: workflow.workflowID,\n      workflow_status: workflow.status,\n      steps_completed: progress ? progress.steps_completed : null,\n      num_steps: progress ? progress.num_steps : null,\n    };\n    statuses.push(status);\n  }\n  res.json(statuses);\n});\n"})}),"\n",(0,t.jsx)(s.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,t.jsxs)(s.p,{children:["Clone and enter the ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd typescript/queue-worker\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Then follow the instructions in the ",(0,t.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript/queue-worker",children:"README"})," to run the app."]})]})}function p(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},8789:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/queue-worker-d55ea32938eec5d1f181b9e62dfa3429.png"},8453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>a});var r=n(6540);const t={},o=r.createContext(t);function i(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);