"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[418],{928:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"python/examples/agent-inbox","title":"Human-in-the-Loop","description":"This example shows how to use DBOS to add human-in-the-loop to your AI agent.","source":"@site/docs/python/examples/agent-inbox.md","sourceDirName":"python/examples","slug":"/python/examples/agent-inbox","permalink":"/python/examples/agent-inbox","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":24,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":24,"title":"Human-in-the-Loop"},"sidebar":"examplesSidebar","previous":{"title":"Document Ingestion Pipeline","permalink":"/python/examples/document-detective"},"next":{"title":"Fault-Tolerant Checkout","permalink":"/python/examples/widget-store"}}');var s=t(4848),o=t(8453);const i={displayed_sidebar:"examplesSidebar",sidebar_position:24,title:"Human-in-the-Loop"},r=void 0,l={},d=[{value:"Durable Agents",id:"durable-agents",level:2},{value:"Calling and Notifying the Agent",id:"calling-and-notifying-the-agent",level:2},{value:"Building an Agent Inbox",id:"building-an-agent-inbox",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function p(e){const n={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["This example shows how to use DBOS to add ",(0,s.jsx)(n.strong,{children:"human-in-the-loop"})," to your AI agent."]}),"\n",(0,s.jsx)(n.p,{children:"Production AI agents often need to wait for human approval before performing critical tasks.\nHowever, because there are real people involved, approval doesn't always happen instantly, and agents need to be able to reliably wait hours or days for human intervention, then seamlessly resume when it arrives."}),"\n",(0,s.jsx)(n.p,{children:"This application demonstrates how to build reliable human-in-the-loop with durable workflows.\nWe'll see how to build agents that can wait hours or days for human input to arrive (surviving process restarts).\nWe'll also see how to use workflow introspection to monitor active agents and create an \"inbox\" of workflows that need approval."}),"\n",(0,s.jsxs)(n.p,{children:["All source code is ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/agent-inbox",children:"available on GitHub"}),"."]}),"\n",(0,s.jsx)("img",{src:t(8716).A,alt:"Agent Inbox",width:"800",className:"custom-img"}),"\n",(0,s.jsx)(n.h2,{id:"durable-agents",children:"Durable Agents"}),"\n",(0,s.jsxs)(n.p,{children:["First, we'll write the scaffold of a durable and observable agent with human-in-the-loop.\nThis agent needs human approval for a key step.\nTo get the approval, it calls ",(0,s.jsx)(n.a,{href:"/python/tutorials/workflow-communication#workflow-messaging-and-notifications",children:(0,s.jsx)(n.code,{children:"DBOS.recv"})}),".\nThis ",(0,s.jsx)(n.strong,{children:"durably waits"})," for a configurable length of time (potentially hours or days) for a notification to arrive, automatically recovering from the transient failures and process restarts that will inevitably occur during a long wait."]}),"\n",(0,s.jsxs)(n.p,{children:['To allow us to create an "inbox" of agents pending approval, the workflow also publishes its status using ',(0,s.jsx)(n.a,{href:"/python/tutorials/workflow-communication#workflow-events",children:(0,s.jsx)(n.code,{children:"DBOS.set_event"})}),".\nWe'll see later how this helps us build observability endpoints to list all active, completed, or failed agents."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@DBOS.workflow()\ndef durable_agent(request: AgentStartRequest):\n    # Set an agent status the frontend can query\n    agent_status: AgentStatus = AgentStatus(\n        agent_id=DBOS.workflow_id,\n        name=request.name,\n        task=request.task,\n        status="working",\n        created_at=datetime.now().isoformat(),\n        question=f"Should I proceed with task: {request.task}?",\n    )\n    DBOS.set_event(AGENT_STATUS, agent_status)\n    print("Starting agent:", agent_status)\n\n    # Do some work...\n\n    # Upon reaching the step that needs approval, update status\n    # to `pending_approval` and await an approval notification. \n    agent_status.status = "pending_approval"\n    DBOS.set_event(AGENT_STATUS, agent_status)\n    approval: Optional[HumanResponseRequest] = DBOS.recv()\n\n    # If approved, continue execution. Otherwise, raise an exception\n    # and terminate the agent.\n    if approval is None:\n        # If approval times out, treat it as a denial\n        agent_status.status = "denied"\n        DBOS.set_event(AGENT_STATUS, agent_status)\n        print("Agent timed out:", agent_status)\n        raise Exception("Agent timed out awaiting approvial")\n    elif approval.response == "deny":\n        agent_status.status = "denied"\n        DBOS.set_event(AGENT_STATUS, agent_status)\n        print("Agent denied:", agent_status)\n        raise Exception("Agent denied approval")\n    else:\n        agent_status.status = "working"\n        print("Agent approved:", agent_status)\n        DBOS.set_event(AGENT_STATUS, agent_status)\n\n    # Do some more work...\n\n    return "Agent successful"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"calling-and-notifying-the-agent",children:"Calling and Notifying the Agent"}),"\n",(0,s.jsxs)(n.p,{children:["Here's the endpoint to notify an agent it was approved or denied.\nIt uses ",(0,s.jsx)(n.a,{href:"/python/tutorials/workflow-communication#workflow-messaging-and-notifications",children:(0,s.jsx)(n.code,{children:"DBOS.send"})})," to send a message to an agent awaiting approval, waking it up."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@app.post("/agents/{agent_id}/respond")\ndef respond_to_agent(agent_id: str, response: HumanResponseRequest):\n    # Notify an agent it has been approved or denied\n    DBOS.send(agent_id, response)\n    return {"ok": True}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Here's the endpoint to start a new agent.\nIt starts the agent as a durable background task using ",(0,s.jsx)(n.code,{children:"DBOS.start_workflow"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@app.post("/agents")\ndef start_agent(request: AgentStartRequest):\n    # Start a durable agent in the background\n    DBOS.start_workflow(durable_agent, request)\n    return {"ok": True}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"building-an-agent-inbox",children:"Building an Agent Inbox"}),"\n",(0,s.jsxs)(n.p,{children:['To build an "agent inbox", we need to be able to see which agents are pending approval.\nWe can do this with the DBOS workflow introspection API.\nWe list all active agents with ',(0,s.jsx)(n.a,{href:"/python/reference/contexts#list_workflows",children:(0,s.jsx)(n.code,{children:"DBOS.list_workflows"})}),", then retrieve the status of each.\nWe return only agents that currently have the ",(0,s.jsx)(n.code,{children:"pending_approval"})," status."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@app.get("/agents/waiting", response_model=list[AgentStatus])\nasync def list_waiting_agents():\n    # List all active agents and retrieve their statuses\n    agent_workflows = await DBOS.list_workflows_async(\n        status="PENDING", name=durable_agent.__qualname__\n    )\n    statuses: list[AgentStatus] = await asyncio.gather(\n        *[DBOS.get_event_async(w.workflow_id, AGENT_STATUS) for w in agent_workflows]\n    )\n    # Only return active agents that are currently awaiting human approval\n    return [status for status in statuses if status.status == "pending_approval"]\n'})}),"\n",(0,s.jsx)(n.p,{children:"We also build endpoints to list successful and failed agents:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@app.get("/agents/approved", response_model=list[AgentStatus])\nasync def list_approved_agents():\n    # List all successful agents and retrieve their statuses\n    agent_workflows = await DBOS.list_workflows_async(\n        status="SUCCESS", name=durable_agent.__qualname__\n    )\n    statuses = await asyncio.gather(\n        *[DBOS.get_event_async(w.workflow_id, AGENT_STATUS) for w in agent_workflows]\n    )\n    return list(statuses)\n\n\n@app.get("/agents/denied", response_model=list[AgentStatus])\nasync def list_denied_agents():\n    # List all failed agents and retrieve their statuses\n    agent_workflows = await DBOS.list_workflows_async(\n        status="ERROR", name=durable_agent.__qualname__\n    )\n    statuses = await asyncio.gather(\n        *[DBOS.get_event_async(w.workflow_id, AGENT_STATUS) for w in agent_workflows]\n    )\n    return list(statuses)\n\n'})}),"\n",(0,s.jsx)(n.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,s.jsxs)(n.p,{children:["Clone and enter the ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd python/agent-inbox\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then follow the instructions in the ",(0,s.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/agent-inbox",children:"README"})," to run the app."]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8716:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/agent-inbox-322af8204157b048ab2591568533e827.png"},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var a=t(6540);const s={},o=a.createContext(s);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);