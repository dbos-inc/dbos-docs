"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[5151],{1274:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>l,frontMatter:()=>s,metadata:()=>a,toc:()=>c});var o=r(4848),n=r(8453);const s={sidebar_position:5,title:"Stored Procedures",description:"Learn how to improve database interaction performance with Stored Procedures"},i=void 0,a={id:"typescript/tutorials/stored-proc-tutorial",title:"Stored Procedures",description:"Learn how to improve database interaction performance with Stored Procedures",source:"@site/docs/typescript/tutorials/stored-proc-tutorial.md",sourceDirName:"typescript/tutorials",slug:"/typescript/tutorials/stored-proc-tutorial",permalink:"/typescript/tutorials/stored-proc-tutorial",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Stored Procedures",description:"Learn how to improve database interaction performance with Stored Procedures"},sidebar:"tutorialSidebar",previous:{title:"Workflows",permalink:"/typescript/tutorials/workflow-tutorial"},next:{title:"Idempotency",permalink:"/typescript/tutorials/idempotency-tutorial"}},d={},c=[{value:"Deploying DBOS Stored Procedures",id:"deploying-dbos-stored-procedures",level:2}];function p(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",p:"p",pre:"pre",...(0,n.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"In this guide, you'll learn how to interact with your database using stored procedures."}),"\n",(0,o.jsxs)(t.p,{children:["Stored procedures are similar to ",(0,o.jsx)(t.a,{href:"/typescript/tutorials/transaction-tutorial",children:"transaction functions"}),".\nThey are used to perform operations on your application database.\nHowever, stored procedure functions run inside the database where transaction functions run on the application server.\nRunning your business logic inside the database improves both performance and scalability.\nTransaction functions require at least three network round trips to the database in addition to any queries executed by the transaction function itself.\nStored procedure functions only require a single network round trip to the database, while still providing the same behavior and guarantees as transaction functions."]}),"\n",(0,o.jsxs)(t.p,{children:["While most database management systems provide support for stored procedures, they are often avoided because they are hard to use.\nThey typically need to be written in a custom language such as ",(0,o.jsx)(t.a,{href:"https://www.postgresql.org/docs/current/plpgsql.html",children:"PL/pgSQL"}),".\nAdditionally, they are not usually integrated into the application development process.\nDBOS stored procedure functions, in contrast, are written in TypeScript like the rest of your DBOS application.\nThe ",(0,o.jsx)(t.a,{href:"/typescript/reference/dbos-compiler",children:"DBOS Compiler"})," deploys the stored procedure functions from your application to your application database."]}),"\n",(0,o.jsxs)(t.p,{children:["Here's an example of a stored procedure function.\nYou'll notice it is similar to the ",(0,o.jsx)(t.a,{href:"/typescript/tutorials/transaction-tutorial",children:"example transaction function"})," from the transaction tutorial."]}),"\n",(0,o.jsx)(t.admonition,{type:"warning",children:(0,o.jsxs)(t.p,{children:["Because stored procedures run inside the database, only raw database queries are supported.\nQuery builders like ",(0,o.jsx)(t.a,{href:"https://knexjs.org/",children:"Knex.js"})," and ORMs like ",(0,o.jsx)(t.a,{href:"/typescript/tutorials/using-typeorm",children:"TypeORM"})," and ",(0,o.jsx)(t.a,{href:"/typescript/tutorials/using-prisma",children:"Prisma"})," are not supported in stored procedure functions."]})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-javascript",children:"export class Greetings {\n  @StoredProcedure()\n  static async InsertGreeting(ctxt: StoredProcedureContext, friend: string, note: string) {\n    await ctxt.query('INSERT INTO greetings (name, note) VALUES (?, ?)', [friend, note]);\n  }\n}\n"})}),"\n",(0,o.jsx)(t.h2,{id:"deploying-dbos-stored-procedures",children:"Deploying DBOS Stored Procedures"}),"\n",(0,o.jsxs)(t.p,{children:["DBOS Stored procedure functions depend on ",(0,o.jsx)(t.a,{href:"https://plv8.github.io/",children:"PLV8"}),", a trusted JavaScript language extension for PostgresSQL.\nPLV8 is supported out of the box on DBOS Cloud and several major cloud database providers.\nFor running locally, we recommend using the ",(0,o.jsxs)(t.a,{href:"https://plv8.com",children:[(0,o.jsx)(t.code,{children:"sibedge/postgres-plv8"})," Docker image"]})," provided by ",(0,o.jsx)(t.a,{href:"https://sibedge.com/",children:"Sibedge"}),".\nFor using DBOS Stored Procedures on your own PostgreSQL server, please see the ",(0,o.jsx)(t.a,{href:"https://plv8.github.io/#building",children:"official PLV8 documentation"})," for installation instructions."]}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["As of version 1.17, the ",(0,o.jsx)(t.a,{href:"../reference/cli#npx-dbos-inccreate",children:"@dbos-inc/create"})," templates have been updated to use ",(0,o.jsx)(t.code,{children:"sibedge/postgres-plv8"})," in the ",(0,o.jsx)(t.code,{children:"start_postgres_docker.js"})," script.\nOlder DBOS applications using Docker will need to switch their PostgreSQL image from ",(0,o.jsx)(t.code,{children:"postgres:16.1"})," to ",(0,o.jsx)(t.code,{children:"sibedge/postgres-plv8"})," manually to support Stored Procedures."]})}),"\n",(0,o.jsxs)(t.p,{children:["Before running your DBOS application that uses stored procedures, you need to deploy those stored procedures to the database.\nTo deploy your stored procedure functions to the database, you need the ",(0,o.jsx)(t.a,{href:"/typescript/reference/dbos-compiler",children:"DBOS Compiler"}),".\nAdd the DBOS Compiler package as a devDependency of your app via NPM:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"npm install --save-dev @dbos-inc/dbos-compiler\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Once the DBOS Compiler is installed, you can use it to deploy the stored procedures to the database server specified\nin the ",(0,o.jsxs)(t.a,{href:"/typescript/reference/configuration",children:[(0,o.jsx)(t.code,{children:"dbos-config.yaml"})," file"]})," with the following command:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"npx dbosc deploy\n"})}),"\n",(0,o.jsx)(t.admonition,{type:"info",children:(0,o.jsxs)(t.p,{children:["For information about all of the compiler's command line options, please see the ",(0,o.jsx)(t.a,{href:"/typescript/reference/dbos-compiler",children:"DBOS Compiler reference page"})]})}),"\n",(0,o.jsxs)(t.p,{children:["You can add ",(0,o.jsx)(t.code,{children:"npx dbosc deploy"})," to your ",(0,o.jsx)(t.a,{href:"/typescript/reference/configuration#database",children:"database migration commands"})," to run it alongside other schema migrations.\nDeploying your app's stored procedures via Database Schema Management is required for DBOS Cloud deployment."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"database:\n  migrate:\n    - npx knex migrate:latest\n    - npx dbosc deploy\n"})})]})}function l(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>a});var o=r(6540);const n={},s=o.createContext(n);function i(e){const t=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),o.createElement(s.Provider,{value:t},e.children)}}}]);