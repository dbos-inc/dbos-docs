"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[3564],{4869:(e,s,n)=>{n.d(s,{Ay:()=>l,RM:()=>o});var t=n(4848),i=n(8453),r=n(8069);const o=[];function a(e){const s={a:"a",code:"code",p:"p",pre:"pre",...(0,i.R)(),...e.components},{TabItem:n,Tabs:o}=s;return n||c("TabItem",!0),o||c("Tabs",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(o,{groupId:"postgres-or-docker",className:"small-tabs",children:[(0,t.jsxs)(n,{value:"cloud",label:"Use Cloud Postgres",children:[(0,t.jsx)(s.p,{children:"You can connect your local application to a Postgres database hosted in DBOS Cloud."}),(0,t.jsx)(s.p,{children:"First, set a password for your DBOS Cloud database:"}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"dbos-cloud db reset-password\n"})}),(0,t.jsx)(s.p,{children:"Then connect your local app to your cloud database.\nWhen prompted, enter the password you just set."}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"dbos-cloud db local\n"})})]}),(0,t.jsxs)(n,{value:"docker",label:"Launch Postgres with Docker",children:[(0,t.jsxs)(o,{groupId:"operating-systems",className:"small-tabs",children:[(0,t.jsxs)(n,{value:"mac",label:"macOS",children:[(0,t.jsxs)(s.p,{children:["You can install Docker on macOS through ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/desktop/install/mac-install/",children:"Docker Desktop"}),"."]}),(0,t.jsx)(s.p,{children:"Then, run this script to launch Postgres in a Docker container:"}),(0,t.jsx)(r.A,{language:"bash",children:`export PGPASSWORD=dbos\n# Docker may require sudo -E\n${e.cmd}`})]}),(0,t.jsxs)(n,{value:"linux",label:"Linux",children:[(0,t.jsxs)(s.p,{children:["Follow the ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/engine/install/",children:"Docker Engine installation page"})," to install Docker on several popular Linux distributions."]}),(0,t.jsx)(s.p,{children:"Then, run this script to launch Postgres in a Docker container:"}),(0,t.jsx)(r.A,{language:"bash",children:`export PGPASSWORD=dbos\n# Docker may require sudo -E\n${e.cmd}`})]}),(0,t.jsxs)(n,{value:"win-ps",label:"Windows (PowerShell)",children:[(0,t.jsxs)(s.p,{children:["You can install Docker on Windows through ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/desktop/install/windows-install/",children:"Docker Desktop"}),"."]}),(0,t.jsx)(s.p,{children:"Then, run this script to launch Postgres in a Docker container:"}),(0,t.jsx)(r.A,{language:"bash",children:`$env:PGPASSWORD = "dbos"\n${e.cmd}`})]}),(0,t.jsxs)(n,{value:"win-cmd",label:"Windows (cmd)",children:[(0,t.jsxs)(s.p,{children:["You can install Docker on Windows through ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/desktop/install/windows-install/",children:"Docker Desktop"}),"."]}),(0,t.jsx)(s.p,{children:"Then, run this script to launch Postgres in a Docker container:"}),(0,t.jsx)(r.A,{language:"bash",children:`set PGPASSWORD=dbos\n${e.cmd}`})]})]}),(0,t.jsxs)(s.p,{children:["If successful, the script should print ",(0,t.jsx)(s.code,{children:"Database started successfully!"})]})]}),(0,t.jsx)(n,{value:"postgres",label:"Install Postgres",children:(0,t.jsxs)(o,{groupId:"operating-systems",className:"small-tabs",children:[(0,t.jsxs)(n,{value:"mac",label:"macOS",children:[(0,t.jsxs)(s.p,{children:["Follow ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/download/macosx/",children:"this guide"})," to install Postgres on macOS."]}),(0,t.jsxs)(s.p,{children:["Then, set the ",(0,t.jsx)(s.code,{children:"PGPASSWORD"})," environment variable to your Postgres password:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"export PGPASSWORD=<your-postgres-password>\n"})})]}),(0,t.jsxs)(n,{value:"linux",label:"Linux",children:[(0,t.jsxs)(s.p,{children:["Follow these ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/download/linux/",children:"guides"})," to install Postgres on popular Linux distributions."]}),(0,t.jsxs)(s.p,{children:["Then, set the ",(0,t.jsx)(s.code,{children:"PGPASSWORD"})," environment variable to your Postgres password:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"export PGPASSWORD=<your-postgres-password>\n"})})]}),(0,t.jsxs)(n,{value:"win-ps",label:"Windows (PowerShell)",children:[(0,t.jsxs)(s.p,{children:["Follow ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/download/windows/",children:"this guide"})," to install Postgres on Windows."]}),(0,t.jsxs)(s.p,{children:["Then, set the ",(0,t.jsx)(s.code,{children:"PGPASSWORD"})," environment variable to your Postgres password:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'$env:PGPASSWORD = "<your-postgres-password>"\n'})})]}),(0,t.jsxs)(n,{value:"win-cmd",label:"Windows (cmd)",children:[(0,t.jsxs)(s.p,{children:["Follow ",(0,t.jsx)(s.a,{href:"https://www.postgresql.org/download/windows/",children:"this guide"})," to install Postgres on Windows."]}),(0,t.jsxs)(s.p,{children:["Then, set the ",(0,t.jsx)(s.code,{children:"PGPASSWORD"})," environment variable to your Postgres password:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"set PGPASSWORD=<your-postgres-password>\n"})})]})]})})]}),"\n",(0,t.jsxs)(s.p,{children:["Alternatively, if you already have a Postgres database, update ",(0,t.jsx)(s.code,{children:"dbos-config.yaml"})," with its connection information."]})]})}function l(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}function c(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},3229:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"typescript/examples/task-scheduler","title":"DBOS Task Scheduler","description":"Learn how to combine DBOS + Next.js with this cloud scheduling tool","source":"@site/docs/typescript/examples/task-scheduler.md","sourceDirName":"typescript/examples","slug":"/typescript/examples/task-scheduler","permalink":"/typescript/examples/task-scheduler","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":20,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":20,"title":"DBOS Task Scheduler","description":"Learn how to combine DBOS + Next.js with this cloud scheduling tool"},"sidebar":"examplesSidebar","previous":{"title":"Kafka Alert Queue","permalink":"/typescript/examples/kafka-alert-queue"},"next":{"title":"Checkout Workflow","permalink":"/typescript/examples/checkout-tutorial"}}');var i=n(4848),r=n(8453),o=n(4869);const a={displayed_sidebar:"examplesSidebar",sidebar_position:20,title:"DBOS Task Scheduler",description:"Learn how to combine DBOS + Next.js with this cloud scheduling tool"},l="DBOS Task Scheduler",c={},d=[{value:"Running DBOS Task Scheduler in DBOS Cloud",id:"running-dbos-task-scheduler-in-dbos-cloud",level:2},{value:"Running DBOS Task Scheduler Locally",id:"running-dbos-task-scheduler-locally",level:2},{value:"Setting Up A Database",id:"setting-up-a-database",level:3},...o.RM,{value:"Running In Development",id:"running-in-development",level:3},{value:"Production Builds",id:"production-builds",level:3},{value:"DBOS Task Scheduler&#39;s Web UI",id:"dbos-task-schedulers-web-ui",level:2},{value:"Setting Up Email Notifications (Optional)",id:"setting-up-email-notifications-optional",level:2},{value:"DBOS and Database Logic",id:"dbos-and-database-logic",level:2},{value:"Task Code",id:"task-code",level:3},{value:"Main Workflow",id:"main-workflow",level:3},{value:"Scheduling",id:"scheduling",level:3},{value:"Database Schema and Transactions",id:"database-schema-and-transactions",level:3},{value:"Sending Email with Amazon SES",id:"sending-email-with-amazon-ses",level:3},{value:"UI",id:"ui",level:2},{value:"UI Components",id:"ui-components",level:3},{value:"Server Actions",id:"server-actions",level:3},{value:"API Routes",id:"api-routes",level:3},{value:"DBOS Routes",id:"dbos-routes",level:3},{value:"WebSockets",id:"websockets",level:3},{value:"Database Notifications",id:"database-notifications",level:3},{value:"Next.js Custom Server",id:"nextjs-custom-server",level:3},{value:"Loading DBOS Logic",id:"loading-dbos-logic",level:4},{value:"Configuring DBOS (Optional)",id:"configuring-dbos-optional",level:4},{value:"Launching DBOS",id:"launching-dbos",level:4},{value:"Starting the Next.js Server",id:"starting-the-nextjs-server",level:4},{value:"Setting up DBOS Routes (optional)",id:"setting-up-dbos-routes-optional",level:4},{value:"Setting up WebSockets (optional)",id:"setting-up-websockets-optional",level:4},{value:"The Importance of <code>globalThis</code>",id:"the-importance-of-globalthis",level:4},{value:"Configuration Files",id:"configuration-files",level:2},{value:"<code>package.json</code>",id:"packagejson",level:3},{value:"npm run dev",id:"npm-run-dev",level:4},{value:"<code>nodemon.json</code>",id:"nodemonjson",level:5},{value:"npm run build / start",id:"npm-run-build--start",level:4},{value:"npm run lint",id:"npm-run-lint",level:4},{value:"<code>eslint.config.mjs</code>",id:"eslintconfigmjs",level:5},{value:"<code>tsconfig.json</code>",id:"tsconfigjson",level:3},{value:"<code>next.config.ts</code>",id:"nextconfigts",level:3},{value:"<code>dbos-config.yaml</code>",id:"dbos-configyaml",level:3},{value:"<code>knexfile.ts</code>",id:"knexfilets",level:3},{value:"<code>jest.config.js</code>",id:"jestconfigjs",level:3},{value:"<code>.gitignore</code>",id:"gitignore",level:3}];function h(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Details:t}=s;return t||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"dbos-task-scheduler",children:"DBOS Task Scheduler"})}),"\n",(0,i.jsxs)(s.p,{children:["DBOS Task Scheduler is a full-stack app built with ",(0,i.jsx)(s.a,{href:"https://nextjs.org/",children:"Next.js"})," and ",(0,i.jsx)(s.a,{href:"https://dbos.dev",children:"DBOS"}),".  It serves as both a demo for learning DBOS concepts and a template for building your own DBOS-powered Next.js applications."]}),"\n",(0,i.jsx)(s.admonition,{type:"tip",children:(0,i.jsxs)(s.p,{children:["For general information about integrating DBOS with Next.js, see the ",(0,i.jsx)(s.a,{href:"/integrations/adding-dbos-to-next",children:'"Adding DBOS to Next.js Apps"'})," guide."]})}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.img,{alt:"Screen shot of DBOS Task Scheduler",src:n(7536).A+"",width:"3766",height:"1154"})}),"\n",(0,i.jsxs)(s.p,{children:["If you like the idea of a cloud-based task scheduler with a calendar UI, you can easily ",(0,i.jsx)(s.a,{href:"#task-code",children:"customize it with your own tasks"})," and deploy it to ",(0,i.jsx)(s.a,{href:"https://www.dbos.dev/dbos-cloud",children:"DBOS Cloud"})," for free."]}),"\n",(0,i.jsx)(s.h2,{id:"running-dbos-task-scheduler-in-dbos-cloud",children:"Running DBOS Task Scheduler in DBOS Cloud"}),"\n",(0,i.jsx)(s.p,{children:"Provisioning an instance of DBOS Task Scheduler in DBOS Cloud is easy:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Go to ",(0,i.jsx)(s.a,{href:"https://console.dbos.dev/launch",children:"DBOS Cloud Console"})]}),"\n",(0,i.jsx)(s.li,{children:"Sign Up or Sign In, if you haven't already"}),"\n",(0,i.jsx)(s.li,{children:'Select the "TYPESCRIPT" tab'}),"\n",(0,i.jsx)(s.li,{children:'Choose the "DBOS Task Scheduler" template'}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"After a bit of launch activity, you will be presented with:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"A URL for accessing the app"}),"\n",(0,i.jsx)(s.li,{children:"Monitoring dashboards"}),"\n",(0,i.jsx)(s.li,{children:"Management options"}),"\n",(0,i.jsx)(s.li,{children:"Code download"}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"running-dbos-task-scheduler-locally",children:"Running DBOS Task Scheduler Locally"}),"\n",(0,i.jsxs)(s.p,{children:["If you ",(0,i.jsx)(s.a,{href:"#running-dbos-task-scheduler-in-dbos-cloud",children:"started out in DBOS Cloud"}),", you can download your code to your development environment.  Or, you can ",(0,i.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"clone the code from the git repository"})," and change to the ",(0,i.jsx)(s.code,{children:"typescript/nextjs-calendar"})," directory."]}),"\n",(0,i.jsx)(s.h3,{id:"setting-up-a-database",children:"Setting Up A Database"}),"\n",(0,i.jsx)(s.p,{children:'DBOS requires a Postgres database.  If your local environment is set up with database connection settings, these will be used.  If not, the "database wizard" will help establish a connection.'}),"\n",(0,i.jsxs)(t,{children:[(0,i.jsx)("summary",{children:"You can also start a Postgres docker image, or provision a cloud instance of Postgres."}),(0,i.jsx)(o.Ay,{cmd:"node start_postgres_docker.js"})]}),"\n",(0,i.jsx)(s.h3,{id:"running-in-development",children:"Running In Development"}),"\n",(0,i.jsx)(s.p,{children:"Once you have a local copy of the DBOS Task Scheduler, run the following:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"npm install\nnpm run dev\n"})}),"\n",(0,i.jsxs)(s.p,{children:["When running under ",(0,i.jsx)(s.code,{children:"npm run dev"}),", any changes to source files will cause the application to reload (if UI components were changed) or restart (if DBOS server components were changed)."]}),"\n",(0,i.jsx)(s.h3,{id:"production-builds",children:"Production Builds"}),"\n",(0,i.jsxs)(s.p,{children:["Instead of ",(0,i.jsx)(s.code,{children:"npm run dev"}),' it is also possible to run the following sequence of commands to launch an optimized "production" build:']}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"npm install\nnpm run build\nnpx dbos migrate\nnpm run start\n"})}),"\n",(0,i.jsx)(s.h2,{id:"dbos-task-schedulers-web-ui",children:"DBOS Task Scheduler's Web UI"}),"\n",(0,i.jsx)(s.p,{children:"Once the app is running, open it in a web browser."}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["If the app is running In DBOS Cloud, the URL will be shown ",(0,i.jsx)(s.a,{href:"https://console.dbos.dev/applications",children:"in the cloud console"}),' under "Visit your app", and the URL will also be reported in the output of ',(0,i.jsx)(s.a,{href:"../../cloud-tutorials/application-management#deploying-applications",children:(0,i.jsx)(s.code,{children:"dbos-cloud app deploy"})}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["If running locally, the default will be at ",(0,i.jsx)(s.a,{href:"http://localhost:3000/",children:"http://localhost:3000/"}),", but check your startup logs for confirmation."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["Upon opening the web browser (and perhaps dismissing the help popup), the main screen should be shown:\n",(0,i.jsx)(s.img,{alt:"Screen shot of DBOS Task Scheduler",src:n(7536).A+"",width:"3766",height:"1154"})]}),"\n",(0,i.jsx)(s.h2,{id:"setting-up-email-notifications-optional",children:"Setting Up Email Notifications (Optional)"}),"\n",(0,i.jsxs)(s.p,{children:["The DBOS Task Scheduler app will ",(0,i.jsx)(s.em,{children:"optionally"})," send notifications using Amazon Simple Email Service (SES).  To use this, set the following environment variables prior to launching the app:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"AWS_REGION: The AWS region for SES service"}),"\n",(0,i.jsx)(s.li,{children:"AWS_ACCESS_KEY_ID: The AWS access key provisioned for SES access"}),"\n",(0,i.jsx)(s.li,{children:"AWS_SECRET_ACCESS_KEY: The access secret corresponding to AWS_ACCESS_KEY_ID"}),"\n",(0,i.jsx)(s.li,{children:'REPORT_EMAIL_FROM_ADDRESS: The email address to use as the "from" address for results reports'}),"\n",(0,i.jsx)(s.li,{children:'REPORT_EMAIL_TO_ADDRESS: The email address to use as the "to" address for results reports'}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"If these environment variables aren't set, email will not be sent."}),"\n",(0,i.jsx)(s.h1,{id:"code-tour",children:"Code Tour"}),"\n",(0,i.jsx)(s.admonition,{type:"tip",children:(0,i.jsxs)(s.p,{children:["The DBOS Task Scheduler app is somewhat complex, showcasing many features.  For a simpler starting point, see ",(0,i.jsx)(s.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/typescript/dbos-nextjs-starter#readme",children:"dbos-nextjs-starter"}),"."]})}),"\n",(0,i.jsx)(s.p,{children:"This app uses the following:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["DBOS ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/workflow-tutorial",children:"Workflows"}),", ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/transaction-tutorial",children:"Transactions"}),", and ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/step-tutorial",children:"Steps"})," \u2013 Complete actions ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/idempotency-tutorial",children:"exactly once"}),", record the results, and send notifications, without worrying about server disruptions"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://knexjs.org/",children:"Knex"})," \u2013 Type-safe database access and schema management"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"/typescript/tutorials/scheduled-workflows",children:"DBOS Scheduled Workflows"})," \u2013 Ensure tasks are run as scheduled"]}),"\n",(0,i.jsxs)(s.li,{children:["React, with ",(0,i.jsx)(s.a,{href:"https://mui.com",children:"Material"})," and ",(0,i.jsx)(s.a,{href:"https://github.com/jquense/react-big-calendar",children:"react-big-calendar"})," \u2013 Present a calendar of tasks and results"]}),"\n",(0,i.jsx)(s.li,{children:"Next.js server actions \u2013 Simple interaction between the browser-based client and the server"}),"\n",(0,i.jsx)(s.li,{children:"Next.js API routes and DBOS HTTP endpoints \u2013 Allow access to the server logic from clients other than Next.js"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API",children:"WebSockets"})," \u2013 Send calendar and result updates to the browser with low latency"]}),"\n",(0,i.jsx)(s.li,{children:"Database triggers \u2013 Listen for database updates made by other VMs"}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"https://jestjs.io/",children:"Jest"})," \u2013 Unit test backend code"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"dbos-and-database-logic",children:"DBOS and Database Logic"}),"\n",(0,i.jsx)(s.h3,{id:"task-code",children:"Task Code"}),"\n",(0,i.jsxs)(s.p,{children:["The list of schedulable tasks is in ",(0,i.jsx)(s.code,{children:"src/dbos/tasks.ts"}),". The ",(0,i.jsx)(s.code,{children:"schedulableTasks"})," array contains the available tasks, with information needed for ",(0,i.jsx)(s.code,{children:"doTaskFetch"})," to execute them.  Tasks can be added by expanding the array with additional entries:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  {\n    id: 'fetch_joke', // Unique ID for the task\n    name: 'Fetch Random Joke', // Text label the task\n    url: 'https://official-joke-api.appspot.com/random_joke', // URL to fetch when the task runs\n    type: 'json', // Type of result to expect from the task\n  },\n"})}),"\n",(0,i.jsx)(s.h3,{id:"main-workflow",children:"Main Workflow"}),"\n",(0,i.jsxs)(s.p,{children:["The main workflow for executing tasks is in ",(0,i.jsx)(s.code,{children:"src/dbos/operations.ts"}),", in the ",(0,i.jsx)(s.code,{children:"SchedulerOps"})," class:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.workflow()\n  static async runJob(sched: string, task: string, time: Date) {\n    DBOS.logger.info(`Running ${task} at ${time.toString()}`);\n\n    let resstr = \"\";\n    let errstr = \"\";\n\n    try {\n      // Fetch the result\n      const res = await SchedulerOps.runTask(task);\n      resstr = res;\n\n      // Store result in database\n      await ScheduleDBOps.setResult(sched, task, time, res, '');\n    }\n    catch (e) {\n      const err = e as Error;\n      // Store error in database\n      await ScheduleDBOps.setResult(sched, task, time, '', err.message);\n      errstr = err.message;\n    }\n\n    // Tell attached clients\n    SchedulerOps.notifyListeners('result');\n\n    // Send notification\n    await SchedulerOps.sendStatusEmail(\n      errstr ? `Task ${task} failed` : `Task ${task} result`,\n      errstr || resstr\n    );\n  }\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Because it is a ",(0,i.jsx)(s.code,{children:"@DBOS.workflow"}),", ",(0,i.jsx)(s.code,{children:"runJob"})," will be ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/workflow-tutorial",children:"executed durably"}),".  That is, if the server crashes after ",(0,i.jsx)(s.code,{children:"runTask"})," is complete, but the result hasn't been recorded in the database with ",(0,i.jsx)(s.code,{children:"setResult"}),", or if the email hasn't been sent by ",(0,i.jsx)(s.code,{children:"sendStatusEmail"}),", DBOS Transact will finish the workflow during recovery and execute those steps."]}),"\n",(0,i.jsx)(s.h3,{id:"scheduling",children:"Scheduling"}),"\n",(0,i.jsxs)(s.p,{children:["Scheduling a workflow in DBOS is quite simple; simply affix the ",(0,i.jsxs)(s.a,{href:"https://docs.dbos.dev/typescript/tutorials/scheduled-workflows",children:[(0,i.jsx)(s.code,{children:"@DBOS.scheduled"})," decorator"]}),".  The ",(0,i.jsx)(s.code,{children:"crontab"})," of ",(0,i.jsx)(s.code,{children:"'* * * * *'"})," will cause ",(0,i.jsx)(s.code,{children:"runSchedule"})," to execute every minute, and ",(0,i.jsx)(s.code,{children:"runSchedule"})," will check the database for tasks to execute."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.scheduled({crontab: '* * * * *', mode: SchedulerMode.ExactlyOncePerIntervalWhenActive })\n  @DBOS.workflow()\n  static async runSchedule(schedTime: Date, _atTime: Date) {\n    // Retrieve schedule from database\n    const schedule = await ScheduleDBOps.getSchedule();\n    for (const sched of schedule) {\n      // See if this schedule should be triggered now\n      const occurrences = getOccurrencesAt(sched, schedTime);\n      for (const occurrence of occurrences) {\n        // Start each job in the background\n        await DBOS.startWorkflow(SchedulerOps).runJob(sched.id, sched.task, occurrence);\n      }\n    }\n  }\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Note that the use of ",(0,i.jsx)(s.code,{children:"mode: SchedulerMode.ExactlyOncePerIntervalWhenActive"})," means that makeup work will not be performed if DBOS is down at the time that tasks are scheduled.  To make up for missed intervals, ensuring the scheduled workflows run exactly once, use ",(0,i.jsx)(s.code,{children:"mode: SchedulerMode.ExactlyOncePerInterval"}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"database-schema-and-transactions",children:"Database Schema and Transactions"}),"\n",(0,i.jsxs)(s.p,{children:["DBOS Task Scheduler stores its schedule and results data in a Postgres database using ",(0,i.jsx)(s.a,{href:"https://knexjs.org/",children:"Knex"}),".  The code for the transactions resides in ",(0,i.jsx)(s.code,{children:"src/dbos/dbtransactions.ts"}),".  For example, the ",(0,i.jsx)(s.code,{children:"getSchedule"})," method in ",(0,i.jsx)(s.code,{children:"ScheduleDBOps"})," retrieves the entire schedule from the database:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.transaction({readOnly: true})\n  static async getSchedule() {\n    return await DBOS.knexClient<ScheduleRecord>('schedule').select();\n  }\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Note that the transaction function is decorated with ",(0,i.jsx)(s.a,{href:"https://docs.dbos.dev/typescript/tutorials/transaction-tutorial",children:(0,i.jsx)(s.code,{children:"@DBOS.transaction"})}),".  The ",(0,i.jsx)(s.code,{children:"ScheduleRecord"})," has been defined in ",(0,i.jsx)(s.code,{children:"src/types/models.ts"})," and is applied to the query for type checking."]}),"\n",(0,i.jsxs)(s.p,{children:["The database schema, which defines the ",(0,i.jsx)(s.code,{children:"schedule"})," table, can be found in ",(0,i.jsx)(s.code,{children:"migrations/20250122121006_create_calendar_tables/.js"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-javascript",children:"exports.up = function(knex) {\n  return knex.schema\n    .createTable('schedule', (table) => {\n      table.uuid('id').primary().defaultTo(knex.raw('gen_random_uuid()'));  // Use UUID as primary key\n      table.string('task').notNullable();  // Task ID\n      table.datetime('start_time').notNullable();  // Scheduled time\n      table.datetime('end_time').notNullable();  // Scheduled time\n      table.string('repeat').notNullable();  // Repetition options\n      table.timestamps(true, true);  // Adds created_at and updated_at timestamps\n    })\n    //...\n};\n"})}),"\n",(0,i.jsxs)(s.p,{children:["These migrations will be run by ",(0,i.jsx)(s.code,{children:"npx dbos migrate"}),", because Knex migrations are indicated in ",(0,i.jsx)(s.code,{children:"dbos-config.yaml"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:"  migrate:\n    - npx knex migrate:latest\n"})}),"\n",(0,i.jsx)(s.h3,{id:"sending-email-with-amazon-ses",children:"Sending Email with Amazon SES"}),"\n",(0,i.jsxs)(s.p,{children:["The optional sending of task results emails is done using Amazon SES, and the ",(0,i.jsx)(s.a,{href:"../reference/libraries#simple-email-service-ses",children:"@dbos-inc/dbos-email-ses"})," package."]}),"\n",(0,i.jsxs)(s.p,{children:["All that is necessary, as shown in ",(0,i.jsx)(s.code,{children:"src/dbos/operations.ts"}),", is to configure the email instance (using environment variables):"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"if (!globalThis.reportSes && (process.env['REPORT_EMAIL_TO_ADDRESS'] && process.env['REPORT_EMAIL_FROM_ADDRESS'])) {\n  globalThis.reportSes = new DBOS_SES('reportSES', {awscfgname: 'aws_config'});\n}\n"})}),"\n",(0,i.jsxs)(s.p,{children:["And then call ",(0,i.jsx)(s.code,{children:"send"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  static async sendStatusEmail(subject: string, body: string) {\n    if (!globalThis.reportSes) return;\n    await globalThis.reportSes.sendEmail({\n      to: [process.env['REPORT_EMAIL_TO_ADDRESS']!],\n      from: process.env['REPORT_EMAIL_FROM_ADDRESS']!,\n      subject: subject,\n      bodyText: body,\n    });\n  }\n"})}),"\n",(0,i.jsx)(s.h2,{id:"ui",children:"UI"}),"\n",(0,i.jsxs)(s.p,{children:["The user interface for DBOS Task Scheduler is built on React, with ",(0,i.jsx)(s.a,{href:"https://mui.com",children:"Material"})," and ",(0,i.jsx)(s.a,{href:"https://github.com/jquense/react-big-calendar",children:"react-big-calendar"}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"ui-components",children:"UI Components"}),"\n",(0,i.jsxs)(s.p,{children:["The app-specific UI components can be found in ",(0,i.jsx)(s.code,{children:"src/app/components/*.tsx"}),", with the overall layout established in ",(0,i.jsx)(s.code,{children:"src/app/layout.tsx"})," and ",(0,i.jsx)(s.code,{children:"src/app/page.tsx"}),".  Nothing in these components is particularly notable; they just use core React/Next.js constructs."]}),"\n",(0,i.jsx)(s.h3,{id:"server-actions",children:"Server Actions"}),"\n",(0,i.jsxs)(s.p,{children:["One of the key benefits of Next.js over straight React is ",(0,i.jsx)(s.a,{href:"https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations",children:"server actions"}),".  Server actions provide an easy way for the UI to call code on the server, without specifying the API."]}),"\n",(0,i.jsxs)(s.p,{children:["Within DBOS Task Scheduler, server actions are used for updating the calendar tasks, and fetching results.  The action code can be found in ",(0,i.jsx)(s.code,{children:"src/actions/schedule.ts"}),".  For example, ",(0,i.jsx)(s.code,{children:"ScheduleForm.tsx"})," calls the ",(0,i.jsx)(s.code,{children:"addSchedule"})," server action:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"// Add a new schedule item\nexport async function addSchedule(task: string, start: Date, end: Date, repeat: string) {\n  const res = await ScheduleDBOps.addScheduleItem(task, start, end, repeat);\n  // Tell attached clients\n  SchedulerOps.notifyListeners('schedule');\n  return res;\n}\n"})}),"\n",(0,i.jsxs)(s.p,{children:["This server action will in turn call DBOS.  Note that ",(0,i.jsx)(s.code,{children:"addSchedule"})," involves a remote method invocation provided by Next.js, as the ",(0,i.jsx)(s.code,{children:"ScheduleForm"})," is rendered on the client, and ",(0,i.jsx)(s.code,{children:"addSchedule"})," is processed on the server."]}),"\n",(0,i.jsx)(s.h3,{id:"api-routes",children:"API Routes"}),"\n",(0,i.jsx)(s.p,{children:"While server actions are convenient, they are only available to Next.js clients.  For cases where other clients should have access to the API, Next.js offers API routes."}),"\n",(0,i.jsxs)(s.p,{children:["One author of DBOS Task Scheduler wanted to fetch boredom-relieving tasks from ",(0,i.jsx)(s.a,{href:"https://www.boredapi.com/",children:"Bored API"}),".  While this API was unfortunately down at the time the demo was written, this presents an opportunity to write a replacement API as part of the app."]}),"\n",(0,i.jsxs)(s.p,{children:["First, the list of available activities was copied and added to ",(0,i.jsx)(s.code,{children:"src/app/bored/db/activities.ts"}),".  Then the following code was set up in ",(0,i.jsx)(s.code,{children:"src/app/api/boredactivity/route.ts"})," to handle the GET request for ",(0,i.jsx)(s.code,{children:"api/boredactivity"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"import { dbosBored } from '@/actions/bored';\nimport { NextResponse } from 'next/server';\n\nexport async function GET() {\n  const dbb = await dbosBored();\n  return NextResponse.json(dbb);\n}\n"})}),"\n",(0,i.jsx)(s.p,{children:"This route code then calls into the server action code:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:'import { DBOSBored } from "@/dbos/operations";\n\nexport async function dbosBored() {\n  return await DBOSBored.getActivity();\n}\n'})}),"\n",(0,i.jsx)(s.p,{children:"Which in turn calls the DBOS logic:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"export class DBOSBored {\n  @DBOS.workflow()\n  static async getActivity() : Promise<Activity> {\n    const choice = Math.floor(await DBOSRandom.random() * activities.length);\n    return activities[choice];\n  }\n}\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Note that while this successfully registers the ",(0,i.jsx)(s.code,{children:"/api/boredactivity"})," endpoint, it is fortunate that this API is simple... there is no API description or type checking code provided when using this method."]}),"\n",(0,i.jsx)(s.h3,{id:"dbos-routes",children:"DBOS Routes"}),"\n",(0,i.jsx)(s.p,{children:"DBOS provides a much simpler way to register API endpoints."}),"\n",(0,i.jsxs)(s.p,{children:["By simply decorating a method with ",(0,i.jsx)(s.a,{href:"https://docs.dbos.dev/typescript/tutorials/requestsandevents/http-serving-tutorial",children:(0,i.jsx)(s.code,{children:"@DBOS.getAPI"})}),", the API will be available, with built-in type checking, and available for OpenAPI support.  The following registers the API at ",(0,i.jsx)(s.code,{children:"/dbos/boredapi/activity"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  @DBOS.getApi('/dbos/boredapi/activity')\n  static async boredAPIActivity() {\n    return await DBOSBored.getActivity();\n  }\n"})}),"\n",(0,i.jsx)(s.h3,{id:"websockets",children:"WebSockets"}),"\n",(0,i.jsx)(s.p,{children:"Another thing that is not generally possible in Next.js is real-time updates to the client.  In DBOS Task Scheduler, the client calendar should be updated when new task results arrive, or if another user alters the calendar.  While this can be achieved with polling, we can use WebSockets in DBOS."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  static notifyListeners(type: string) {\n    const gss = globalThis.webSocketClients;\n    DBOS.logger.debug(`WebSockets: Sending update '${type}' to ${gss?.size} clients`);\n    gss?.forEach((client) => {\n      if (client.readyState === WebSocket.OPEN) {\n        client.send(JSON.stringify({type}));\n      }\n    });\n  }\n"})}),"\n",(0,i.jsx)(s.h3,{id:"database-notifications",children:"Database Notifications"}),"\n",(0,i.jsx)(s.p,{children:"While WebSockets can be used to deliver notifications from DBOS to the client, a challenge arises if the database update was running on another virtual machine in the application group.  To detect this, we can watch for changes in the underlying database table, and use those updates to broadcast notifications to the WebSockets."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  @DBTrigger({tableName: 'schedule', useDBNotifications: true, installDBTrigger: true})\n  static async scheduleListener(_operation: TriggerOperation, _key: string[], _record: unknown) {\n    SchedulerOps.notifyListeners('schedule');\n    return Promise.resolve();\n  }\n"})}),"\n",(0,i.jsx)(s.h3,{id:"nextjs-custom-server",children:"Next.js Custom Server"}),"\n",(0,i.jsxs)(s.p,{children:['While many Next.js applications are "serverless", several of the features in DBOS Task Scheduler require a ',(0,i.jsx)(s.a,{href:"../../integrations/adding-dbos-to-next#adding-serverts-to-a-project",children:'"custom server"'}),".  This file, located in ",(0,i.jsx)(s.code,{children:"src/server.ts"}),", handles the following:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Sets up all DBOS application code so that it is all available before serving requests."}),"\n",(0,i.jsx)(s.li,{children:"Launches DBOS, which starts any necessary workflow recovery."}),"\n",(0,i.jsx)(s.li,{children:"Creates an HTTP server with the WebSockets extension."}),"\n",(0,i.jsxs)(s.li,{children:["Directs any requests starting with ",(0,i.jsx)(s.code,{children:"/dbos"})," to DBOS handler logic, allowing DBOS routing to function alongside Next.js"]}),"\n"]}),"\n",(0,i.jsx)(s.h4,{id:"loading-dbos-logic",children:"Loading DBOS Logic"}),"\n",(0,i.jsxs)(s.p,{children:["Code for DBOS steps, transactions, workflows, queues, and configured instances should be loaded before DBOS is launched.  Two approaches are demonstrated in ",(0,i.jsx)(s.code,{children:"src/server.ts"}),":"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Import and use the modules from within ",(0,i.jsx)(s.code,{children:"server.ts"}),":"]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"import { SchedulerOps  } from './dbos/operations';\n...\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Load the files dynamically with a utility function that finds them:"}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"export async function loadAllDBOSServerFiles() {\n  ...\n}\n"})}),"\n",(0,i.jsx)(s.h4,{id:"configuring-dbos-optional",children:"Configuring DBOS (Optional)"}),"\n",(0,i.jsxs)(s.p,{children:["By default, DBOS will configure itself by loading ",(0,i.jsx)(s.a,{href:"/typescript/reference/configuration",children:(0,i.jsx)(s.code,{children:"dbos-config.yaml"})}),".  To override this behavior, set the configuration before launching DBOS:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"const [cfg, rtcfg] = parseConfigFile();\nDBOS.setConfig(cfg, rtcfg);\n"})}),"\n",(0,i.jsx)(s.h4,{id:"launching-dbos",children:"Launching DBOS"}),"\n",(0,i.jsx)(s.p,{children:"Once all code has been loaded, and DBOS is configured, launch DBOS.  This"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  await DBOS.launch();\n"})}),"\n",(0,i.jsx)(s.h4,{id:"starting-the-nextjs-server",children:"Starting the Next.js Server"}),"\n",(0,i.jsx)(s.p,{children:"Once DBOS is launched and ready to serve requests, start the Next.js server."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"const dev = process.env.NODE_ENV !== 'production';\nconst app = next({ dev });\n\nasync function main() {\n  // Launch DBOS first\n  //...\n\n  // Then start Next.js\n  await app.prepare();\n  const handle = app.getRequestHandler();\n  const server = http.createServer((req, res) => {\n    handle(req, res as ServerResponse<IncomingMessage>);\n  })\n\n  const PORT = DBOS.runtimeConfig?.port ?? 3000;\n  const ENV = process.env.NODE_ENV || 'development';\n\n  server.listen(PORT, () => {\n    DBOS.logger.info(`\ud83d\ude80 Server is running on http://localhost:${PORT}`);\n    DBOS.logger.info(`\ud83c\udf1f Environment: ${ENV}`);\n  });\n}\n\n// Only start the server when this file is run directly from Node\nif (require.main === module) {\n  main().catch(console.log);\n}\n"})}),"\n",(0,i.jsx)(s.h4,{id:"setting-up-dbos-routes-optional",children:"Setting up DBOS Routes (optional)"}),"\n",(0,i.jsxs)(s.p,{children:["If you expect to use ",(0,i.jsx)(s.a,{href:"/typescript/tutorials/requestsandevents/http-serving-tutorial",children:"DBOS HTTP Decorators"}),", add a provision for these to your server configuration when you create it.  In this example, we hand any request with a URL under ",(0,i.jsx)(s.code,{children:"/dbos"})," to DBOS, but you can implement your own logic:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  // Create HTTP server\n  const server = http.createServer((req, res) => {\n    if (req.url?.startsWith('/dbos')) {\n      // Pass API routes to DBOS\n      DBOS.getHTTPHandlersCallback()!(req, res);\n    }\n    else {\n      // Pass rest of the routes to Next.js\n      handle(req, res as ServerResponse<IncomingMessage>);\n    }\n  })\n"})}),"\n",(0,i.jsx)(s.h4,{id:"setting-up-websockets-optional",children:"Setting up WebSockets (optional)"}),"\n",(0,i.jsx)(s.p,{children:"As part of server setup, before server listening is started, add WebSockets functionality to the server:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  // Create WebSocket server\n  const wss = new WebSocketServer({ noServer: true });\n  const gss: Set<WebSocket> = new Set();\n  globalThis.webSocketClients = gss;\n  wss.on('connection', (ws: WebSocket) => {\n    DBOS.logger.debug('Client connected to WebSocket');\n    gss.add(ws);\n    DBOS.logger.debug(`${gss.size} clients`);\n\n    ws.send(JSON.stringify({ type: 'connected' }));\n\n    ws.on('message', (_data) => {\n      ws.send(JSON.stringify({ type: 'received' }));\n    });\n\n    ws.on('close', () => {\n      gss.delete(ws);\n      DBOS.logger.info('Client disconnected');\n    });\n  });\n\n  // Register WebSocket server under /ws\n  // Upgrade HTTP to WebSocket when hitting `/ws`\n  server.on('upgrade', (request, socket, head) => {\n    if (request.url === '/ws') {\n      wss.handleUpgrade(request, socket, head, (ws) => {\n        wss.emit('connection', ws, request);\n      });\n    } else {\n      socket.destroy(); // Reject unknown upgrade requests\n    }\n  });\n\n  // Proceed to start sderver...\n"})}),"\n",(0,i.jsxs)(s.h4,{id:"the-importance-of-globalthis",children:["The Importance of ",(0,i.jsx)(s.code,{children:"globalThis"})]}),"\n",(0,i.jsxs)(s.p,{children:['Next.js creates multiple "bundles" that contain minimized code for handling each request type.  These bundles have their own copies of what would otherwise be "global" variables.  If you intend to share data across bundles and with the DBOS logic in ',(0,i.jsx)(s.code,{children:"server.ts"}),", you should use ",(0,i.jsx)(s.a,{href:"../../integrations/adding-dbos-to-next#using-globalthis",children:(0,i.jsx)(s.code,{children:"globalThis"})})," or a similar construct."]}),"\n",(0,i.jsx)(s.h2,{id:"configuration-files",children:"Configuration Files"}),"\n",(0,i.jsx)(s.p,{children:"DBOS Task Scheduler relies on a significant number of configuration files.  While an exhaustive treatment is not possible, the following sections describe some of more important bits."}),"\n",(0,i.jsx)(s.h3,{id:"packagejson",children:(0,i.jsx)(s.code,{children:"package.json"})}),"\n",(0,i.jsxs)(s.p,{children:["As is customary, ",(0,i.jsx)(s.code,{children:"package.json"})," contains a list of the project's dependencies, for use by ",(0,i.jsx)(s.code,{children:"npm"})," or other package managers."]}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"package.json"})," also includes the following scripts that are worth mentioning:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-json",children:'  "scripts": {\n    "dev": "npx dbos migrate && nodemon",\n    "build": "tsc && next build",\n    "start": "NODE_ENV=production node dist/src/server.js",\n    "test": "npx dbos migrate && jest --detectOpenHandles",\n    "lint": "next lint --fix"\n  },\n'})}),"\n",(0,i.jsx)(s.h4,{id:"npm-run-dev",children:"npm run dev"}),"\n",(0,i.jsxs)(s.p,{children:["This script starts DBOS Task Scheduler in development mode, where code changes cause the server to automatically reload / restart.  This script automatically applies any database migrations, and uses a combination of ",(0,i.jsx)(s.code,{children:"nodemon"})," and Next.js to handle code updates."]}),"\n",(0,i.jsx)(s.h5,{id:"nodemonjson",children:(0,i.jsx)(s.code,{children:"nodemon.json"})}),"\n",(0,i.jsxs)(s.p,{children:["While Next.js is quite good at handling updates to UI components and API routes, updates to DBOS code cannot be made incrementally.  For this reason, ",(0,i.jsx)(s.code,{children:"nodemon"})," is set to watch the ",(0,i.jsx)(s.code,{children:"dbos"})," directory, and restart the server if anything changes:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-json",children:'{\n  "watch": ["src/dbos/", "migrations/"],\n  "ext": "ts,js,tsx,jsx",\n  "ignore": ["src/**/*.test.ts"],\n  "exec": "tsc && node dist/src/server.js"\n}\n'})}),"\n",(0,i.jsx)(s.h4,{id:"npm-run-build--start",children:"npm run build / start"}),"\n",(0,i.jsxs)(s.p,{children:['These targets build and start a "production" build of DBOS Task Scheduler.  This runs the ',(0,i.jsx)(s.code,{children:"next"})," and ",(0,i.jsx)(s.code,{children:"tsc"})," compilation processes, to produce client bundles, and server code."]}),"\n",(0,i.jsx)(s.h4,{id:"npm-run-lint",children:"npm run lint"}),"\n",(0,i.jsxs)(s.p,{children:["This script checks the code for common errors, using ",(0,i.jsx)(s.a,{href:"https://eslint.org/",children:(0,i.jsx)(s.code,{children:"eslint"})})," and typical settings for a Next.js project.  There are some specific configuration overrides in ",(0,i.jsx)(s.code,{children:"eslint.config.mjs"}),"."]}),"\n",(0,i.jsx)(s.h5,{id:"eslintconfigmjs",children:(0,i.jsx)(s.code,{children:"eslint.config.mjs"})}),"\n",(0,i.jsxs)(s.p,{children:["This file contains the ",(0,i.jsx)(s.code,{children:"eslint"}),' configuration.  This is based on the "next/core-web-vitals" and "next/typescript" settings, with an additional override to ignore unused variables, as long as the names are prefixed with ',(0,i.jsx)(s.code,{children:"_"}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"tsconfigjson",children:(0,i.jsx)(s.code,{children:"tsconfig.json"})}),"\n",(0,i.jsxs)(s.p,{children:["For DBOS code and ",(0,i.jsx)(s.code,{children:"server.ts"})," to compile properly, some ",(0,i.jsx)(s.code,{children:"tsconfig.json"})," settings are required.  This project was set up according to ",(0,i.jsx)(s.a,{href:"../../integrations/adding-dbos-to-next#compilation-settings-for-dbos-code",children:'"Compilation Settings For DBOS Code"'}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"nextconfigts",children:(0,i.jsx)(s.code,{children:"next.config.ts"})}),"\n",(0,i.jsxs)(s.p,{children:["It is ",(0,i.jsx)(s.a,{href:"../../integrations/adding-dbos-to-next#preventing-bundling",children:"important keep the DBOS library, and any workflow functions or other code used by DBOS, external to Next.js bundles"}),".  This prevents incomplete, duplicate, and incorrect registration of functions.  For this project, we import all DBOS logic with the prefix ",(0,i.jsx)(s.code,{children:"@dbos/"}),", and ask the bundler to treat such files as external:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:'  webpack: (config, { isServer, dev: _dev }) => {\n    if (isServer) {\n      config.externals = [\n        ...config.externals,\n        {\n          // highlight-next-line\n          "@dbos-inc/dbos-sdk": "commonjs @dbos-inc/dbos-sdk",    // Treat @dbos-inc/dbos-sdk as external\n        },\n        // highlight-next-line\n        /^@dbos\\/.+$/, // Treat ALL `@dbos/*` imports (from src/dbos) as external\n      ];\n    }\n\n    return config;\n  },\n'})}),"\n",(0,i.jsx)(s.p,{children:"To allow server actions to work in DBOS Cloud, the following was added:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-typescript",children:"  experimental: {\n    serverActions: {\n      allowedOrigins: ['*.cloud.dbos.dev'], // Allow DBOS Cloud to call server actions\n    },\n  },\n"})}),"\n",(0,i.jsx)(s.h3,{id:"dbos-configyaml",children:(0,i.jsx)(s.code,{children:"dbos-config.yaml"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.a,{href:"https://docs.dbos.dev/typescript/reference/configuration",children:(0,i.jsx)(s.code,{children:"dbos-config.yaml"})})," sets up important operational aspects, such as the database migration scripts and the environment variables for sending email."]}),"\n",(0,i.jsx)(s.h3,{id:"knexfilets",children:(0,i.jsx)(s.code,{children:"knexfile.ts"})}),"\n",(0,i.jsx)(s.p,{children:"This file is used to establish a database connection for running migrations."}),"\n",(0,i.jsx)(s.h3,{id:"jestconfigjs",children:(0,i.jsx)(s.code,{children:"jest.config.js"})}),"\n",(0,i.jsxs)(s.p,{children:["This file supports running ",(0,i.jsx)(s.code,{children:"jest"})," (via ",(0,i.jsx)(s.code,{children:"npm run test"}),")."]}),"\n",(0,i.jsx)(s.h3,{id:"gitignore",children:(0,i.jsx)(s.code,{children:".gitignore"})}),"\n",(0,i.jsx)(s.p,{children:"This is a list of paths, files, and filename patterns that are not to be kept in version control."}),"\n",(0,i.jsx)(s.p,{children:"While this is mostly a template for Next.js, the following entries are specific to this project:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:".dbos"}),"\n",(0,i.jsx)(s.li,{children:"dbos_deploy/"}),"\n",(0,i.jsx)(s.li,{children:"node_modules/"}),"\n",(0,i.jsx)(s.li,{children:"dist/"}),"\n",(0,i.jsx)(s.li,{children:"*.tsbuildinfo"}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},7536:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/dbos-task-scheduler-main-24cb510f61701f15352f92217c7b697d.png"}}]);