"use strict";(self.webpackChunkoperon_docs=self.webpackChunkoperon_docs||[]).push([[543],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=l(n),f=o,d=u["".concat(c,".").concat(f)]||u[f]||m[f]||a;return n?r.createElement(d,i(i({ref:t},p),{},{components:n})):r.createElement(d,i({ref:t},p))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=f;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var l=2;l<a;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}f.displayName="MDXCreateElement"},621:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var r=n(7462),o=(n(7294),n(3905));const a={sidebar_position:2,title:"Transactions",description:"Learn how to perform database operations"},i=void 0,s={unversionedId:"tutorials/transaction-tutorial",id:"tutorials/transaction-tutorial",title:"Transactions",description:"Learn how to perform database operations",source:"@site/docs/tutorials/transaction-tutorial.md",sourceDirName:"tutorials",slug:"/tutorials/transaction-tutorial",permalink:"/operon-docs/tutorials/transaction-tutorial",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Transactions",description:"Learn how to perform database operations"},sidebar:"tutorialSidebar",previous:{title:"HTTP Serving",permalink:"/operon-docs/tutorials/http-serving-tutorial"},next:{title:"Communicators",permalink:"/operon-docs/tutorials/communicator-tutorial"}},c={},l=[],p={toc:l},u="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In this guide, you'll learn how to perform database operations in Operon."),(0,o.kt)("p",null,"In Operon, your application's database is a first-class citizen.\nTo perform operations on it, you use a ",(0,o.kt)("em",{parentName:"p"},"transaction")," function.\nAs their name implies, these functions execute as ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Database_transaction"},"database transactions"),"."),(0,o.kt)("p",null,"Transaction functions must be annotated with the ",(0,o.kt)("a",{parentName:"p",href:"../api-reference/decorators#operontransaction"},(0,o.kt)("inlineCode",{parentName:"a"},"@OperonTransaction"))," decorator and must have a ",(0,o.kt)("a",{parentName:"p",href:".."},(0,o.kt)("inlineCode",{parentName:"a"},"TransactionContext"))," as their first argument.\nLike for other Operon functions, inputs and outputs must be serializable to JSON.\nThe ",(0,o.kt)("a",{parentName:"p",href:".."},(0,o.kt)("inlineCode",{parentName:"a"},"TransactionContext"))," provides a ",(0,o.kt)("inlineCode",{parentName:"p"},".client")," field you can use to transactionally interact with the database, so you don't need to worry about managing database connections.\nBy default, this is a ",(0,o.kt)("a",{parentName:"p",href:"https://knexjs.org/"},"Knex.js")," client.\nWe like Knex because it's lightweight and helps us write fast but type-safe queries.\nHowever, if you prefer a traditional ORM, we also support ",(0,o.kt)("a",{parentName:"p",href:".."},"Prisma")," and ",(0,o.kt)("a",{parentName:"p",href:".."},"TypeORM"),"."),(0,o.kt)("p",null,"Here's an example of a transaction function (from the ",(0,o.kt)("a",{parentName:"p",href:"../getting-started/quickstart"},"quickstart"),") written using Knex:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'import { TransactionContext, OperonTransaction, GetApi, HandlerContext } from \'@dbos-inc/operon\'\nimport { Knex } from \'knex\';\n\ntype KnexTransactionContext = TransactionContext<Knex>;\n\nexport interface operon_hello {\n  name: string;\n  greet_count: number;\n}\n\nexport class Hello {\n\n  @OperonTransaction()\n  static async helloTransaction(txnCtxt: KnexTransactionContext, name: string) {\n    // Look up greet_count.\n    let greet_count = await txnCtxt.client<operon_hello>("operon_hello")\n      .select("greet_count")\n      .where({ name: name })\n      .first()\n      .then(row => row?.greet_count);\n    if (greet_count) {\n      // If greet_count is set, increment it.\n      greet_count++;\n      await txnCtxt.client<operon_hello>("operon_hello")\n        .where({ name: name })\n        .increment(\'greet_count\', 1);\n    } else {\n      // If greet_count is not set, set it to 1.\n      greet_count = 1;\n      await txnCtxt.client<operon_hello>("operon_hello")\n        .insert({ name: name, greet_count: 1 })\n    }\n    return `Hello, ${name}! You have been greeted ${greet_count} times.\\n`;\n  }\n}\n')),(0,o.kt)("p",null,"This function uses the Knex client to first look up ",(0,o.kt)("inlineCode",{parentName:"p"},"greet_count")," for an input ",(0,o.kt)("inlineCode",{parentName:"p"},"name"),", then increment it if it's already set or set it to 1 otherwise.\nOperon executes all these operations in a single transaction, so there's no need to worry about race conditions between concurrent updates.\nOperon supports the full Knex Postgres API, but doesn't allow manually committing or aborting transactions.\nInstead, transactions automatically commit when the function successfully returns and abort and roll back if the function throws an exception.\nIf you need to orchestrate multiple transactions, use a ",(0,o.kt)("a",{parentName:"p",href:"./workflow-tutorial"},"workflow"),"."))}m.isMDXComponent=!0}}]);