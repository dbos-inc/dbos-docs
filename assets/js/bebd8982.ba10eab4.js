"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[4921],{8080:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"typescript/tutorials/development/testing-tutorial","title":"Testing and Debugging","description":"Learn how to use the testing runtime for unit tests.","source":"@site/docs/typescript/tutorials/development/testing-tutorial.md","sourceDirName":"typescript/tutorials/development","slug":"/typescript/tutorials/development/testing-tutorial","permalink":"/typescript/tutorials/development/testing-tutorial","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":20,"frontMatter":{"sidebar_position":20,"title":"Testing and Debugging","description":"Learn how to use the testing runtime for unit tests."},"sidebar":"tutorialSidebar","previous":{"title":"Project Structure","permalink":"/typescript/tutorials/development/application-structure-explanation"},"next":{"title":"Using Libraries","permalink":"/typescript/tutorials/development/using-libraries"}}');var i=s(4848),r=s(8453);const o={sidebar_position:20,title:"Testing and Debugging",description:"Learn how to use the testing runtime for unit tests."},a=void 0,c={},l=[{value:"Set Up Jest",id:"set-up-jest",level:3},{value:"Launching DBOS",id:"launching-dbos",level:3},{value:"Configuring DBOS Prior To Launch",id:"configuring-dbos-prior-to-launch",level:4},{value:"Testing Functions",id:"testing-functions",level:3},{value:"Testing HTTP Endpoints",id:"testing-http-endpoints",level:3},{value:"Cleaning Up",id:"cleaning-up",level:3},{value:"Run Tests",id:"run-tests",level:3},{value:"Further Reading",id:"further-reading",level:3},{value:"DBOS TestingRuntime",id:"dbos-testingruntime",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"In this guide, you'll learn how to test your DBOS applications."}),"\n",(0,i.jsxs)(n.p,{children:["DBOS code can be easily tested in any unit-testing framework.\nWe'll show you how to write unit tests for the ",(0,i.jsx)(n.code,{children:"Hello"})," example class shipped by ",(0,i.jsx)(n.a,{href:"/typescript/reference/tools/cli#npx-dbos-inccreate",children:(0,i.jsx)(n.code,{children:"npx @dbos-inc/create"})}),", using ",(0,i.jsx)(n.a,{href:"https://jestjs.io/",children:"Jest"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"set-up-jest",children:"Set Up Jest"}),"\n",(0,i.jsx)(n.p,{children:"If you haven't already, install jest."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npm i --save-dev jest @types/jest ts-jest\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Set up a typical ",(0,i.jsx)(n.code,{children:"jest.config.js"}),", such as:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"/** @type {import('ts-jest').JestConfigWithTsJest} */\nmodule.exports = {\n  preset: 'ts-jest',\n  testEnvironment: 'node',\n  testRegex: '((\\\\.|/)(test|spec))\\\\.ts?$',\n  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node'],\n  modulePaths: ['./'],\n};\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Start a template test file, with a name such as ",(0,i.jsx)(n.code,{children:"main.test.ts"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { DBOS } from '@dbos-inc/dbos-sdk';\nimport { app, dbos_hello, Hello } from './main';\nimport request from 'supertest';\n\ndescribe('operations-test', () => {\n    // Your test will go here...\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To make it easy to run your tests, create a ",(0,i.jsx)(n.code,{children:"scripts"})," entry in ",(0,i.jsx)(n.code,{children:"package.json"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'  "scripts": {\n    "test": "npx dbos migrate && jest"\n  }\n'})}),"\n",(0,i.jsx)(n.h3,{id:"launching-dbos",children:"Launching DBOS"}),"\n",(0,i.jsx)(n.p,{children:"Before executing any test code that uses DBOS, DBOS should be launched:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"  beforeAll(async () => {\n    await DBOS.launch();\n  });\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"/typescript/reference/transactapi/dbos-class#launching-dbos",children:(0,i.jsx)(n.code,{children:"DBOS.launch"})})," for launch options."]}),"\n",(0,i.jsx)(n.h4,{id:"configuring-dbos-prior-to-launch",children:"Configuring DBOS Prior To Launch"}),"\n",(0,i.jsxs)(n.p,{children:["By default, ",(0,i.jsx)(n.code,{children:"DBOS.launch"})," loads the configuration from ",(0,i.jsx)(n.code,{children:"dbos-config.yaml"})," in the package root and uses this information to set up the runtime."]}),"\n",(0,i.jsxs)(n.p,{children:["To load configuration from a different file, or to create a configuration in another way, call ",(0,i.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#setting-the-application-configuration",children:(0,i.jsx)(n.code,{children:"DBOS.setConfig"})})," prior to launch:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"    const [cfg, rtCfg] = parseConfigFile({configfile: 'my-testing-dbos-config.yaml'});\n    DBOS.setConfig(cfg, rtCfg);\n    await DBOS.dropSystemDB(); // If you want a completely clean start\n    await DBOS.launch();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"testing-functions",children:"Testing Functions"}),"\n",(0,i.jsxs)(n.p,{children:["Once DBOS is launched, a test can invoke workflows, transactions, and steps directly.  Functions on the ",(0,i.jsxs)(n.a,{href:"../../reference/transactapi/dbos-class",children:[(0,i.jsx)(n.code,{children:"DBOS"})," class"]})," can be used to interact with workflows and check database status during the course of the test."]}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"  test('test-transaction', async () => {\n    const res = await Hello.helloTransaction('dbos');\n    expect(res).toMatch('Hello, dbos! You have been greeted');\n\n    // Check the greet count.\n    const rows = (await DBOS.queryUserDB('SELECT * FROM dbos_hello WHERE name=$1', ['dbos'])) as dbos_hello[];\n    expect(rows[0].greet_count).toBe(1);\n  });\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In this code, we invoke ",(0,i.jsx)(n.code,{children:"Hello.helloTransaction"})," with the input string ",(0,i.jsx)(n.code,{children:'"dbos"'}),", and verify its output is as expected."]}),"\n",(0,i.jsx)(n.h3,{id:"testing-http-endpoints",children:"Testing HTTP Endpoints"}),"\n",(0,i.jsxs)(n.p,{children:["If you are testing HTTP handling capabilities, these can be tested using a framework such as ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/supertest",children:"supertest"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Import the testing package:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'import request from "supertest";\n'})}),"\n",(0,i.jsx)(n.p,{children:"Launch your app's HTTP server, or launch DBOS with your app server:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"  beforeAll(async () => {\n    await DBOS.launch({ expressApp: app });\n  });\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Use the handler callback during the course of unit-testing.  In this code, we send a ",(0,i.jsx)(n.code,{children:"GET"})," request to our ",(0,i.jsx)(n.code,{children:"/greeting/dbos"})," URL and verify its response:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"  test('test-endpoint', async () => {\n    const res = await request(app).get('/greeting/dbos');\n    expect(res.statusCode).toBe(200);\n    expect(res.text).toMatch('Hello, dbos! You have been greeted');\n  });\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cleaning-up",children:"Cleaning Up"}),"\n",(0,i.jsx)(n.p,{children:"Finally, after your tests, you should clean up DBOS and release its resources:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"  afterAll(async () => {\n    await DBOS.shutdown();\n  });\n"})}),"\n",(0,i.jsx)(n.h3,{id:"run-tests",children:"Run Tests"}),"\n",(0,i.jsx)(n.p,{children:"Now let's run the tests!"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"npm run test\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["You are responsible for setting and cleaning up database tables before and after tests.\nIn our example, we run Knex migrations with ",(0,i.jsx)(n.code,{children:"npx dbos migrate"})," as part of our testing script in ",(0,i.jsx)(n.code,{children:"package.json"}),", but this could have been done within the test instead."]})}),"\n",(0,i.jsx)(n.p,{children:"You should see the test results similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:" PASS  src/main.test.ts\n  operations-test\n    \u2713 test-transaction (21 ms)\n    \u2713 test-endpoint (17 ms)\n\nTest Suites: 1 passed, 1 total\nTests:       2 passed, 2 total\nSnapshots:   0 total\nTime:        1.247 s, estimated 2 s\n"})}),"\n",(0,i.jsx)(n.h3,{id:"further-reading",children:"Further Reading"}),"\n",(0,i.jsxs)(n.p,{children:["You can find the source code for this tutorial in ",(0,i.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-transact-ts/blob/main/packages/create/templates/dbos-knex/src/main.test.ts",children:"operations.test.ts"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"dbos-testingruntime",children:"DBOS TestingRuntime"}),"\n",(0,i.jsxs)(n.p,{children:["In prior versions of the TypeScript SDK, a ",(0,i.jsx)(n.code,{children:"TestingRuntime"})," was used to set up DBOS.  This approach is obsolete."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Instead of creating a ",(0,i.jsx)(n.code,{children:"TestingRuntime"}),", just call ",(0,i.jsxs)(n.a,{href:"../../reference/transactapi/dbos-class#launching-dbos",children:[(0,i.jsx)(n.code,{children:"DBOS.setConfig()"})," and ",(0,i.jsx)(n.code,{children:"DBOS.launch()"})]})," from your tests."]}),"\n",(0,i.jsxs)(n.li,{children:["Calls to ",(0,i.jsx)(n.code,{children:"TestingRuntime"})," functions can usually be replaced with identical calls to ",(0,i.jsx)(n.a,{href:"../../reference/transactapi/dbos-class",children:(0,i.jsx)(n.code,{children:"DBOS"})})," functions."]}),"\n",(0,i.jsxs)(n.li,{children:["In most cases, application functions can be called directly within the tests.  Older app code can be invoked using ",(0,i.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#calling-workflow-functions",children:(0,i.jsx)(n.code,{children:"DBOS.invoke"})})," instead of via ",(0,i.jsx)(n.code,{children:"TestingRuntime.invoke"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var t=s(6540);const i={},r=t.createContext(i);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);