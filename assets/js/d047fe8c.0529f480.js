"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[8436],{618:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"typescript/tutorials/requestsandevents/http-serving-tutorial","title":"HTTP Serving","description":"Learn how to serve HTTP requests","source":"@site/docs/typescript/tutorials/requestsandevents/http-serving-tutorial.md","sourceDirName":"typescript/tutorials/requestsandevents","slug":"/typescript/tutorials/requestsandevents/http-serving-tutorial","permalink":"/typescript/tutorials/requestsandevents/http-serving-tutorial","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10,"title":"HTTP Serving","description":"Learn how to serve HTTP requests"},"sidebar":"tutorialSidebar","previous":{"title":"Using Instantiated Objects","permalink":"/typescript/tutorials/instantiated-objects"},"next":{"title":"Integrating with Kafka","permalink":"/typescript/tutorials/requestsandevents/kafka-integration"}}');var t=s(4848),a=s(8453);const i={sidebar_position:10,title:"HTTP Serving",description:"Learn how to serve HTTP requests"},o=void 0,d={},c=[{value:"Inputs and HTTP Requests",id:"inputs-and-http-requests",level:3},{value:"1. URL Path Parameters",id:"1-url-path-parameters",level:4},{value:"2. URL Query String Parameters",id:"2-url-query-string-parameters",level:4},{value:"3. HTTP Body Fields",id:"3-http-body-fields",level:4},{value:"Raw Requests",id:"raw-requests",level:4},{value:"Outputs and HTTP Responses",id:"outputs-and-http-responses",level:3},{value:"Handlers",id:"handlers",level:3},{value:"Body Parser",id:"body-parser",level:3},{value:"CORS",id:"cors",level:3},{value:"Middleware",id:"middleware",level:3},{value:"Global Middleware",id:"global-middleware",level:3},{value:"Serving Static Content",id:"serving-static-content",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["In this guide, you'll learn how to make DBOS applications accessible through DBOS's built-in, ",(0,t.jsx)(n.a,{href:"https://koajs.com/",children:"koa"}),"-based HTTP server."]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"There is no need to use the DBOS HTTP server.  DBOS functions can be embedded in other HTTP servers, and there is no need to use HTTP in DBOS applications at all.  However, the DBOS HTTP handler service is the simplest way to get started in a new HTTP application, offering simple route handling, parameter parsing and validation, security, logging, etc."})}),"\n",(0,t.jsxs)(n.p,{children:["Any function can be made into an HTTP endpoint by annotating it with an ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#http-handling",children:"endpoint decorator"}),", causing DBOS to use that function to serve that endpoint."]}),"\n",(0,t.jsxs)(n.p,{children:["You can apply an endpoint decorator either to a new function without any other decorators or to an existing function with a ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbostransaction",children:(0,t.jsx)(n.code,{children:"@DBOS.transaction"})}),", ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosworkflow",children:(0,t.jsx)(n.code,{children:"@DBOS.workflow"})}),", or ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosstep",children:(0,t.jsx)(n.code,{children:"DBOS.step"})})," decorator."]}),"\n",(0,t.jsx)(n.p,{children:"Here's an example of a new function with an endpoint decorator:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/greeting/:name')\nstatic async greetingEndpoint(name: string) {\n  return `Greeting, ${name}`;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Here's an example applying an endpoint decorator to an existing transaction (the order of the decorators doesn't matter):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@DBOS.postApi('/greeting/:friend')\n@DBOS.transaction()\nstatic async insertGreeting(friend: string, note: string) {\n  await DBOS.knexClient.raw('INSERT INTO greetings (name, note) VALUES (?, ?)', [friend, note]);\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["DBOS provides endpoint decorators for all HTTP verbs used in APIs: ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosgetapi",children:(0,t.jsx)(n.code,{children:"@DBOS.getApi"})}),", ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospostapi",children:(0,t.jsx)(n.code,{children:"@DBOS.postApi"})}),", ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosputapi",children:(0,t.jsx)(n.code,{children:"@DBOS.putApi"})}),", ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospatchapi",children:(0,t.jsx)(n.code,{children:"@DBOS.patchApi"})}),", and ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosdeleteapi",children:(0,t.jsx)(n.code,{children:"@DBOS.deleteApi"})}),".\nEach associates a function with an HTTP URL."]}),"\n",(0,t.jsx)(n.h3,{id:"inputs-and-http-requests",children:"Inputs and HTTP Requests"}),"\n",(0,t.jsx)(n.p,{children:"When a function has arguments other than its context, DBOS automatically parses them from the HTTP request, and returns an error to the client if they are not found."}),"\n",(0,t.jsx)(n.p,{children:"Arguments can be parsed from three places:"}),"\n",(0,t.jsx)(n.h4,{id:"1-url-path-parameters",children:"1. URL Path Parameters"}),"\n",(0,t.jsxs)(n.p,{children:["You can include a path parameter placeholder in a URL by prefixing it with a colon, like ",(0,t.jsx)(n.code,{children:"name"})," in this example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/greeting/:name')\nstatic async greetingEndpoint(name: string) {\n  return `Greeting, ${name}`;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Then, give your method an argument with a matching name (such as ",(0,t.jsx)(n.code,{children:"name: string"})," above) and it is automatically parsed from the path parameter."]}),"\n",(0,t.jsxs)(n.p,{children:["For example, if we send our app this request, then our method is called with ",(0,t.jsx)(n.code,{children:"name"})," set to ",(0,t.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"GET /greeting/dbos\n"})}),"\n",(0,t.jsx)(n.h4,{id:"2-url-query-string-parameters",children:"2. URL Query String Parameters"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosgetapi",children:(0,t.jsx)(n.code,{children:"GET"})})," and ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosdeleteapi",children:(0,t.jsx)(n.code,{children:"DELETE"})})," endpoints automatically parse arguments from query strings."]}),"\n",(0,t.jsxs)(n.p,{children:["For example, the following endpoint expects the ",(0,t.jsx)(n.code,{children:"id"})," and ",(0,t.jsx)(n.code,{children:"name"})," parameters to be passed through a query string:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/example')\nstatic async exampleGet(id: number, name: string) {\n  return `${id} and ${name} are parsed from URL query string parameters`;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If we send our app this request, then our method is called with ",(0,t.jsx)(n.code,{children:"id"})," set to ",(0,t.jsx)(n.code,{children:"123"})," and ",(0,t.jsx)(n.code,{children:"name"})," set to ",(0,t.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"GET /example?id=123&name=dbos\n"})}),"\n",(0,t.jsx)(n.h4,{id:"3-http-body-fields",children:"3. HTTP Body Fields"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospostapi",children:(0,t.jsx)(n.code,{children:"POST"})}),", ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospatchapi",children:(0,t.jsx)(n.code,{children:"PATCH"})}),", and ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosputapi",children:(0,t.jsx)(n.code,{children:"PUT"})})," endpoints automatically parse arguments from the HTTP request body."]}),"\n",(0,t.jsxs)(n.p,{children:["For example, the following endpoint expects the ",(0,t.jsx)(n.code,{children:"id"})," and ",(0,t.jsx)(n.code,{children:"name"})," parameters to be passed through the HTTP request body:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"@DBOS.postApi('/example')\nstatic async examplePost(id: number, name: string) {\n  return `${id} and ${name} are parsed from the HTTP request body`;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If we send our app this request, then our method is called with ",(0,t.jsx)(n.code,{children:"id"})," set to ",(0,t.jsx)(n.code,{children:"123"})," and ",(0,t.jsx)(n.code,{children:"name"})," set to ",(0,t.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'POST /example\nContent-Type: application/json\n\n{\n  "name": "dbos",\n  "id": 123\n}\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["When sending an HTTP request with a JSON body, make sure you set the ",(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type",children:(0,t.jsx)(n.code,{children:"Content-Type"})})," header to ",(0,t.jsx)(n.code,{children:"application/json"}),"."]})}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsx)(n.p,{children:"No matter where arguments are parsed from, if arguments are not supplied or are of the wrong type, the endpoint will throw an input validation error."}),(0,t.jsxs)(n.p,{children:["You can specify that an argument is optional with the ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/oldapi/decorators#argoptional",children:(0,t.jsx)(n.code,{children:"@ArgOptional"})})," parameter decorator."]})]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["You can use the ",(0,t.jsx)(n.a,{href:"/typescript/reference/transactapi/oldapi/decorators#argsource",children:(0,t.jsx)(n.code,{children:"@ArgSource()"})})," parameter decorator to parse an argument from a non-default location (for example, from a query string in a ",(0,t.jsx)(n.code,{children:"POST"})," handler)."]})}),"\n",(0,t.jsx)(n.h4,{id:"raw-requests",children:"Raw Requests"}),"\n",(0,t.jsxs)(n.p,{children:["If you need finer-grained request parsing, any DBOS method invoked via HTTP request can access raw request information from ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#accessing-http-context",children:(0,t.jsx)(n.code,{children:"DBOS.request"})}),". This returns the following information:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface HTTPRequest {\n  readonly headers?: IncomingHttpHeaders;  // A node's http.IncomingHttpHeaders object.\n  readonly rawHeaders?: string[];          // Raw headers.\n  readonly params?: unknown;               // Parsed path parameters from the URL.\n  readonly body?: unknown;                 // parsed HTTP body as an object.\n  readonly rawBody?: string;               // Unparsed raw HTTP body string.\n  readonly query?: ParsedUrlQuery;         // Parsed query string.\n  readonly querystring?: string;           // Unparsed raw query string.\n  readonly url?: string;                   // Request URL.\n  readonly ip?: string;                    // Request remote address.\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"outputs-and-http-responses",children:"Outputs and HTTP Responses"}),"\n",(0,t.jsxs)(n.p,{children:["If a function invoked via HTTP request returns successfully, its return value is sent in the HTTP response body with status code ",(0,t.jsx)(n.code,{children:"200"})," (or ",(0,t.jsx)(n.code,{children:"204"})," if nothing is returned)."]}),"\n",(0,t.jsxs)(n.p,{children:["If the function throws an exception, the error message is sent in the response body with a ",(0,t.jsx)(n.code,{children:"400"})," or ",(0,t.jsx)(n.code,{children:"500"})," status code.\nIf the error contains a ",(0,t.jsx)(n.code,{children:"status"})," field, the response uses that status code instead."]}),"\n",(0,t.jsxs)(n.p,{children:["If you need custom HTTP response behavior, you can use a handler to access the HTTP response directly.\nDBOS uses ",(0,t.jsx)(n.a,{href:"https://koajs.com/",children:"Koa"})," for HTTP serving internally and the raw response can be accessed via ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#accessing-http-context",children:(0,t.jsx)(n.code,{children:"DBOS.koaContext.response"})}),", which provides a ",(0,t.jsx)(n.a,{href:"https://koajs.com/#response",children:"Koa response"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"handlers",children:"Handlers"}),"\n",(0,t.jsxs)(n.p,{children:["A function annotated with an endpoint decorator but no other decorators is called a ",(0,t.jsx)(n.em,{children:"handler"}),".\nHandlers can call other DBOS functions and directly access HTTP requests and responses.\nHowever, DBOS makes no guarantees about handler execution: if a handler fails, it is not automatically retried.\nYou should use handlers when you need to access HTTP requests or responses directly or when you are writing a lightweight task that does not need the ",(0,t.jsx)(n.a,{href:"../workflow-tutorial#reliability-guarantees",children:"strong guarantees of transactions and workflows"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"body-parser",children:"Body Parser"}),"\n",(0,t.jsxs)(n.p,{children:["By default, DBOS uses ",(0,t.jsx)(n.a,{href:"https://github.com/koajs/bodyparser",children:(0,t.jsx)(n.code,{children:"@koa/bodyparser"})})," to support JSON in requests.  If this default behavior is not desired, you can configure a custom body parser with the ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/oldapi/decorators#koabodyparser",children:(0,t.jsx)(n.code,{children:"@KoaBodyParser"})})," decorator."]}),"\n",(0,t.jsx)(n.h3,{id:"cors",children:"CORS"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS",children:"Cross-Origin Resource Sharing (CORS)"})," is a security feature that controls access to resources from different domains. DBOS uses ",(0,t.jsx)(n.a,{href:"https://github.com/koajs/cors",children:(0,t.jsx)(n.code,{children:"@koa/cors"})})," with a permissive default configuration."]}),"\n",(0,t.jsx)(n.p,{children:"To customize CORS:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Use the HTTP configuration in ",(0,t.jsx)(n.a,{href:"../../reference/configuration#http",children:(0,t.jsx)(n.code,{children:"dbos-config.yaml"})})," for global settings."]}),"\n",(0,t.jsxs)(n.li,{children:["Use the ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/oldapi/decorators#koacors",children:(0,t.jsx)(n.code,{children:"@KoaCors"})})," class decorator for class-specific settings."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"middleware",children:"Middleware"}),"\n",(0,t.jsxs)(n.p,{children:["DBOS supports running custom ",(0,t.jsx)(n.a,{href:"https://koajs.com/",children:"Koa"})," middleware for serving HTTP requests.\nMiddlewares are configured at the class level through the ",(0,t.jsx)(n.a,{href:"../../reference/transactapi/oldapi/decorators#koamiddleware",children:(0,t.jsx)(n.code,{children:"@KoaMiddleware"})})," decorator.\nHere is an example of a simple middleware checking an HTTP header:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'import { Middleware } from "koa";\n\nconst middleware: Middleware = async (ctx, next) => {\n  const contentType = ctx.request.headers["content-type"];\n  await next();\n};\n\n@KoaMiddleware(middleware)\nclass Hello {\n  ...\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"global-middleware",children:"Global Middleware"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"@KoaMiddleware"})," decorator above only places middleware on registered routes within the decorated class.  It is sometimes desired to add middleware to all routes globally, including on routes that are not registered at all."]}),"\n",(0,t.jsxs)(n.p,{children:["For example, to install logging that would pick up on 404 errors or other bad requests during development, ",(0,t.jsx)(n.code,{children:"koa-logger"})," could be installed as a ",(0,t.jsx)(n.a,{href:"/typescript/reference/transactapi/oldapi/decorators#koaglobalmiddleware",children:"global middleware"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import logger from 'koa-logger';\n\n@KoaGlobalMiddleware(logger())\nclass OperationEndpoints{\n  ...\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"If more detail is required, or to ensure that logs go to the DBOS log, a custom logger can be implemented:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Logging middleware\nconst logAllRequests = () => {\n    return async (ctx: Koa.Context, next: Koa.Next) => {\n        const start = Date.now();\n\n        // Log the request method and URL\n        DBOS.globalLogger?.info(`[Request] ${ctx.method} ${ctx.url}`);\n\n        let ok = false;\n        try {\n            await next();\n            ok = true;\n        }\n        finally {\n            const ms = Date.now() - start;\n            if (ok) {\n                // Log the response status and time taken\n                DBOS.globalLogger?.info(`[Response] ${ctx.method} ${ctx.url} - ${ctx.status} - ${ms}ms`);\n            }\n            else {\n                // Log error response\n                DBOS.globalLogger?.warn(`[Exception] ${ctx.method} ${ctx.url} - ${ctx.status} - ${ms}ms`);\n            }\n        }\n    };\n};\n\n@KoaGlobalMiddleware(logAllRequests())\nclass OperationEndpoints{\n  ...\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"serving-static-content",children:"Serving Static Content"}),"\n",(0,t.jsxs)(n.p,{children:["While it is generally advised to serve static content from a CDN, ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html",children:"S3 Bucket"}),", or similar, sometimes it is desired to serve a few static files from DBOS.  This can be done easily with a package such as ",(0,t.jsx)(n.code,{children:"koa-send"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"export class Serve {\n    @DBOS.getApi('/static/:item') // Adjust route, or recursive wildcard, to suit\n    static async serve(item: string) {\n        return send(DBOS.koaContext, item, {root: 'static'}); // Adjust root to point to directory w/ files\n    }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["To install ",(0,t.jsx)(n.code,{children:"koa-send"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm install koa-send; npm install --save-dev @types/koa-send \n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>o});var r=s(6540);const t={},a=r.createContext(t);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);