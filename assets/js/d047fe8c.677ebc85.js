"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[8436],{2398:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"typescript/tutorials/requestsandevents/http-serving-tutorial","title":"HTTP Serving","description":"Learn how to serve HTTP requests","source":"@site/docs/typescript/tutorials/requestsandevents/http-serving-tutorial.md","sourceDirName":"typescript/tutorials/requestsandevents","slug":"/typescript/tutorials/requestsandevents/http-serving-tutorial","permalink":"/typescript/tutorials/requestsandevents/http-serving-tutorial","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10,"title":"HTTP Serving","description":"Learn how to serve HTTP requests"},"sidebar":"tutorialSidebar","previous":{"title":"Debugging","permalink":"/typescript/tutorials/debugging"},"next":{"title":"Integrating with Kafka","permalink":"/typescript/tutorials/requestsandevents/kafka-integration"}}');var s=t(4848),a=t(8453);const i={sidebar_position:10,title:"HTTP Serving",description:"Learn how to serve HTTP requests"},o=void 0,d={},c=[{value:"Inputs and HTTP Requests",id:"inputs-and-http-requests",level:3},{value:"1. URL Path Parameters",id:"1-url-path-parameters",level:4},{value:"2. URL Query String Parameters",id:"2-url-query-string-parameters",level:4},{value:"3. HTTP Body Fields",id:"3-http-body-fields",level:4},{value:"Raw Requests",id:"raw-requests",level:4},{value:"Outputs and HTTP Responses",id:"outputs-and-http-responses",level:3},{value:"Handlers",id:"handlers",level:3},{value:"Body Parser",id:"body-parser",level:3},{value:"CORS",id:"cors",level:3},{value:"Middleware",id:"middleware",level:3},{value:"Global Middleware",id:"global-middleware",level:3},{value:"<code>@Authentication</code>",id:"authentication",level:3},{value:"<code>MiddlewareContext</code>",id:"middlewarecontext",level:3},{value:"Properties and Methods",id:"properties-and-methods",level:4},{value:"<code>MiddlewareContext.logger</code>",id:"middlewarecontextlogger",level:4},{value:"<code>MiddlewareContext.span</code>",id:"middlewarecontextspan",level:4},{value:"<code>MiddlewareContext.koaContext</code>",id:"middlewarecontextkoacontext",level:4},{value:"<code>MiddlewareContext.name</code>",id:"middlewarecontextname",level:4},{value:"<code>MiddlewareContext.requiredRole</code>",id:"middlewarecontextrequiredrole",level:4},{value:"<code>MiddlewareContext.getConfig</code>",id:"middlewarecontextgetconfig",level:4},{value:"<code>MiddlewareContext.query</code>",id:"middlewarecontextquery",level:4},{value:"Serving Static Content",id:"serving-static-content",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["In this guide, you'll learn how to make DBOS applications accessible through DBOS's built-in, ",(0,s.jsx)(n.a,{href:"https://koajs.com/",children:"koa"}),"-based HTTP server."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"There is no need to use the DBOS HTTP server.  DBOS functions can be embedded in other HTTP servers, and there is no need to use HTTP in DBOS applications at all.  However, the DBOS HTTP handler service is the simplest way to get started in a new HTTP application, offering simple route handling, parameter parsing and validation, security, logging, etc."})}),"\n",(0,s.jsxs)(n.p,{children:["Any function can be made into an HTTP endpoint by annotating it with an ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#http-handling",children:"endpoint decorator"}),", causing DBOS to use that function to serve that endpoint."]}),"\n",(0,s.jsxs)(n.p,{children:["You can apply an endpoint decorator either to a new function without any other decorators or to an existing function with a ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbostransaction",children:(0,s.jsx)(n.code,{children:"@DBOS.transaction"})}),", ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosworkflow",children:(0,s.jsx)(n.code,{children:"@DBOS.workflow"})}),", or ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosstep",children:(0,s.jsx)(n.code,{children:"DBOS.step"})})," decorator."]}),"\n",(0,s.jsx)(n.p,{children:"Here's an example of a new function with an endpoint decorator:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/greeting/:name')\nstatic async greetingEndpoint(name: string) {\n  return `Greeting, ${name}`;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Here's an example applying an endpoint decorator to an existing transaction (the order of the decorators doesn't matter):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@DBOS.postApi('/greeting/:friend')\n@DBOS.transaction()\nstatic async insertGreeting(friend: string, note: string) {\n  await DBOS.knexClient.raw('INSERT INTO greetings (name, note) VALUES (?, ?)', [friend, note]);\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["DBOS provides endpoint decorators for all HTTP verbs used in APIs: ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosgetapi",children:(0,s.jsx)(n.code,{children:"@DBOS.getApi"})}),", ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospostapi",children:(0,s.jsx)(n.code,{children:"@DBOS.postApi"})}),", ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosputapi",children:(0,s.jsx)(n.code,{children:"@DBOS.putApi"})}),", ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospatchapi",children:(0,s.jsx)(n.code,{children:"@DBOS.patchApi"})}),", and ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosdeleteapi",children:(0,s.jsx)(n.code,{children:"@DBOS.deleteApi"})}),".\nEach associates a function with an HTTP URL."]}),"\n",(0,s.jsx)(n.h3,{id:"inputs-and-http-requests",children:"Inputs and HTTP Requests"}),"\n",(0,s.jsx)(n.p,{children:"When a function has arguments other than its context, DBOS automatically parses them from the HTTP request, and returns an error to the client if they are not found."}),"\n",(0,s.jsx)(n.p,{children:"Arguments can be parsed from three places:"}),"\n",(0,s.jsx)(n.h4,{id:"1-url-path-parameters",children:"1. URL Path Parameters"}),"\n",(0,s.jsxs)(n.p,{children:["You can include a path parameter placeholder in a URL by prefixing it with a colon, like ",(0,s.jsx)(n.code,{children:"name"})," in this example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/greeting/:name')\nstatic async greetingEndpoint(name: string) {\n  return `Greeting, ${name}`;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then, give your method an argument with a matching name (such as ",(0,s.jsx)(n.code,{children:"name: string"})," above) and it is automatically parsed from the path parameter."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, if we send our app this request, then our method is called with ",(0,s.jsx)(n.code,{children:"name"})," set to ",(0,s.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET /greeting/dbos\n"})}),"\n",(0,s.jsx)(n.h4,{id:"2-url-query-string-parameters",children:"2. URL Query String Parameters"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosgetapi",children:(0,s.jsx)(n.code,{children:"GET"})})," and ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosdeleteapi",children:(0,s.jsx)(n.code,{children:"DELETE"})})," endpoints automatically parse arguments from query strings."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, the following endpoint expects the ",(0,s.jsx)(n.code,{children:"id"})," and ",(0,s.jsx)(n.code,{children:"name"})," parameters to be passed through a query string:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@DBOS.getApi('/example')\nstatic async exampleGet(id: number, name: string) {\n  return `${id} and ${name} are parsed from URL query string parameters`;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If we send our app this request, then our method is called with ",(0,s.jsx)(n.code,{children:"id"})," set to ",(0,s.jsx)(n.code,{children:"123"})," and ",(0,s.jsx)(n.code,{children:"name"})," set to ",(0,s.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET /example?id=123&name=dbos\n"})}),"\n",(0,s.jsx)(n.h4,{id:"3-http-body-fields",children:"3. HTTP Body Fields"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospostapi",children:(0,s.jsx)(n.code,{children:"POST"})}),", ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbospatchapi",children:(0,s.jsx)(n.code,{children:"PATCH"})}),", and ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbosputapi",children:(0,s.jsx)(n.code,{children:"PUT"})})," endpoints automatically parse arguments from the HTTP request body."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, the following endpoint expects the ",(0,s.jsx)(n.code,{children:"id"})," and ",(0,s.jsx)(n.code,{children:"name"})," parameters to be passed through the HTTP request body:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"@DBOS.postApi('/example')\nstatic async examplePost(id: number, name: string) {\n  return `${id} and ${name} are parsed from the HTTP request body`;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If we send our app this request, then our method is called with ",(0,s.jsx)(n.code,{children:"id"})," set to ",(0,s.jsx)(n.code,{children:"123"})," and ",(0,s.jsx)(n.code,{children:"name"})," set to ",(0,s.jsx)(n.code,{children:"dbos"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'POST /example\nContent-Type: application/json\n\n{\n  "name": "dbos",\n  "id": 123\n}\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["When sending an HTTP request with a JSON body, make sure you set the ",(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type",children:(0,s.jsx)(n.code,{children:"Content-Type"})})," header to ",(0,s.jsx)(n.code,{children:"application/json"}),"."]})}),"\n",(0,s.jsx)(n.h4,{id:"raw-requests",children:"Raw Requests"}),"\n",(0,s.jsxs)(n.p,{children:["If you need finer-grained request parsing, any DBOS method invoked via HTTP request can access raw request information from ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#accessing-http-context",children:(0,s.jsx)(n.code,{children:"DBOS.request"})}),". This returns the following information:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface HTTPRequest {\n  readonly headers?: IncomingHttpHeaders;  // A node's http.IncomingHttpHeaders object.\n  readonly rawHeaders?: string[];          // Raw headers.\n  readonly params?: unknown;               // Parsed path parameters from the URL.\n  readonly body?: unknown;                 // parsed HTTP body as an object.\n  readonly rawBody?: string;               // Unparsed raw HTTP body string.\n  readonly query?: ParsedUrlQuery;         // Parsed query string.\n  readonly querystring?: string;           // Unparsed raw query string.\n  readonly url?: string;                   // Request URL.\n  readonly ip?: string;                    // Request remote address.\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"outputs-and-http-responses",children:"Outputs and HTTP Responses"}),"\n",(0,s.jsxs)(n.p,{children:["If a function invoked via HTTP request returns successfully, its return value is sent in the HTTP response body with status code ",(0,s.jsx)(n.code,{children:"200"})," (or ",(0,s.jsx)(n.code,{children:"204"})," if nothing is returned)."]}),"\n",(0,s.jsxs)(n.p,{children:["If the function throws an exception, the error message is sent in the response body with a ",(0,s.jsx)(n.code,{children:"400"})," or ",(0,s.jsx)(n.code,{children:"500"})," status code.\nIf the error contains a ",(0,s.jsx)(n.code,{children:"status"})," field, the response uses that status code instead."]}),"\n",(0,s.jsxs)(n.p,{children:["If you need custom HTTP response behavior, you can use a handler to access the HTTP response directly.\nDBOS uses ",(0,s.jsx)(n.a,{href:"https://koajs.com/",children:"Koa"})," for HTTP serving internally and the raw response can be accessed via ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#accessing-http-context",children:(0,s.jsx)(n.code,{children:"DBOS.koaContext.response"})}),", which provides a ",(0,s.jsx)(n.a,{href:"https://koajs.com/#response",children:"Koa response"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"handlers",children:"Handlers"}),"\n",(0,s.jsxs)(n.p,{children:["A function annotated with an endpoint decorator but no other decorators is called a ",(0,s.jsx)(n.em,{children:"handler"}),".\nHandlers can call other DBOS functions and directly access HTTP requests and responses.\nHowever, DBOS makes no guarantees about handler execution: if a handler fails, it is not automatically retried.\nYou should use handlers when you need to access HTTP requests or responses directly or when you are writing a lightweight task that does not need the ",(0,s.jsx)(n.a,{href:"../workflow-tutorial#reliability-guarantees",children:"strong guarantees of transactions and workflows"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"body-parser",children:"Body Parser"}),"\n",(0,s.jsxs)(n.p,{children:["By default, DBOS uses ",(0,s.jsx)(n.a,{href:"https://github.com/koajs/bodyparser",children:(0,s.jsx)(n.code,{children:"@koa/bodyparser"})})," to support JSON in requests.  If this default behavior is not desired, you can configure a custom body parser with the ",(0,s.jsx)(n.code,{children:"@KoaBodyParser"})," decorator."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { bodyParser } from "@koa/bodyparser";\n\n@KoaBodyParser(bodyParser({\n  extendTypes: {\n    json: ["application/json", "application/custom-content-type"],\n  },\n  encoding: "utf-8"\n}))\nclass OperationEndpoints {\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"cors",children:"CORS"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS",children:"Cross-Origin Resource Sharing (CORS)"})," is a security feature that controls access to resources from different domains. DBOS uses ",(0,s.jsx)(n.a,{href:"https://github.com/koajs/cors",children:(0,s.jsx)(n.code,{children:"@koa/cors"})})," with a permissive default configuration."]}),"\n",(0,s.jsxs)(n.p,{children:["If more complex logic is needed, or if the CORS configuration differs between operation classes, the ",(0,s.jsx)(n.code,{children:"@KoaCors"})," class-level decorator can be used to specify the CORS middleware in full."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import cors from \"@koa/cors\";\n\n@KoaCors(cors({\n  credentials: true,\n  origin:\n    (o: Context)=>{\n      const whitelist = ['https://us.com','https://partner.com'];\n      const origin = o.request.header.origin ?? '*';\n      return (whitelist.includes(origin) ? origin : '');\n    }\n}))\nclass EndpointsWithSpecialCORS {\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"middleware",children:"Middleware"}),"\n",(0,s.jsxs)(n.p,{children:["DBOS supports running arbitrary ",(0,s.jsx)(n.a,{href:"https://koajs.com/",children:"Koa"})," middleware for serving HTTP requests.\nMiddlewares are configured at the class level through the ",(0,s.jsx)(n.code,{children:"@KoaMiddleware"})," decorator.\nHere is an example of a simple middleware checking an HTTP header:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'import { Middleware } from "koa";\n\nconst middleware: Middleware = async (ctx, next) => {\n  const contentType = ctx.request.headers["content-type"];\n  await next();\n};\n\n@KoaMiddleware(middleware)\nclass Hello {\n  ...\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"global-middleware",children:"Global Middleware"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"@KoaMiddleware"})," decorator above only places middleware on registered routes within the decorated class.  It is sometimes desired to add middleware to all routes globally, including on routes that are not registered at all."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, to install logging that would pick up on 404 errors or other bad requests during development, ",(0,s.jsx)(n.code,{children:"koa-logger"})," could be installed as a global middleware"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import logger from 'koa-logger';\n\n@KoaGlobalMiddleware(logger())\nclass OperationEndpoints{\n  ...\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"If more detail is required, or to ensure that logs go to the DBOS log, a custom logger can be implemented:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Logging middleware\nconst logAllRequests = () => {\n    return async (ctx: Koa.Context, next: Koa.Next) => {\n        const start = Date.now();\n\n        // Log the request method and URL\n        DBOS.logger.info(`[Request] ${ctx.method} ${ctx.url}`);\n\n        let ok = false;\n        try {\n            await next();\n            ok = true;\n        }\n        finally {\n            const ms = Date.now() - start;\n            if (ok) {\n                // Log the response status and time taken\n                DBOS.logger.info(`[Response] ${ctx.method} ${ctx.url} - ${ctx.status} - ${ms}ms`);\n            }\n            else {\n                // Log error response\n                DBOS.logger.warn(`[Exception] ${ctx.method} ${ctx.url} - ${ctx.status} - ${ms}ms`);\n            }\n        }\n    };\n};\n\n@KoaGlobalMiddleware(logAllRequests())\nclass OperationEndpoints{\n  ...\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"authentication",children:(0,s.jsx)(n.code,{children:"@Authentication"})}),"\n",(0,s.jsxs)(n.p,{children:["Configures the DBOS HTTP server to perform authentication. All functions in the decorated class will use the provided function to act as an authentication middleware.\nThis middleware will make users' identity available to ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#retrieving-the-authenticated-user-and-roles",children:"DBOS functions"}),". Here is an example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async function exampleAuthMiddleware (ctx: MiddlewareContext) {\n  if (ctx.requiredRole.length > 0) {\n    const { userid } = ctx.koaContext.request.query;\n    const uid = userid?.toString();\n\n    if (!uid || uid.length === 0) {\n      const err = new DBOSNotAuthorizedError(\"Not logged in.\", 401);\n      throw err;\n    }\n    else {\n      if (uid === 'bad_person') {\n        throw new DBOSNotAuthorizedError(\"Go away.\", 401);\n      }\n      return {\n        authenticatedUser: uid,\n        authenticatedRoles: (uid === 'a_real_user' ? ['user'] : ['other'])\n      };\n    }\n  }\n}\n\n@Authentication(exampleAuthMiddleware)\nclass OperationEndpoints {\n  @DBOS.getApi(\"/requireduser\")\n  @DBOS.requiredRole(['user'])\n  static async checkAuth() {\n    return `Please say hello to ${DBOS.authenticatedUser}`;\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"The interface for the authentication middleware is:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"/**\n * Authentication middleware executing before requests reach functions.\n * Can implement arbitrary authentication and authorization logic.\n * Should throw an error or return an instance of `DBOSHttpAuthReturn`\n */\nexport type DBOSHttpAuthMiddleware = (ctx: MiddlewareContext) => Promise<DBOSHttpAuthReturn | void>;\n\nexport interface DBOSHttpAuthReturn {\n  authenticatedUser: string;\n  authenticatedRoles: string[];\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The authentication function is provided with a ",(0,s.jsx)(n.a,{href:"#middlewarecontext",children:"'MiddlewareContext'"}),", which allows access to the request, system configuration, logging, and database access services."]}),"\n",(0,s.jsx)(n.h3,{id:"middlewarecontext",children:(0,s.jsx)(n.code,{children:"MiddlewareContext"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"MiddlewareContext"})," is provided to functions that execute against a request before entry into handler, transaction, and workflow functions.  These middleware functions are generally executed before, or in the process of, user authentication, request validation, etc.  The context is intended to provide read-only database access, logging services, and configuration information."]}),"\n",(0,s.jsx)(n.h4,{id:"properties-and-methods",children:"Properties and Methods"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextlogger",children:"logger"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextspan",children:"span"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextkoacontext",children:"koaContext"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextname",children:"name"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextrequiredrole",children:"requiredRole"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextgetconfig",children:"getConfig"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#middlewarecontextquery",children:"query"})}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextlogger",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.logger"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"readonly logger: DBOSLogger;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"logger"})," is available to record any interesting successes, failures, or diagnostic information that occur during middleware processing."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextspan",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.span"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"readonly span: Span;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"span"})," is the tracing span in which the middleware is being executed."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextkoacontext",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.koaContext"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"readonly koaContext: Koa.Context;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"koaContext"})," is the Koa context, which contains the inbound HTTP request associated with the middleware invocation."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextname",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.name"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"readonly name: string;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"name"})," contains the name of the function (handler, transaction, workflow) to be invoked after successful middleware processing."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextrequiredrole",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.requiredRole"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"readonly requiredRole: string[];\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"requiredRole"})," contains the list of roles required for the invoked operation.  Access to the function will granted if the user has any role on the list.  If the list is empty, it means there are no authorization requirements and may indicate that authentication is not required."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextgetconfig",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.getConfig"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"getConfig<T>(key: string, deflt: T | undefined) : T | undefined\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"getConfig"})," retrieves configuration information (from .yaml config file / environment).  If ",(0,s.jsx)(n.code,{children:"key"})," is not present in the configuration, ",(0,s.jsx)(n.code,{children:"defaultValue"})," is returned."]}),"\n",(0,s.jsx)(n.h4,{id:"middlewarecontextquery",children:(0,s.jsx)(n.code,{children:"MiddlewareContext.query"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"  query<C extends UserDatabaseClient, R, T extends unknown[]>(qry: (dbclient: C, ...args: T) => Promise<R>, ...args: T): Promise<R>;\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"query"})," function provides read access to the database.\nTo provide a scoped database connection and to ensure cleanup, the ",(0,s.jsx)(n.code,{children:"query"})," API works via a callback function.\nThe application is to pass in a ",(0,s.jsx)(n.code,{children:"qry"})," function that will be executed in a context with access to the database client ",(0,s.jsx)(n.code,{children:"dbclient"}),".\nThe provided ",(0,s.jsx)(n.code,{children:"dbClient"})," will be a ",(0,s.jsx)(n.code,{children:"Knex"})," or TypeORM ",(0,s.jsx)(n.code,{children:"EntityManager"})," or ",(0,s.jsx)(n.code,{children:"PrismaClient"})," depending on the application's choice of SQL access library.\nThis callback function may take arguments, and return a value."]}),"\n",(0,s.jsx)(n.p,{children:"Example, for Knex:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'  const u = await ctx.query(\n    // The qry function that takes in a dbClient and a list of arguments (uname in this case)\n    (dbClient: Knex, uname: string) => {\n      return dbClient<UserTable>(userTableName).select("username").where({ username: uname })\n    },\n    userName // Input value for the uname argument\n  );\n'})}),"\n",(0,s.jsx)(n.h3,{id:"serving-static-content",children:"Serving Static Content"}),"\n",(0,s.jsxs)(n.p,{children:["While it is generally advised to serve static content from a CDN, ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html",children:"S3 Bucket"}),", or similar, sometimes it is desired to serve a few static files from DBOS.  This can be done easily with a package such as ",(0,s.jsx)(n.code,{children:"koa-send"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"export class Serve {\n    @DBOS.getApi('/static/:item') // Adjust route, or recursive wildcard, to suit\n    static async serve(item: string) {\n        return send(DBOS.koaContext, item, {root: 'static'}); // Adjust root to point to directory w/ files\n    }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To install ",(0,s.jsx)(n.code,{children:"koa-send"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm install koa-send; npm install --save-dev @types/koa-send \n"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var r=t(6540);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);