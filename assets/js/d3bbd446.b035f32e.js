"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[8870],{367:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"integrations/lakebase","title":"Lakebase","description":"Here\'s how to connect your DBOS application running on your computer or cloud environment to your Databricks Lakebase Postgres database.","source":"@site/docs/integrations/lakebase.md","sourceDirName":"integrations","slug":"/integrations/lakebase","permalink":"/integrations/lakebase","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":19,"frontMatter":{"sidebar_position":19,"title":"Lakebase","hide_table_of_contents":true},"sidebar":"tutorialSidebar","previous":{"title":"Vercel","permalink":"/integrations/vercel"},"next":{"title":"Neon","permalink":"/integrations/neon"}}');var o=t(4848),s=t(8453);const i={sidebar_position:19,title:"Lakebase",hide_table_of_contents:!0},r="Use DBOS With Lakebase",c={},l=[{value:"1. Set up a Local Application",id:"1-set-up-a-local-application",level:3},{value:"2. Connect to Lakebase",id:"2-connect-to-lakebase",level:3},{value:"3. Launch Your Application",id:"3-launch-your-application",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components},{Details:a,LargeTabItem:i,LargeTabs:r}=n;return a||u("Details",!0),i||u("LargeTabItem",!0),r||u("LargeTabs",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"use-dbos-with-lakebase",children:"Use DBOS With Lakebase"})}),"\n",(0,o.jsx)(n.p,{children:"Here's how to connect your DBOS application running on your computer or cloud environment to your Databricks Lakebase Postgres database."}),"\n",(0,o.jsx)(n.h3,{id:"1-set-up-a-local-application",children:"1. Set up a Local Application"}),"\n",(0,o.jsxs)(n.p,{children:["If you haven't already, follow the ",(0,o.jsx)(n.a,{href:"/quickstart",children:"quickstart"})," to set up a DBOS application locally.\nThe rest of this guide will assume you have a local application."]}),"\n",(0,o.jsx)(n.h3,{id:"2-connect-to-lakebase",children:"2. Connect to Lakebase"}),"\n",(0,o.jsxs)(r,{groupId:"auth",queryString:"auth",children:[(0,o.jsxs)(i,{value:"password",label:"Native Postgres Password Authentication",children:[(0,o.jsx)(n.p,{children:'From the "Roles & Databases" tab of your Lakebase console, create a Postgres role that you will use to access your Lakebase database from your DBOS application.'}),(0,o.jsx)("img",{src:t(7746).A,alt:"Create Role",width:"800",className:"custom-img"}),(0,o.jsx)(n.p,{children:'Next, click "Connect" on your Lakebase console to retrieve connection information for your Lakebase database.\nYou should see a screen that looks like this:'}),(0,o.jsx)("img",{src:t(4973).A,alt:"Create Role",width:"800",className:"custom-img"}),(0,o.jsx)(n.p,{children:"This page shows the connection string for your database.\nThere are a few settings you may wish to alter before retrieving this connection string:"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Select the Postgres role you created from the dropdown."}),"\n",(0,o.jsx)(n.li,{children:'Make sure you are viewing your "Connection string" from the dropdown.'}),"\n",(0,o.jsxs)(n.li,{children:["By default, you will use the ",(0,o.jsx)(n.code,{children:"databricks_postgres"})," database. If you want to use a different database, create it from the dropdown."]}),"\n"]}),(0,o.jsxs)(n.p,{children:["When you are ready, copy the connection string (including the password) from the dashboard and set the ",(0,o.jsx)(n.code,{children:"DBOS_SYSTEM_DATABASE_URL"})," environment variable to it:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'export DBOS_SYSTEM_DATABASE_URL="<your connection string>"\n'})})]}),(0,o.jsxs)(i,{value:"oauth",label:"OAuth Token Authentication",children:[(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"Programmatic OAuth token generation through the Databricks SDK is only available in Python."})}),(0,o.jsxs)(n.p,{children:["First, install the Databricks SDK into your application, then follow ",(0,o.jsx)(n.a,{href:"https://docs.databricks.com/aws/en/dev-tools/sdk-python#authentication",children:"this guide"})," to authenticate:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"pip install databricks-sdk\n"})}),(0,o.jsx)(n.p,{children:"Then, add this code to your application to configure DBOS to retrieve and use a Databricks OAuth token for authentication with your Lakebase database:"}),(0,o.jsxs)(a,{children:[(0,o.jsx)("summary",{children:(0,o.jsx)("strong",{children:"Databricks OAuth Authentication"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'from databricks.sdk import WorkspaceClient\nimport psycopg\nimport sqlalchemy as sa\n\ndef create_databricks_oauth_engine(database_url: str, lakebase_endpoint: str) -> sa.Engine:\n    """\n    Create a SQLAlchemy engine that uses Databricks OAuth tokens for authentication.\n\n    Each new connection will fetch a fresh OAuth token from Databricks.\n    """\n    workspace_client = WorkspaceClient()\n\n    def get_connection() -> psycopg.Connection:\n        token = workspace_client.postgres.generate_database_credential(\n            endpoint=lakebase_endpoint\n        ).token\n        return psycopg.connect(database_url, password=token)\n\n    return sa.create_engine("postgresql+psycopg://", creator=get_connection)\n\n\nif __name__ == "__main__":\n    engine = create_databricks_oauth_engine(\n        os.environ["DBOS_SYSTEM_DATABASE_URL"],\n        os.environ["DATABRICKS_LAKEBASE_ENDPOINT"],\n    )\n    config: DBOSConfig = {\n        "name": "my-app",\n        "system_database_engine": engine,\n    }\n    DBOS(config=config)\n    DBOS.launch()\n    uvicorn.run(app, host="0.0.0.0", port=8000)\n'})})]}),(0,o.jsx)(n.p,{children:'Next, click "Connect" on your Lakebase console to retrieve connection information for your Lakebase database.\nYou should see a screen that looks like this:'}),(0,o.jsx)("img",{src:t(7051).A,alt:"Create Role",width:"800",className:"custom-img"}),(0,o.jsx)(n.p,{children:"This page shows the connection string for your database.\nThere are a few settings you may wish to alter before retrieving this connection string:"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:'Make sure you are viewing your "Connection string" from the dropdown.'}),"\n",(0,o.jsxs)(n.li,{children:["By default, you will use the ",(0,o.jsx)(n.code,{children:"databricks_postgres"})," database. If you want to use a different database, create it from the dropdown."]}),"\n"]}),(0,o.jsxs)(n.p,{children:["When you are ready, copy the connection string from the dashboard and set the ",(0,o.jsx)(n.code,{children:"DBOS_SYSTEM_DATABASE_URL"})," environment variable to it:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'export DBOS_SYSTEM_DATABASE_URL="<your connection string>"\n'})}),(0,o.jsxs)(n.p,{children:["Also, set the ",(0,o.jsx)(n.code,{children:"DATABRICKS_LAKEBASE_ENDPOINT"})," environment variable to your Lakebase endpoint:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'export DATABRICKS_LAKEBASE_ENDPOINT="projects/<project-id>/branches/<branch-id>/endpoints/<compute-id>"\n'})})]})]}),"\n",(0,o.jsx)(n.h3,{id:"3-launch-your-application",children:"3. Launch Your Application"}),"\n",(0,o.jsx)(n.p,{children:"Now, launch your DBOS application.\nIt should successfully connect to your Lakebase database, printing your masked Lakebase database URL on startup."}),"\n",(0,o.jsxs)(n.p,{children:['After connecting your DBOS application to Lakebase, you can use the Lakebase console to view your DBOS system tables.\nOpen the "Tables" tab in the Lakebase console.\nFor your database, select the database to which you connected your DBOS application (default ',(0,o.jsx)(n.code,{children:"databricks_postgres"}),').\nFor your schema, select "dbos".\nYou can now see DBOS durably checkpoint your workflows to your Lakebase database:']}),"\n",(0,o.jsx)("img",{src:t(7024).A,alt:"Lakebase Tables Dashboard",width:"800",className:"custom-img"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}function u(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},4973:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/connect-c2e36ad0c7b66e377e4be574529368dc.png"},7746:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/create-role-0677c178e666be08a8224267f9a3ecc3.png"},7051:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/oauth-connect-f832991b08cf457f45a0feab8a8900c9.png"},7024:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/tables-fd3bb6e91d61ddffdd04af097bfa0214.png"},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var a=t(6540);const o={},s=a.createContext(o);function i(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);