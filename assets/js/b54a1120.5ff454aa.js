"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[7225],{8421:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"java/examples/widget-store","title":"Fault-Tolerant Checkout","description":"This example is also available in TypeScript, Go, and Python.","source":"@site/docs/java/examples/widget-store.md","sourceDirName":"java/examples","slug":"/java/examples/widget-store","permalink":"/java/examples/widget-store","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":30,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":30,"title":"Fault-Tolerant Checkout"},"sidebar":"examplesSidebar","previous":{"title":"Fault-Tolerant Checkout","permalink":"/golang/examples/widget-store"}}');var o=t(4848),s=t(8453);const i={displayed_sidebar:"examplesSidebar",sidebar_position:30,title:"Fault-Tolerant Checkout"},a=void 0,d={},l=[{value:"Building the Checkout Workflow",id:"building-the-checkout-workflow",level:2},{value:"The Checkout and Payment Endpoints",id:"the-checkout-and-payment-endpoints",level:2},{value:"Database Operations",id:"database-operations",level:2},{value:"Launching and Serving the App",id:"launching-and-serving-the-app",level:2},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["This example is also available in ",(0,o.jsx)(n.a,{href:"../../typescript/examples/checkout-tutorial",children:"TypeScript"}),", ",(0,o.jsx)(n.a,{href:"../../golang/examples/widget-store",children:"Go"}),", and ",(0,o.jsx)(n.a,{href:"/python/examples/widget-store",children:"Python"}),"."]})}),"\n",(0,o.jsx)(n.p,{children:"In this example, we use DBOS and Spring Boot to build an online storefront that's resilient to any failure."}),"\n",(0,o.jsxs)(n.p,{children:["You can see the application live ",(0,o.jsx)(n.a,{href:"https://demo-widget-store.cloud.dbos.dev/",children:"here"}),".\nTry playing with it and pressing the crash button as often as you want.\nWithin a few seconds, the app will recover and resume as if nothing happened."]}),"\n",(0,o.jsxs)(n.p,{children:["All source code is ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/java/widget-store",children:"available on GitHub"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Widget store UI",src:t(3092).A+"",width:"1243",height:"915"})}),"\n",(0,o.jsx)(n.h2,{id:"building-the-checkout-workflow",children:"Building the Checkout Workflow"}),"\n",(0,o.jsx)(n.p,{children:"The core of this application is the checkout workflow, which orchestrates the entire purchase process.\nThis workflow is triggered whenever a customer buys a widget and handles the complete order lifecycle:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Creates a new order in the system"}),"\n",(0,o.jsx)(n.li,{children:"Reserves inventory to ensure the item is available"}),"\n",(0,o.jsx)(n.li,{children:"Processes payment"}),"\n",(0,o.jsx)(n.li,{children:"Marks the order as paid and initiates fulfillment"}),"\n",(0,o.jsx)(n.li,{children:"Handles failures gracefully by releasing reserved inventory and canceling orders when necessary"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["DBOS ",(0,o.jsx)(n.strong,{children:"durably executes"})," this workflow.\nIt checkpoints each step in the database so that if the app fails or is interrupted during checkout, it will automatically recover from the last completed step.\nThis means that customers never lose their order progress, no matter what breaks."]}),"\n",(0,o.jsxs)(n.p,{children:["You can try this yourself!\nOn the ",(0,o.jsx)(n.a,{href:"https://demo-widget-store.cloud.dbos.dev/",children:"live application"}),", start an order and press the crash button at any time.\nWithin seconds, your app will recover to exactly the state it was in before the crash and continue as if nothing happened."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'@Workflow\npublic String checkoutWorkflow(String key) {\n    Integer orderId = DBOS.runStep(() -> service.createOrder(), "createOrder");\n    try {\n        DBOS.runStep(() -> service.subtractInventory(), "subtractInventory");\n    } catch (RuntimeException e) {\n        logger.error("Failed to reserve inventory for order {}", orderId);\n        DBOS.runStep(() -> service.errorOrder(orderId), "errorOrder");\n        DBOS.setEvent(PAYMENT_ID, null);\n    }\n\n    DBOS.setEvent(PAYMENT_ID, key);\n\n    String payment_status = (String) DBOS.recv(PAYMENT_STATUS, Duration.ofSeconds(60));\n\n    if (payment_status != null && payment_status.equals("paid")) {\n        logger.info("Payment successful for order {}", orderId);\n        DBOS.runStep(() -> service.markOrderPaid(orderId), "markOrderPaid");\n        DBOS.startWorkflow(() -> service.dispatchOrderWorkflow(orderId));\n    } else {\n        logger.info("Payment failed for order {}", orderId);\n        DBOS.runStep(() -> service.errorOrder(orderId), "errorOrder");\n        DBOS.runStep(() -> service.undoSubtractInventory(), "undoSubtractInventory");\n    }\n    \n    DBOS.setEvent(ORDER_ID, String.valueOf(orderId));\n    return key;\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"the-checkout-and-payment-endpoints",children:"The Checkout and Payment Endpoints"}),"\n",(0,o.jsx)(n.p,{children:"Now let's implement the HTTP endpoints that handle customer interactions with the checkout system."}),"\n",(0,o.jsx)(n.p,{children:'The checkout endpoint is triggered when a customer clicks the "Buy Now" button.\nIt starts the checkout workflow in the background, then waits for the workflow to generate and send it a unique payment ID.\nIt then returns the payment ID so the browser can redirect the user to the payments page.'}),"\n",(0,o.jsxs)(n.p,{children:["The endpoint accepts an ",(0,o.jsx)(n.a,{href:"/java/tutorials/workflow-tutorial#workflow-ids-and-idempotency",children:"idempotency key"}),' so that even if the customer presses "buy now" multiple times, only one checkout workflow is started.']}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'public ResponseEntity<String> checkout(@PathVariable String key) {\n    logger.info("Checkout requested with key: " + key);\n    \n    try {\n        // Execute the checkout workflow using DBOS\n        logger.info("Calling checkoutWorkflow on service: {}", widgetStoreService.getClass().getName());\n        var options = new StartWorkflowOptions(key);\n        DBOS.startWorkflow(() -> widgetStoreService.checkoutWorkflow(key), options);\n\n        String paymentID = (String) DBOS.getEvent(key, PAYMENT_ID, Duration.ofSeconds(60));\n        if (paymentID == null) {\n            return ResponseEntity.internalServerError().body("Item not available");\n        }\n        return ResponseEntity.ok(paymentID);\n        \n    } catch (RuntimeException e) {\n        logger.error("Checkout failed: " + e.getMessage());\n        return ResponseEntity.internalServerError().body("Error starting checkout");\n    }\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"The payment endpoint handles the communication between the payment system and the checkout workflow.\nIt uses the payment ID to signal the checkout workflow whether the payment succeeded or failed.\nIt then retrieves the order ID from the checkout workflow so the browser can redirect the customer to the order status page."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'@PostMapping("/payment_webhook/{key}/{status}")\npublic ResponseEntity<String> paymentWebhook(@PathVariable String key, @PathVariable String status) {\n    logger.info("Payment webhook called with key: " + key + ", status: " + status);\n    \n    try {\n        DBOS.send(key, status, PAYMENT_STATUS);\n        String orderId = (String) DBOS.getEvent(key, ORDER_ID, Duration.ofSeconds(60));\n        return ResponseEntity.ok(orderId);\n    } catch (Exception e) {\n        logger.error("Payment webhook processing failed", e);\n        return ResponseEntity.internalServerError().body("Error processing payment");\n    }\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"database-operations",children:"Database Operations"}),"\n",(0,o.jsx)(n.p,{children:"Now, let's implement the checkout workflow's steps.\nEach step performs a database operation, like updating inventory or order status.\nThese are implemented as regular Java functions that interact with the Postgres database."}),"\n",(0,o.jsxs)(r,{children:[(0,o.jsx)("summary",{children:(0,o.jsx)("strong",{children:"Database Operations"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'@Transactional\npublic class WidgetStoreServiceImpl implements WidgetStoreService {\n    \n    private static final Logger logger = LoggerFactory.getLogger(WidgetStoreServiceImpl.class);\n\n    private final DSLContext dsl;\n\n    public WidgetStoreServiceImpl(DSLContext dsl) {\n        this.dsl = dsl;\n    }\n\n    private WidgetStoreService service;\n\n    public void setProxy(WidgetStoreService service) {\n        this.service=service;\n    }\n\n    public ProductDto retrieveProduct() {\n        Products product = dsl.selectFrom(PRODUCTS)\n                .where(PRODUCTS.PRODUCT_ID.eq(PRODUCT_ID))\n                .fetchOneInto(Products.class);\n        \n        if (product == null) {\n            return null;\n        }\n        \n        return new ProductDto(\n                product.getProductId(),\n                product.getProduct(),\n                product.getDescription(),\n                product.getInventory(),\n                product.getPrice()\n        );\n    }\n\n    public void setInventory(int inventory) {\n        dsl.update(PRODUCTS)\n                .set(PRODUCTS.INVENTORY, inventory)\n                .where(PRODUCTS.PRODUCT_ID.eq(PRODUCT_ID))\n                .execute();\n    }\n\n    public void subtractInventory() throws RuntimeException {\n        int updated = dsl.update(PRODUCTS)\n                .set(PRODUCTS.INVENTORY, PRODUCTS.INVENTORY.minus(1))\n                .where(PRODUCTS.PRODUCT_ID.eq(PRODUCT_ID))\n                .and(PRODUCTS.INVENTORY.ge(1))\n                .execute();\n        \n        if (updated == 0) {\n            throw new RuntimeException("Insufficient Inventory");\n        }\n    }\n\n    public void undoSubtractInventory() {\n        dsl.update(PRODUCTS)\n                .set(PRODUCTS.INVENTORY, PRODUCTS.INVENTORY.plus(1))\n                .where(PRODUCTS.PRODUCT_ID.eq(PRODUCT_ID))\n                .execute();\n    }\n\n    public Integer createOrder() {\n        return dsl.insertInto(ORDERS)\n                .set(ORDERS.ORDER_STATUS, OrderStatus.PENDING.getValue())\n                .set(ORDERS.PRODUCT_ID, PRODUCT_ID)\n                .set(ORDERS.LAST_UPDATE_TIME, LocalDateTime.now())\n                .set(ORDERS.PROGRESS_REMAINING, 10)\n                .returningResult(ORDERS.ORDER_ID)\n                .fetchOne()\n                .get(ORDERS.ORDER_ID);\n    }\n\n    public OrderDto retrieveOrder(int orderId) {\n        Orders order = dsl.selectFrom(ORDERS)\n                .where(ORDERS.ORDER_ID.eq(orderId))\n                .fetchOneInto(Orders.class);\n        \n        if (order == null) {\n            return null;\n        }\n        \n        return new OrderDto(\n                order.getOrderId(),\n                order.getOrderStatus(),\n                order.getLastUpdateTime(),\n                order.getProductId(),\n                order.getProgressRemaining()\n        );\n    }\n\n    public List<OrderDto> retrieveOrders() {\n        List<Orders> orders = dsl.selectFrom(ORDERS)\n                .orderBy(ORDERS.ORDER_ID.desc())\n                .fetchInto(Orders.class);\n        \n        return orders.stream()\n                .map(order -> new OrderDto(\n                        order.getOrderId(),\n                        order.getOrderStatus(),\n                        order.getLastUpdateTime(),\n                        order.getProductId(),\n                        order.getProgressRemaining()\n                ))\n                .collect(Collectors.toList());\n    }\n\n    public void markOrderPaid(int orderId) {\n        dsl.update(ORDERS)\n                .set(ORDERS.ORDER_STATUS, OrderStatus.PAID.getValue())\n                .set(ORDERS.LAST_UPDATE_TIME, LocalDateTime.now())\n                .where(ORDERS.ORDER_ID.eq(orderId))\n                .execute();\n    }\n\n    public void errorOrder(int orderId) {\n        dsl.update(ORDERS)\n                .set(ORDERS.ORDER_STATUS, OrderStatus.CANCELLED.getValue())\n                .set(ORDERS.LAST_UPDATE_TIME, LocalDateTime.now())\n                .where(ORDERS.ORDER_ID.eq(orderId))\n                .execute();\n    }\n\n    @Workflow\n    public void dispatchOrderWorkflow(Integer orderId) {\n        for (int i = 0; i < 10; i++) {\n            DBOS.sleep(Duration.ofSeconds(1));\n            DBOS.runStep(() -> service.updateOrderProgress(orderId), "updateOrderProgress");\n        }\n    }\n\n    public void updateOrderProgress(Integer orderId) {\n        Integer progressRemaining = dsl.update(ORDERS)\n                .set(ORDERS.PROGRESS_REMAINING, ORDERS.PROGRESS_REMAINING.minus(1))\n                .set(ORDERS.LAST_UPDATE_TIME, LocalDateTime.now())\n                .where(ORDERS.ORDER_ID.eq(orderId))\n                .returningResult(ORDERS.PROGRESS_REMAINING)\n                .fetchOne()\n                .get(ORDERS.PROGRESS_REMAINING);\n\n        if (progressRemaining == 0) {\n            dsl.update(ORDERS)\n                    .set(ORDERS.ORDER_STATUS, OrderStatus.DISPATCHED.getValue())\n                    .set(ORDERS.LAST_UPDATE_TIME, LocalDateTime.now())\n                    .where(ORDERS.ORDER_ID.eq(orderId))\n                    .execute();\n        }\n    }\n}\n'})})]}),"\n",(0,o.jsx)(n.h2,{id:"launching-and-serving-the-app",children:"Launching and Serving the App"}),"\n",(0,o.jsx)(n.p,{children:"To run this app, we need beans to create and configure DBOS and register workflows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class WidgetStoreConfig {\n\n    @Bean\n    @Primary\n    public WidgetStoreService widgetStoreService(DSLContext dslContext) {\n        var impl = new WidgetStoreServiceImpl(dslContext);\n\t    var proxy = DBOS.registerWorkflows(WidgetStoreService.class, impl);\n        impl.setProxy(proxy);\n        return proxy;\n    }\n\n    @Bean\n    DBOSConfig dbosConfig() {\n        String databaseUrl = System.getenv("DBOS_SYSTEM_JDBC_URL");\n        if (databaseUrl == null || databaseUrl.isEmpty()) {\n            databaseUrl = "jdbc:postgresql://localhost:5432/widget_store_java";\n        }\n        return DBOSConfig.defaults("widget-store")\n                .withDatabaseUrl(databaseUrl)\n                .withDbUser(Objects.requireNonNullElse(System.getenv("PGUSER"), "postgres"))\n                .withDbPassword(Objects.requireNonNullElse(System.getenv("PGPASSWORD"), "dbos"))\n                .withAdminServer(true);\n    }\n\n    @Bean\n    public DBOS.Instance dbos(DBOSConfig config) {\n        return DBOS.configure(config);\n    }\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"We also hook into the Spring Boot lifecycle to launch and shut down DBOS:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'@Component\n@Lazy(false)\npublic class DBOSLifecycle implements SmartLifecycle {\n\n    private static final Logger log = LoggerFactory.getLogger(DBOSLifecycle.class);\n    private volatile boolean running = false;\n\n    @Override\n    public void start() {\n        log.info("Launch DBOS");\n        DBOS.launch();\n        running = true;\n    }\n\n    @Override\n    public void stop() {\n        log.info("Shut Down DBOS");\n        try {\n            DBOS.shutdown();\n        } finally {\n            running = false;\n        }\n    }\n\n    @Override public boolean isRunning() { return running; }\n\n    @Override public boolean isAutoStartup() { return true; }\n\n    // Start BEFORE the web server (default is 0). Lower = earlier.\n    @Override public int getPhase() { return -1; }\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,o.jsxs)(n.p,{children:["First, clone and enter the ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd java/widget-store\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then follow the instructions in the README to build and run the app!"})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},3092:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/widget_store_ui-a4c2b42a8c4b98b711e3a2aa714511c9.png"},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var r=t(6540);const o={},s=r.createContext(o);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);