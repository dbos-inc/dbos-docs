"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[9160],{5782:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"golang/tutorials/workflow-communication","title":"Communicating with Workflows","description":"DBOS provides a few different ways to communicate with your workflows.","source":"@site/docs/golang/tutorials/workflow-communication.md","sourceDirName":"golang/tutorials","slug":"/golang/tutorials/workflow-communication","permalink":"/golang/tutorials/workflow-communication","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":48,"frontMatter":{"sidebar_position":48,"title":"Communicating with Workflows"},"sidebar":"tutorialSidebar","previous":{"title":"Queues & Concurrency","permalink":"/golang/tutorials/queue-tutorial"},"next":{"title":"Workflow Management","permalink":"/golang/tutorials/workflow-management"}}');var s=t(4848),a=t(8453);const o={sidebar_position:48,title:"Communicating with Workflows"},i=void 0,l={},c=[{value:"Workflow Messaging and Notifications",id:"workflow-messaging-and-notifications",level:2},{value:"Send",id:"send",level:4},{value:"Recv",id:"recv",level:4},{value:"Messages Example",id:"messages-example",level:4},{value:"Reliability Guarantees",id:"reliability-guarantees",level:4},{value:"Workflow Events",id:"workflow-events",level:2},{value:"SetEvent",id:"setevent",level:4},{value:"GetEvent",id:"getevent",level:4},{value:"Events Example",id:"events-example",level:4},{value:"Reliability Guarantees",id:"reliability-guarantees-1",level:4},{value:"Workflow Streaming",id:"workflow-streaming",level:2},{value:"Writing to Streams",id:"writing-to-streams",level:4},{value:"Reading from Streams",id:"reading-from-streams",level:4},{value:"Stream Reliability Guarantees",id:"stream-reliability-guarantees",level:4}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"DBOS provides a few different ways to communicate with your workflows.\nYou can:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#workflow-messaging-and-notifications",children:"Send messages to workflows"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#workflow-events",children:"Publish events from workflows for clients to read"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#workflow-streaming",children:"Stream values from workflows to clients"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"workflow-messaging-and-notifications",children:"Workflow Messaging and Notifications"}),"\n",(0,s.jsx)(n.p,{children:"You can send messages to a specific workflow.\nThis is useful for signaling a workflow or sending notifications to it while it's running."}),"\n",(0,s.jsx)("img",{src:t(4737).A,alt:"DBOS Steps",width:"750",className:"custom-img"}),"\n",(0,s.jsx)(n.h4,{id:"send",children:"Send"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func Send[P any](ctx DBOSContext, destinationID string, message P, topic string) error\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can call ",(0,s.jsx)(n.code,{children:"Send()"})," to send a message to a workflow.\nMessages can optionally be associated with a topic and are queued on the receiver per topic."]}),"\n",(0,s.jsx)(n.h4,{id:"recv",children:"Recv"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func Recv[R any](ctx DBOSContext, topic string, timeout time.Duration) (R, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Workflows can call ",(0,s.jsx)(n.code,{children:"Recv()"})," to receive messages sent to them, optionally for a particular topic.\nEach call to ",(0,s.jsx)(n.code,{children:"Recv()"})," waits for and consumes the next message to arrive in the queue for the specified topic, returning an error if the wait times out.\nIf the topic is not specified, this method only receives messages sent without a topic."]}),"\n",(0,s.jsx)(n.h4,{id:"messages-example",children:"Messages Example"}),"\n",(0,s.jsx)(n.p,{children:"Messages are especially useful for sending notifications to a workflow.\nFor example, in an e-commerce application, the checkout workflow, after redirecting customers to a secure payments service, must wait for a notification from that service that the payment has finished processing."}),"\n",(0,s.jsxs)(n.p,{children:["To wait for this notification, the payments workflow uses ",(0,s.jsx)(n.code,{children:"Recv()"}),", executing failure-handling code if the notification doesn't arrive in time:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'const PaymentStatusTopic = "payment_status"\n\nfunc checkoutWorkflow(ctx dbos.DBOSContext, orderData OrderData) (string, error) {\n    // Process initial checkout steps...\n\n    // Wait for payment notification with a 5-minute timeout\n    notification, err := dbos.Recv[PaymentNotification](ctx, PaymentStatusTopic, 5*time.Minute)\n    if err != nil {\n        ... // Handle timeout or other errors\n    }\n\n    // Handle the notification\n    if notification.Status == "completed" {\n      ... // Handle the notification.\n    } else {\n      ... // Handle a failure\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["A webhook waits for the payment processor to send the notification, then uses ",(0,s.jsx)(n.code,{children:"Send()"})," to forward it to the workflow:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func paymentWebhookHandler(w http.ResponseWriter, r *http.Request) {\n    // Parse the notification from the payment processor\n    notification := ...\n    // Retrieve the workflow ID from notification metadata\n    workflowID := ...\n\n    // Send the notification to the waiting workflow\n    err := dbos.Send(dbosContext, workflowID, notification, PaymentStatusTopic)\n    if err != nil {\n        http.Error(w, "Failed to send notification", http.StatusInternalServerError)\n        return\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"reliability-guarantees",children:"Reliability Guarantees"}),"\n",(0,s.jsxs)(n.p,{children:["All messages are persisted to the database, so if ",(0,s.jsx)(n.code,{children:"Send"})," completes successfully, the destination workflow is guaranteed to be able to ",(0,s.jsx)(n.code,{children:"Recv"})," it.\nIf you're sending a message from a workflow, DBOS guarantees exactly-once delivery."]}),"\n",(0,s.jsx)(n.h2,{id:"workflow-events",children:"Workflow Events"}),"\n",(0,s.jsxs)(n.p,{children:["Workflows can publish ",(0,s.jsx)(n.em,{children:"events"}),", which are key-value pairs associated with the workflow.\nThey are useful for publishing information about the status of a workflow or to send a result to clients while the workflow is running."]}),"\n",(0,s.jsx)("img",{src:t(7534).A,alt:"DBOS Steps",width:"750",className:"custom-img"}),"\n",(0,s.jsx)(n.h4,{id:"setevent",children:"SetEvent"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func SetEvent[P any](ctx DBOSContext, key string, message P) error\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Any workflow can call ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#setevent",children:(0,s.jsx)(n.code,{children:"SetEvent"})})," to publish a key-value pair, or update its value if has already been published."]}),"\n",(0,s.jsx)(n.h4,{id:"getevent",children:"GetEvent"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func GetEvent[R any](ctx DBOSContext, targetWorkflowID, key string, timeout time.Duration) (R, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can call ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#getevent",children:(0,s.jsx)(n.code,{children:"GetEvent"})})," to retrieve the value published by a particular workflow ID for a particular key.\nIf the event does not yet exist, this call waits for it to be published, returning an error if the wait times out."]}),"\n",(0,s.jsx)(n.h4,{id:"events-example",children:"Events Example"}),"\n",(0,s.jsx)(n.p,{children:"Events are especially useful for writing interactive workflows that communicate information to their caller.\nFor example, in an e-commerce application, the checkout workflow, after validating an order, directs the customer to a secure payments service to handle credit card processing.\nTo communicate the payments URL to the customer, it uses events."}),"\n",(0,s.jsxs)(n.p,{children:["The checkout workflow emits the payments URL using ",(0,s.jsx)(n.code,{children:"SetEvent()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'const PaymentURLKey = "payment_url"\n\nfunc checkoutWorkflow(ctx dbos.DBOSContext, orderData OrderData) (string, error) {\n    // Process order validation...\n\n    paymentsURL := ...\n    err := dbos.SetEvent(ctx, PaymentURLKey, paymentsURL)\n    if err != nil {\n        return "", fmt.Errorf("failed to set payment URL event: %w", err)\n    }\n\n    // Continue with checkout process...\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The HTTP handler that originally started the workflow uses ",(0,s.jsx)(n.code,{children:"GetEvent()"})," to await this URL, then redirects the customer to it:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func webCheckoutHandler(dbosContext dbos.DBOSContext, w http.ResponseWriter, r *http.Request) {\n    orderData := parseOrderData(r) // Parse order from request\n\n    handle, err := dbos.RunWorkflow(dbosContext, checkoutWorkflow, orderData)\n    if err != nil {\n        http.Error(w, "Failed to start checkout", http.StatusInternalServerError)\n        return\n    }\n\n    // Wait up to 30 seconds for the payment URL event\n    url, err := dbos.GetEvent[string](dbosContext, handle.GetWorkflowID(), PaymentURLKey, 30*time.Second)\n    if err != nil {\n        // Handle a timeout\n    }\n\n    // Redirect the customer\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"reliability-guarantees-1",children:"Reliability Guarantees"}),"\n",(0,s.jsxs)(n.p,{children:["All events are persisted to the database, so the latest version of an event is always retrievable.\nAdditionally, if ",(0,s.jsx)(n.code,{children:"GetEvent"})," is called in a workflow, the retrieved value is persisted in the database so workflow recovery can use that value, even if the event is later updated."]}),"\n",(0,s.jsx)(n.h2,{id:"workflow-streaming",children:"Workflow Streaming"}),"\n",(0,s.jsx)(n.p,{children:"Workflows can stream data in real time to clients.\nThis is useful for streaming results from a long-running workflow or LLM call, or for monitoring and progress reporting."}),"\n",(0,s.jsx)("img",{src:t(538).A,alt:"DBOS Streams",width:"750",className:"custom-img"}),"\n",(0,s.jsx)(n.h4,{id:"writing-to-streams",children:"Writing to Streams"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func WriteStream[P any](ctx DBOSContext, key string, value P) error\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can write values to a stream from a workflow or its steps using ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#writestream",children:(0,s.jsx)(n.code,{children:"WriteStream"})}),".\nA workflow may have any number of streams, each identified by a unique key."]}),"\n",(0,s.jsxs)(n.p,{children:["When you are done writing to a stream, you should close it with ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#closestream",children:(0,s.jsx)(n.code,{children:"CloseStream"})}),".\nOtherwise, streams are automatically closed when the workflow terminates."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func CloseStream(ctx DBOSContext, key string) error\n"})}),"\n",(0,s.jsx)(n.p,{children:"DBOS streams are immutable and append-only.\nWrites to a stream from a workflow happen exactly-once.\nWrites to a stream from a step happen at-least-once; if a step fails and is retried, it may write to the stream multiple times.\nReaders will see all values written to the stream from all tries of the step in the order in which they were written."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example syntax:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func producerWorkflow(ctx dbos.DBOSContext, _ string) (string, error) {\n    err := dbos.WriteStream(ctx, "progress", "step 1 complete")\n    if err != nil {\n        return "", err\n    }\n    err = dbos.WriteStream(ctx, "progress", "step 2 complete")\n    if err != nil {\n        return "", err\n    }\n    err = dbos.CloseStream(ctx, "progress")\n    if err != nil {\n        return "", err\n    }\n    return "done", nil\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"reading-from-streams",children:"Reading from Streams"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func ReadStream[R any](ctx DBOSContext, workflowID string, key string) ([]R, bool, error)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can read values from a stream from anywhere using ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#readstream",children:(0,s.jsx)(n.code,{children:"ReadStream"})}),".\nThis function reads all values from a stream identified by a workflow ID and key.\nIt blocks until the stream is closed or the workflow becomes inactive (status is not ",(0,s.jsx)(n.code,{children:"PENDING"})," or ",(0,s.jsx)(n.code,{children:"ENQUEUED"}),").\nIt returns the values, whether the stream is closed, and any error."]}),"\n",(0,s.jsxs)(n.p,{children:["You can also read from a stream asynchronously using ",(0,s.jsx)(n.a,{href:"/golang/reference/methods#readstreamasync",children:(0,s.jsx)(n.code,{children:"ReadStreamAsync"})}),", which returns a channel:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"func ReadStreamAsync[R any](ctx DBOSContext, workflowID string, key string) (<-chan StreamValue[R], error)\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type StreamValue[R any] struct {\n    Value  R     // The stream value (zero value if error/closed)\n    Err    error // Error if one occurred (nil otherwise)\n    Closed bool  // Whether the stream is closed\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can also read from a stream from outside a DBOS application with a ",(0,s.jsx)(n.a,{href:"/golang/reference/client#stream-methods",children:"DBOS Client"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example syntax:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'// Blocking read: wait for all values, then process\nvalues, closed, err := dbos.ReadStream[string](ctx, workflowID, "progress")\nif err != nil {\n    return err\n}\nfor _, value := range values {\n    fmt.Printf("Received: %s\\n", value)\n}\n\n// Async read: process values as they arrive\nch, err := dbos.ReadStreamAsync[string](ctx, workflowID, "progress")\nif err != nil {\n    return err\n}\nfor streamValue := range ch {\n    if streamValue.Err != nil {\n        return streamValue.Err\n    }\n    if streamValue.Closed {\n        break\n    }\n    fmt.Printf("Received: %s\\n", streamValue.Value)\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"stream-reliability-guarantees",children:"Stream Reliability Guarantees"}),"\n",(0,s.jsxs)(n.p,{children:["All stream values are persisted to the database, so streams are durable and survive restarts.\nIf ",(0,s.jsx)(n.code,{children:"WriteStream"})," is called from a workflow, the write is exactly-once.\nIf called from a step, the write is at-least-once (the step may be retried on failure)."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},7534:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/workflow-events-8ca174bbcef9b282b65a91c1fcf83a26.png"},4737:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/workflow-messages-227c431621648ccf5b74b8b69ad7ffa0.png"},538:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/workflow-streams-2f388ab9c4c12cb7ce0280712bb9365c.png"},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var r=t(6540);const s={},a=r.createContext(s);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);