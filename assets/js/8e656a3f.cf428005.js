"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[5849],{3257:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"integrations/vercel","title":"Vercel","description":"You can use DBOS to add durable workflows, background jobs, or AI agents to your Next.js app hosted on Vercel.","source":"@site/docs/integrations/vercel.md","sourceDirName":"integrations","slug":"/integrations/vercel","permalink":"/integrations/vercel","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15,"title":"Vercel"},"sidebar":"tutorialSidebar","previous":{"title":"Supabase","permalink":"/integrations/supabase"},"next":{"title":"Neon","permalink":"/integrations/neon"}}');var t=o(4848),s=o(8453);const i={sidebar_position:15,title:"Vercel"},l="Use DBOS On Vercel",a={},c=[{value:"1. Enqueue Workflows From Server Actions",id:"1-enqueue-workflows-from-server-actions",level:2},{value:"2. Create a Worker in a Vercel Functions",id:"2-create-a-worker-in-a-vercel-functions",level:2},{value:"3. Schedule the Worker with Cron",id:"3-schedule-the-worker-with-cron",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"use-dbos-on-vercel",children:"Use DBOS On Vercel"})}),"\n",(0,t.jsx)(n.p,{children:"You can use DBOS to add durable workflows, background jobs, or AI agents to your Next.js app hosted on Vercel.\nWe recommend the following architecture:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["In your Next.js app, enqueue workflows for execution using the ",(0,t.jsx)(n.a,{href:"/typescript/reference/client",children:"DBOS client"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Create a DBOS worker in a ",(0,t.jsx)(n.a,{href:"https://vercel.com/docs/functions",children:"Vercel Function"})," to serverlessly dequeue and execute your workflows."]}),"\n",(0,t.jsxs)(n.li,{children:["Configure a ",(0,t.jsx)(n.a,{href:"https://vercel.com/docs/cron-jobs",children:"Vercel cron job"})," to periodically start your worker to poll for new workflows to execute."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Your DBOS client and worker should both connect to a Postgres database\u2014for example a Supabase or Neon database configured through ",(0,t.jsx)(n.a,{href:"https://vercel.com/docs/postgres",children:"Vercel Postgres"}),"."]}),"\n",(0,t.jsx)("img",{src:o(6423).A,alt:"Vercel Architecture",width:"800",className:"custom-img"}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsxs)(n.p,{children:["You can check out a working example of this integration ",(0,t.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-vercel-integration",children:"on GitHub"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"1-enqueue-workflows-from-server-actions",children:"1. Enqueue Workflows From Server Actions"}),"\n",(0,t.jsxs)(n.p,{children:["First, enqueue workflows from your Next.js app using the ",(0,t.jsx)(n.a,{href:"/typescript/reference/client",children:"DBOS client"})," in your ",(0,t.jsx)(n.a,{href:"https://nextjs.org/docs/app/getting-started/updating-data",children:"server actions"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"For example, here's a server action that enqueues a workflow to execute in the background:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="app/actions.ts"',children:"'use server';\n\nimport { DBOSClient } from '@dbos-inc/dbos-sdk';\n\nexport async function enqueueWorkflow() {\n    console.log('Enqueueing DBOS workflow');\n    const client = await DBOSClient.create({ systemDatabaseUrl: process.env.DBOS_SYSTEM_DATABASE_URL });\n    await client.enqueue({\n        workflowName: 'exampleWorkflow',\n        queueName: 'exampleQueue',\n    });\n    await client.destroy();\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"You can also use the client to list past workflows or retrieve their results."}),"\n",(0,t.jsx)(n.h2,{id:"2-create-a-worker-in-a-vercel-functions",children:"2. Create a Worker in a Vercel Functions"}),"\n",(0,t.jsxs)(n.p,{children:["Next, create a DBOS worker in a ",(0,t.jsx)(n.a,{href:"https://vercel.com/docs/functions",children:"Vercel Function"})," to serverlessly dequeue and execute your workflows.\nIn the Vercel Function, define and register your workflows, steps, and queues:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="app/api/dbos/route.ts"',children:"// Define a workflow and steps\nasync function stepOne() {\n  // Sleep 3 seconds\n  await new Promise((resolve) => setTimeout(resolve, 3000));\n  DBOS.logger.info('Step one completed!');\n}\n\nasync function stepTwo() {\n  // Sleep 3 seconds\n  await new Promise((resolve) => setTimeout(resolve, 3000));\n  DBOS.logger.info('Step two completed!');\n}\n\nasync function exampleFunction() {\n  await DBOS.runStep(() => stepOne(), { name: 'stepOne' });\n  await DBOS.runStep(() => stepTwo(), { name: 'stepTwo' });\n}\n\n// Register your workflows and queues with DBOS\nDBOS.registerWorkflow(exampleFunction, {\n  name: 'exampleWorkflow',\n});\nnew WorkflowQueue('exampleQueue');\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then, configure and launch DBOS on worker startup.\nWhen started, the worker will poll your queues and execute your workflows, waiting until all enqueued workflows complete or a timeout is reached.\nIf some workflows are still executing when the worker times out, don't worry\u2014DBOS will automatically recover them when the worker next starts."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="app/api/dbos/route.ts"',children:"// Configure and launch DBOS. It will automatically dequeue and execute workflows.\nDBOS.setConfig({\n  name: 'dbos-vercel-integration',\n  systemDatabaseUrl: process.env.DBOS_SYSTEM_DATABASE_URL,\n  runAdminServer: false,\n});\nawait DBOS.launch();\n\n// After the worker Vercel function is launched,\n// it waits for either all enqueued workflows\n// to complete or for a timeout to be reached\nasync function waitForQueuedWorkflowsToComplete(timeoutMs: number): Promise<void> {\n  const startTime = Date.now();\n  const intervalMs = 1000;\n  while (true) {\n    if (Date.now() - startTime >= timeoutMs) {\n      throw new Error(`Timeout reached after ${timeoutMs}ms - queued workflows still exist`);\n    }\n    const queuedWorkflows = await DBOS.listQueuedWorkflows({});\n    if (queuedWorkflows.length === 0) {\n      console.log('All queued workflows completed');\n      return;\n    }\n    console.log(`${queuedWorkflows.length} workflows still queued, waiting...`);\n    await new Promise<void>((resolve) => setTimeout(resolve, intervalMs));\n  }\n}\n\nexport async function GET(request: Request) {\n  waitUntil(waitForQueuedWorkflowsToComplete(300000));\n  return new Response(`Starting DBOS worker! Request URL: ${request.url}`);\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"3-schedule-the-worker-with-cron",children:"3. Schedule the Worker with Cron"}),"\n",(0,t.jsxs)(n.p,{children:["Finally, configure a ",(0,t.jsx)(n.a,{href:"https://vercel.com/docs/cron-jobs",children:"Vercel cron job"})," to periodically start your worker to poll for new workflows to execute.\nVercel will automatically scale the worker function to handle your workflows."]}),"\n",(0,t.jsx)(n.p,{children:"For example, you might configure your worker to poll for new workflows once a minute:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="vercel.json"',children:'{\n  "$schema": "https://openapi.vercel.sh/vercel.json",\n  "crons": [\n    {\n      "path": "/api/dbos",\n      "schedule": "* * * * *"\n    }\n  ]\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},6423:(e,n,o)=>{o.d(n,{A:()=>r});const r=o.p+"assets/images/vercel-architecture-5d0802f69228c006fc93cbab6080f372.png"},8453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>l});var r=o(6540);const t={},s=r.createContext(t);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);