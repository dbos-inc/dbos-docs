"use strict";(self.webpackChunkoperon_docs=self.webpackChunkoperon_docs||[]).push([[415],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),h=a,m=p["".concat(l,".").concat(h)]||p[h]||d[h]||i;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:a,o[1]=s;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},5290:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const i={sidebar_position:9,title:"Authentication and Authorization",description:"Use declarative security and middleware in Operon"},o=void 0,s={unversionedId:"tutorials/authentication-authorization",id:"tutorials/authentication-authorization",title:"Authentication and Authorization",description:"Use declarative security and middleware in Operon",source:"@site/docs/tutorials/authentication-authorization.md",sourceDirName:"tutorials",slug:"/tutorials/authentication-authorization",permalink:"/tutorials/authentication-authorization",draft:!1,tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9,title:"Authentication and Authorization",description:"Use declarative security and middleware in Operon"},sidebar:"tutorialSidebar",previous:{title:"Testing and Debugging",permalink:"/tutorials/testing-tutorial"},next:{title:"Using Prisma",permalink:"/tutorials/using-prisma"}},l={},u=[{value:"Authentication Middleware",id:"authentication-middleware",level:2},{value:"Authorization Decorators",id:"authorization-decorators",level:2},{value:"Example",id:"example",level:2}],c={toc:u},p="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This section covers declarative authentication and authorization in Operon."),(0,a.kt)("p",null,"Operon supports modular, built-in declarative security: you can use the ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/decorators#authentication"},(0,a.kt)("inlineCode",{parentName:"a"},"@Authentication"))," class decorator to make user identities available to Operon contexts. Further, you can associate operations with a list of permitted roles using the ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/decorators#requiredrole"},(0,a.kt)("inlineCode",{parentName:"a"},"@RequiredRole"))," API."),(0,a.kt)("admonition",{title:"note",type:"info"},(0,a.kt)("p",{parentName:"admonition"},"You can fully implement authentication and authorization using custom ",(0,a.kt)("a",{parentName:"p",href:"../tutorials/http-serving-tutorial#middleware"},"HTTP middleware")," which will run before the request reaches the handler. This section describes mechanisms Operon provides to make it easier.")),(0,a.kt)("h2",{id:"authentication-middleware"},"Authentication Middleware"),(0,a.kt)("p",null,"To instruct Operon to perform authentication for an HTTP endpoint, you can use the ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/decorators#authentication"},(0,a.kt)("inlineCode",{parentName:"a"},"@Authentication"))," class decorator to register HTTP middleware with your custom authentication logic (for example validating a ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io/"},"JSON Web Token")," and retrieving user credentials and permissions from the decoded token).\nThe decorator should return a structure containing identity and claimed roles:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'return {\n    authenticatedUser: "Mary",\n    authenticatedRoles: ["user", "admin"],\n};\n')),(0,a.kt)("p",null,"When serving a request from an HTTP endpoint, Operon runs the authentication middleware before running the requested operation and makes this information available in the operation's ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/contexts#operoncontext"},"context"),"."),(0,a.kt)("h2",{id:"authorization-decorators"},"Authorization Decorators"),(0,a.kt)("p",null,"To declare a list of roles that are authorized to run the methods in a class, use the ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/decorators#defaultrequiredrole"},(0,a.kt)("inlineCode",{parentName:"a"},"@DefaultRequiredRole"))," class decorator:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@DefaultRequiredRole(['user'])\nclass Operations\n{\n  // Most operations will be user-level\n}\n")),(0,a.kt)("p",null,"At runtime, before running an operation, Operon verifies that the operation context contains an authenticated role listed in its required roles.\nFor exceptions, requiring more or less privilege than the default, you can specify ",(0,a.kt)("a",{parentName:"p",href:"../api-reference/decorators#requiredrole"},(0,a.kt)("inlineCode",{parentName:"a"},"@RequiredRole"))," at the method level"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@DefaultRequiredRole(['user'])\nclass Operations\n{\n  // Most operations will be user-level\n\n  // Registering a new user doesn't require privilege\n  @RequiredRole([])\n  static async doRegister(ctx: OperonContext, firstName: string, lastName: string){}\n\n  // Deleting a user requires escalated privilege\n  @RequiredRole(['admin'])\n  static async deleteOtherUser(ctx: OperonContext, otherUser: string){}\n}\n")),(0,a.kt)("h2",{id:"example"},"Example"),(0,a.kt)("p",null,"In this example, we demonstrate how to use Operon declarative security:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'// Resolve request identity using HTTP headers.\n// You can replace this logic with robust methods such as JWT.\nconst authenticationMiddleware = (ctx: MiddlewareContext) => {\n  return {\n    // Extract username from headers\n    authenticatedUser: ctx.koaContext?.header.username,\n    // Attribute role "appUser" to incoming requests\n    authenticatedRoles: ["appUser"],\n  };\n};\n\n@Authentication(authenticationMiddleware)\n@DefaultRequiredRole("appUser")\nexport class Hello {\n  ...\n}\n')),(0,a.kt)("p",null,"Here, we instruct the ",(0,a.kt)("inlineCode",{parentName:"p"},"Hello")," class to run ",(0,a.kt)("inlineCode",{parentName:"p"},"authenticationMiddleware")," on all incoming HTTP requests.\nWe require requests to authenticate with the ",(0,a.kt)("inlineCode",{parentName:"p"},"appUser")," role to reach any HTTP handler declared in ",(0,a.kt)("inlineCode",{parentName:"p"},"Hello"),".\nThe authentication function simply parses the username from the HTTP headers.\nYou can replace this with a more robust authentication method, such as ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io/"},"JSON Web Tokens"),"."))}d.isMDXComponent=!0}}]);