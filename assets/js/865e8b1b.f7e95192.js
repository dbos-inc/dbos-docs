"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[6200],{4561:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"typescript/tutorials/logging","title":"Logging & Tracing","description":"Logging","source":"@site/docs/typescript/tutorials/logging.md","sourceDirName":"typescript/tutorials","slug":"/typescript/tutorials/logging","permalink":"/typescript/tutorials/logging","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":70,"frontMatter":{"sidebar_position":70,"title":"Logging & Tracing"},"sidebar":"tutorialSidebar","previous":{"title":"Upgrading Workflow Code","permalink":"/typescript/tutorials/upgrading-workflows"},"next":{"title":"Using Typescript Objects","permalink":"/typescript/tutorials/instantiated-objects"}}');var s=t(4848),a=t(8453);const o={sidebar_position:70,title:"Logging & Tracing"},i=void 0,c={},l=[{value:"Logging",id:"logging",level:3},{value:"Tracing",id:"tracing",level:3},{value:"Current Context Span",id:"current-context-span",level:4},{value:"Instrumentation",id:"instrumentation",level:4},{value:"Middleware",id:"middleware",level:4},{value:"OpenTelemetry Export",id:"opentelemetry-export",level:3}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"logging",children:"Logging"}),"\n",(0,s.jsxs)(n.p,{children:["For convenience, DBOS provides a logging facility accessed via ",(0,s.jsx)(n.a,{href:"/typescript/reference/methods#dboslogger",children:(0,s.jsx)(n.code,{children:"DBOS.logger"})}),". Use of this logger is ",(0,s.jsx)(n.strong,{children:"optional"}),".\nFor example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'DBOS.logger.info("Welcome to DBOS!");\n'})}),"\n",(0,s.jsx)(n.p,{children:"Entries logged to the DBOS logger are automatically augmented with DBOS context information, such as the current workflow state."}),"\n",(0,s.jsxs)(n.p,{children:["You can ",(0,s.jsx)(n.a,{href:"/typescript/reference/configuration",children:"configure"})," the log level of this built-in logger:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"DBOS.setConfig({\n  name: 'my-app',\n  logLevel: \"info\",\n});\nawait DBOS.launch();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Setting ",(0,s.jsx)(n.code,{children:"logLevel"})," also affects any log messages emitted by the DBOS library."]}),"\n",(0,s.jsx)(n.h3,{id:"tracing",children:"Tracing"}),"\n",(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsx)(n.p,{children:"To use OpenTelemetry features such as tracing and export, you must install the DBOS OpenTelemetry dependencies through:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npm i @dbos-inc/otel@latest\n"})}),(0,s.jsxs)(n.p,{children:["You must also enable OpenTelemetry in DBOS configuration through the ",(0,s.jsx)(n.code,{children:"enableOTLP"})," flag:"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'DBOS.setConfig({\n  "name": "dbos-node-starter",\n  "systemDatabaseUrl": process.env.DBOS_SYSTEM_DATABASE_URL,\n  "enableOTLP": true,\n});\n'})})]}),"\n",(0,s.jsxs)(n.p,{children:["DBOS automatically constructs ",(0,s.jsx)(n.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," ",(0,s.jsx)(n.a,{href:"https://opentelemetry.io/docs/concepts/signals/traces/#spans",children:"spans"})," for all workflows and their steps.  These spans are attached to the current trace if one exists, otherwise DBOS will create a new trace."]}),"\n",(0,s.jsx)(n.p,{children:"For example, if an instrumented HTTP server endpoint calls a workflow that then calls a step, DBOS will construct spans for both the workflow and the step.\nThe step span will be a child of the workflow span, and the workflow span will be a child of the HTTP endpoint's span.  All spans will belong to the trace started by the HTTP server."}),"\n",(0,s.jsx)(n.p,{children:"If the workflow is invoked from outside an instrumented HTTP endpoint, DBOS will still create spans for the workflow and its steps, placing them in a new, standalone trace."}),"\n",(0,s.jsx)(n.h4,{id:"current-context-span",children:"Current Context Span"}),"\n",(0,s.jsxs)(n.p,{children:["Within workflows and steps, the current tracing span can be accessed in the standard way using ",(0,s.jsx)(n.code,{children:"trace.getSpan(context.active())"}),". In the example below, DBOS creates a span for the workflow and one for each of the two steps within it. The step code can then add events to the span, such as ",(0,s.jsx)(n.code,{children:"Step 1 proceeding normally"})," in the first step:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const twoStepWorkflow = DBOS.registerWorkflow(async() => {\n  await DBOS.runStep(async() => {\n    const span = trace.getSpan(context.active());\n    span?.addEvent(\'Step 1 proceeding normally\');\n    return Promise.resolve("Step1");\n  }, {name: "step1"});\n  await DBOS.runStep(async() => {return Promise.resolve("Step2");}, {name: "step2"});\n}, {name: "twoStepWorkflow"});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can access the current DBOS-created span via ",(0,s.jsx)(n.a,{href:"/typescript/reference/methods#dbosspan",children:(0,s.jsx)(n.code,{children:"DBOS.span"})}),"."]}),"\n",(0,s.jsx)(n.h4,{id:"instrumentation",children:"Instrumentation"}),"\n",(0,s.jsx)(n.p,{children:"Use of HTTP server instrumentation ensures that traces and spans are created for incoming HTTP requests, and that DBOS spans will get added to these contexts.  The choice of instrumentation package depends on the server in use.  For koa:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// tracing.ts\nimport { NodeSDK } from '@opentelemetry/sdk-node';\nimport { KoaInstrumentation } from '@opentelemetry/instrumentation-koa';\nimport { HttpInstrumentation } from '@opentelemetry/instrumentation-http';\nimport { ConsoleSpanExporter } from '@opentelemetry/sdk-trace-base';\nimport { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-base';\n\nconst sdk = new NodeSDK({\n  spanProcessor: new SimpleSpanProcessor(new ConsoleSpanExporter()),\n  instrumentations: [\n    new HttpInstrumentation(),\n    new KoaInstrumentation(),\n  ],\n});\n\nexport async function startTracing() {\n  await sdk.start();\n  console.log('OpenTelemetry tracing initialized');\n}\n\nexport async function stopTracing() {\n  await sdk.shutdown();\n}\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"import"})," order for instrumentation is very sensitive, and exact setup details depend on specific versions of the ",(0,s.jsx)(n.code,{children:"@opentelemetry"})," libraries.  Consult their documentation and examples."]})}),"\n",(0,s.jsx)(n.p,{children:"Then, import and start tracing before your app is launched:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// main.ts\n// Import tracing libraries first (see above)\nimport { startTracing } from './tracing';\n// AFTER tracing is initialized, import the app:\nimport { launchApp } from './app';\n\nasync function main()\n{\n  await startTracing();\n  await launchApp(); // DBOS and Koa will get set up in here\n}\n\nmain().then(()=>{}).catch(console.error);\n"})}),"\n",(0,s.jsx)(n.h4,{id:"middleware",children:"Middleware"}),"\n",(0,s.jsx)(n.p,{children:"To integrate your HTTP server with tracing without relying on auto-instrumentation packages, you can explicitly manage the tracing context using middleware."}),"\n",(0,s.jsxs)(n.p,{children:["The standard way to make a span available via ",(0,s.jsx)(n.code,{children:"trace.getSpan(context.active())"})," is by activating it with ",(0,s.jsx)(n.code,{children:"context.with(...)"}),".  In Koa and similar HTTP server frameworks, this can be done directly in middleware. For example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Middleware to apply during processing of HTTP requests\nconst koaOtelMiddleware: Koa.Middleware = async (ctx, next) => {\n  const span = tracer.startSpan(`HTTP ${ctx.method} ${ctx.path}`, {\n    // Add attributes to meet your needs\n    attributes: {\n      'http.method': ctx.method,\n      'http.url': ctx.url,\n    },\n  });\n\n  // `context.with` is the key ingredient\n  await context.with(trace.setSpan(context.active(), span), async () => {\n    try {\n      // Call the next middleware/handler within the span context\n      // DBOS and other logic inside will contribute to the span\n      await next();\n\n      span.setAttribute('http.status_code', ctx.status);\n      if (ctx.status >= 400) {\n        span.setStatus({ code: SpanStatusCode.ERROR });\n      }\n    } catch (err) {\n      span.recordException(err);\n      span.setStatus({ code: SpanStatusCode.ERROR });\n      throw err;\n    } finally {\n      span.end(); // Always end the span\n    }\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"opentelemetry-export",children:"OpenTelemetry Export"}),"\n",(0,s.jsx)(n.p,{children:"If you do not already have export set up in your application, you can use DBOS configuration to export traces to any OpenTelemetry Protocol (OTLP)-compliant receiver."}),"\n",(0,s.jsxs)(n.p,{children:["You can ",(0,s.jsx)(n.a,{href:"/typescript/reference/configuration",children:"configure"})," a custom export target.\nFor example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'DBOS.setConfig({\n  name: \'my-app\',\n  otlpTracesEndpoints: ["http://localhost:4318/v1/traces"],\n  otlpLogsEndpoints: ["http://localhost:4318/v1/logs"]\n});\nawait DBOS.launch();\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For example, try using ",(0,s.jsx)(n.a,{href:"https://www.jaegertracing.io/docs/latest/getting-started/",children:"Jaeger"})," to visualize the traces of your local application, or export your logs and traces to ",(0,s.jsx)(n.a,{href:"../../integrations/logfire",children:"Logfire"}),"."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var r=t(6540);const s={},a=r.createContext(s);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);