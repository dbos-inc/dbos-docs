"use strict";(self.webpackChunkoperon_docs=self.webpackChunkoperon_docs||[]).push([[63],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>y});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=r,y=u["".concat(s,".").concat(d)]||u[d]||m[d]||a;return n?o.createElement(y,i(i({ref:t},c),{},{components:n})):o.createElement(y,i({ref:t},c))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,i=new Array(a);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:r,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8685:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var o=n(7462),r=(n(7294),n(3905));const a={sidebar_position:5,title:"Idempotency",description:"Learn how to make operations idempotent."},i=void 0,l={unversionedId:"tutorials/idempotency-tutorial",id:"tutorials/idempotency-tutorial",title:"Idempotency",description:"Learn how to make operations idempotent.",source:"@site/docs/tutorials/idempotency-tutorial.md",sourceDirName:"tutorials",slug:"/tutorials/idempotency-tutorial",permalink:"/operon-docs/tutorials/idempotency-tutorial",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Idempotency",description:"Learn how to make operations idempotent."},sidebar:"tutorialSidebar",previous:{title:"Workflows",permalink:"/operon-docs/tutorials/workflow-tutorial"},next:{title:"Workflow Communication",permalink:"/operon-docs/tutorials/workflow-communication-tutorial"}},s={},p=[{value:"Setting Idempotency Keys",id:"setting-idempotency-keys",level:3},{value:"Manually Setting Idempotency Keys",id:"manually-setting-idempotency-keys",level:3},{value:"Idempotency Example",id:"idempotency-example",level:3}],c={toc:p},u="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"In this guide, you'll learn how to make operations idempotent."),(0,r.kt)("p",null,"Operon allows users to send any request with an ",(0,r.kt)("em",{parentName:"p"},"idempotency key")," to guarantee it only executes once, even if the request is sent multiple times.\nThis is especially useful if your operation have side effects like mutating database tables or creating resources in external APIs."),(0,r.kt)("h3",{id:"setting-idempotency-keys"},"Setting Idempotency Keys"),(0,r.kt)("p",null,"Operon idempotency keys are 128-bit ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Universally_unique_identifier"},"UUIDs"),".\nIdempotency keys are required to be globally unique for your application.\nThere are many popular libraries for generating UUIDs in Typescript, such as ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/uuid"},"uuid.js"),"."),(0,r.kt)("p",null,"To make a request idempotent, generate a UUID and set the request's ",(0,r.kt)("inlineCode",{parentName:"p"},"operon-workflowuuid")," header field to that UUID.\nNo matter how many times you send that request, as long as each request has the idempotency key set, the operation will only execute once."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"It's not a coincidence that both idempotency keys and ",(0,r.kt)("a",{parentName:"p",href:"./workflow-tutorial#workflow-identity"},"workflow identities")," are UUIDs.\nIf you run a workflow with an idempotency key, the identity of that execution is set to that UUID.")),(0,r.kt)("h3",{id:"manually-setting-idempotency-keys"},"Manually Setting Idempotency Keys"),(0,r.kt)("p",null,"Idempotency keys are not automatically used for ",(0,r.kt)("a",{parentName:"p",href:"./http-serving-tutorial#handlers"},"handlers"),".\nInstead, if you invoke an operation from a handler, you can manually pass in an idempotency key as an argument to ",(0,r.kt)("a",{parentName:"p",href:".."},(0,r.kt)("inlineCode",{parentName:"a"},"context.invoke")),".\nThe syntax for invoking ",(0,r.kt)("inlineCode",{parentName:"p"},"Class.operation")," with an idempotency key is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"  @GetApi(...)\n  static async exampleHandler(handlerCtxt: HandlerContext, ...) {\n    const idempotencyKey = ...;\n    await handlerCtxt.invoke(Class, idempotencyKey).operation(...);\n  }\n")),(0,r.kt)("h3",{id:"idempotency-example"},"Idempotency Example"),(0,r.kt)("p",null,"Let's look at this workflow endpoint from the final step of our ",(0,r.kt)("a",{parentName:"p",href:"../getting-started/quickstart-programming-2"},"quickstart guide"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"  @GetApi('/greeting/:name')\n  @OperonWorkflow()\n  static async helloWorkflow(wfCtxt: WorkflowContext, name: string) {\n    const greeting = await wfCtxt.invoke(Hello).helloTransaction(name);\n    try {\n      await wfCtxt.invoke(Hello).postmanFunction(greeting);\n      return greeting;\n    } catch (e) {\n      console.warn(\"Error sending request:\", e);\n      await wfCtxt.invoke(Hello).rollbackHelloTransaction(name);\n      return `Greeting failed for ${name}\\n`\n    }\n  }\n")),(0,r.kt)("p",null,"Each request to this endpoint has the side effect of incrementing a database counter.\nHowever, if we set the idempotency key, we can make many requests without side effects."),(0,r.kt)("p",null,"If we ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," this endpoint normally multiple times, each request increments the counter:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl http://localhost:3000/greeting/operon\n")),(0,r.kt)("p",null,"However, if we set the idempotency key in the header and send the request many times, each request returns the same response and the workflow only executes once:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -H "operon-workflowuuid: 123e4567-e89b-12d3-a456-426614174000" http://localhost:3000/greeting/operon\n')))}m.isMDXComponent=!0}}]);