"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[6427],{6643:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"python/examples/deploy-tracker-slackbot","title":"CI/CD Slackbot","description":"In this example, we use DBOS and Bolt to build a CI/CD Slackbot that helps you trigger application deployments and track deployment pipeline progress directly from Slack. It listens to commands such as /deploy and /check_status in a Slack channel and posts status updates back to the channel.","source":"@site/docs/python/examples/deploy-tracker-slackbot.md","sourceDirName":"python/examples","slug":"/python/examples/deploy-tracker-slackbot","permalink":"/python/examples/deploy-tracker-slackbot","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":40,"frontMatter":{"displayed_sidebar":"examplesSidebar","sidebar_position":40,"title":"CI/CD Slackbot"},"sidebar":"examplesSidebar","previous":{"title":"Advanced Queue Patterns","permalink":"/python/examples/queue-patterns"},"next":{"title":"Reliable Customer Service Agent","permalink":"/python/examples/customer-service"}}');var o=s(4848),l=s(8453);const a={displayed_sidebar:"examplesSidebar",sidebar_position:40,title:"CI/CD Slackbot"},r=void 0,d={},i=[{value:"Main Deployment Workflow",id:"main-deployment-workflow",level:2},{value:"Concurrency-Limited Queue",id:"concurrency-limited-queue",level:2},{value:"Handle Slash Commands in Slack",id:"handle-slash-commands-in-slack",level:2},{value:"Handle <code>/deploy</code>",id:"handle-deploy",level:3},{value:"Handle <code>/check_status</code>",id:"handle-check_status",level:3},{value:"Try it Yourself!",id:"try-it-yourself",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["In this example, we use DBOS and ",(0,o.jsx)(n.a,{href:"https://slack.dev/bolt-python",children:"Bolt"})," to build a CI/CD Slackbot that helps you trigger application deployments and track deployment pipeline progress directly from Slack. It listens to commands such as ",(0,o.jsx)(n.code,{children:"/deploy"})," and ",(0,o.jsx)(n.code,{children:"/check_status"})," in a Slack channel and posts status updates back to the channel."]}),"\n",(0,o.jsx)(n.p,{children:"This app demonstrates how DBOS enables:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Asynchronous background workflows"})," for each deployment. The Slackbot can't synchronously run an entire deployment pipeline (Slackbots have a ",(0,o.jsx)(n.a,{href:"https://api.slack.com/apis/events-api#retries",children:"3 second"})," time limit), so it instead durably enqueues the pipeline to run in the background."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Concurrency control using queues"}),". In this example, the deployment pipeline utilizes a queue with a concurrency limit of 1, so only one deployment can run at a time."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Real-time status updates"})," via DBOS events, allowing you to monitor the progress of your deployment pipelines."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Durable execution"})," making sure an application deployment resumes from where it left off even if the Slackbot crashes or restarts."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["All source code is ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/deploy-tracker-slackbot",children:"available on GitHub"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Deploy Tracker Slackbot",src:s(952).A+"",width:"1668",height:"900"})}),"\n",(0,o.jsx)(n.h2,{id:"main-deployment-workflow",children:"Main Deployment Workflow"}),"\n",(0,o.jsxs)(n.p,{children:['The core of this Slackbot is the main deployment workflow.\nIt contains three steps: build, test, and deploy. When the workflow starts, it notifies the Slack channel and updates the status to "started". Then, after each step finishes, it sends a Slack message to notify users about its progress. It also uses ',(0,o.jsx)(n.code,{children:"DBOS.set_event"})," to set a custom status object that users can query.\nAfter all steps are complete, it sends a final Slack message to the channel."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'@DBOS.workflow()\ndef deploy_tracker_workflow(user_id: str, channel_id: str):\n    post_slack_message(\n        message=f"Deployment workflow {DBOS.workflow_id} started.", channel=channel_id\n    )\n    # Use DBOS\'s built-in event tracking to mark deployment status\n    DBOS.set_event("deploy_status", "started")\n\n    # Additional steps for deployment can be added here\n    duration = build_step()\n    post_slack_message(\n        message=f"[Workflow {DBOS.workflow_id}] Step *Build \ud83d\udea7* completed in {duration:.2f} seconds.",\n        channel=channel_id,\n    )\n    DBOS.set_event("deploy_status", "build_completed")\n\n    duration = test_step()\n    post_slack_message(\n        message=f"[Workflow {DBOS.workflow_id}] Step *Test \ud83e\uddea* completed in {duration:.2f} seconds.",\n        channel=channel_id,\n    )\n    DBOS.set_event("deploy_status", "tests_completed")\n\n    duration = deploy_step()\n    post_slack_message(\n        message=f"[Workflow {DBOS.workflow_id}] Step *Deploy \ud83d\ude80* completed in {duration:.2f} seconds.",\n        channel=channel_id,\n    )\n    DBOS.set_event("deploy_status", "deployed")\n\n    post_slack_message(\n        message=f"Deployment workflow {DBOS.workflow_id} completed successfully. <@{user_id}> :tada:",\n        channel=channel_id,\n    )\n'})}),"\n",(0,o.jsx)(n.h2,{id:"concurrency-limited-queue",children:"Concurrency-Limited Queue"}),"\n",(0,o.jsxs)(n.p,{children:["To ensure only one deployment workflow runs at a time, we define a queue with ",(0,o.jsx)(n.code,{children:"concurrency=1"}),". This is helpful when the deployment pipeline consumes significant resources and you don't want to exhaust your resource pool when multiple users trigger deployments."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'# Create a queue with concurrency of 1 so only one deployment workflow runs at a time\ntask_queue = Queue(name="deploy-tracker-queue", concurrency=1)\n'})}),"\n",(0,o.jsx)(n.h2,{id:"handle-slash-commands-in-slack",children:"Handle Slash Commands in Slack"}),"\n",(0,o.jsxs)(n.p,{children:["We need to define handlers to handle each Slash Command from Slack. Here, we implement two commands: ",(0,o.jsx)(n.code,{children:"/deploy"})," and ",(0,o.jsx)(n.code,{children:"/check_status"}),"."]}),"\n",(0,o.jsxs)(n.h3,{id:"handle-deploy",children:["Handle ",(0,o.jsx)(n.code,{children:"/deploy"})]}),"\n",(0,o.jsx)(n.p,{children:"This command enqueues a deployment workflow and acknowledges the user as soon as the workflow is confirmed to be enqueued (due to the 3-second limit). It also lists workflows in the queue and provides information on how many workflows are currently queued."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'@app.command("/deploy")\ndef handle_deploy_command(ack, say, command, logger):\n    try:\n        # Acknowledge the command within 3 seconds, after confirming the workflow has enqueued\n        user_id = command["user_id"]\n        channel_id = command["channel_id"]\n        handle = task_queue.enqueue(deploy_tracker_workflow, user_id, channel_id)\n        ack({"response_type": "in_channel"})\n        # Check the queue size, and inform the user if there are pending workflows\n        queued_workflows = DBOS.list_queued_workflows(\n            queue_name="deploy-tracker-queue", load_input=False\n        )\n        queue_size = len(queued_workflows)\n        say(\n            f"Deployment workflow has been enqueued by <@{user_id}>, workflow ID {handle.get_workflow_id()}. Currently {queue_size} workflow(s) in the queue."\n        )\n\n        # Wait for workflow to complete\n        handle.get_result()\n\n    except Exception as e:\n        logger.error(f"Error handling slash command: {e}")\n        say(f"An error occurred while processing your deployment request: {e}")\n'})}),"\n",(0,o.jsxs)(n.h3,{id:"handle-check_status",children:["Handle ",(0,o.jsx)(n.code,{children:"/check_status"})]}),"\n",(0,o.jsx)(n.p,{children:'This endpoint queries the workflow status as well as the custom "deploy_status" event set by the deployment workflow.\nUsers can query the status of their deployment pipelines anytime.'}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'@app.command("/check_status")\ndef handle_check_status_command(ack, body, say, logger):\n    try:\n        # Acknowledge the command within 3 seconds\n        ack({"response_type": "in_channel"})\n        workflow_id = body["text"].strip()\n\n        # Check the workflow status and latest deployment status\n        handle = DBOS.retrieve_workflow(workflow_id, existing_workflow=False)\n        status = handle.get_status().status\n        deploy_status = DBOS.get_event(workflow_id, "deploy_status", 10)\n\n        say(\n            f"Deployment workflow {workflow_id} is currently *{status}*. Latest deployment status: *{deploy_status}*."\n        )\n\n    except Exception as e:\n        logger.error(f"Error handling slash command: {e}")\n        say(f"An error occurred while processing your check status request: {e}")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"try-it-yourself",children:"Try it Yourself!"}),"\n",(0,o.jsxs)(n.p,{children:["Clone and enter the ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps",children:"dbos-demo-apps"})," repository:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/dbos-inc/dbos-demo-apps.git\ncd python/deploy-tracker-slackbot\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Then follow the instructions in the ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/deploy-tracker-slackbot",children:"README"})," to run the app."]})]})}function p(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},952:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/deploy-bot-dc491a02f7d0e8c992e02d1b43423c23.png"},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>r});var t=s(6540);const o={},l=t.createContext(o);function a(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);