"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[1738],{7290:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"typescript/tutorials/orms/using-knex","title":"Using Knex","description":"Learn how to build applications with Knex and DBOS","source":"@site/docs/typescript/tutorials/orms/using-knex.md","sourceDirName":"typescript/tutorials/orms","slug":"/typescript/tutorials/orms/using-knex","permalink":"/typescript/tutorials/orms/using-knex","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"sidebar_position":12,"title":"Using Knex","description":"Learn how to build applications with Knex and DBOS"},"sidebar":"tutorialSidebar","previous":{"title":"Using Drizzle","permalink":"/typescript/tutorials/orms/using-drizzle"},"next":{"title":"Using Prisma","permalink":"/typescript/tutorials/orms/using-prisma"}}');var s=t(4848),r=t(8453);const o={sidebar_position:12,title:"Using Knex",description:"Learn how to build applications with Knex and DBOS"},a=void 0,c={},l=[{value:"Knex Overview",id:"knex-overview",level:2},{value:"Getting Started",id:"getting-started",level:3},{value:"Schema Management",id:"schema-management",level:3},{value:"Using Knex",id:"using-knex",level:3},{value:"Configuring Knex",id:"configuring-knex",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"knex-overview",children:"Knex Overview"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://knexjs.org/",children:"Knex"})," is a popular TypeScript query builder.\nIt allows developers to construct SQL queries in native TypeScript.\nIt also supports querying the database with ",(0,s.jsx)(n.a,{href:"https://knexjs.org/guide/raw.html",children:"raw SQL"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"getting-started",children:"Getting Started"}),"\n",(0,s.jsx)(n.p,{children:"An easy way to get started with Knex is to bootstrap your application with the Knex template.\nTo download it, run:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npx -y @dbos-inc/create@latest -t dbos-knex -n <app-name>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then, build it, run schema migrations, and start the sample app:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm run build\nnpx dbos migrate\nnpx dbos start\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To see that it's working, visit this URL in your browser: ",(0,s.jsx)(n.a,{href:"http://localhost:3000/greeting/dbos",children:"http://localhost:3000/greeting/dbos"}),".  You should get this message: ",(0,s.jsx)(n.code,{children:"Hello, dbos! You have been greeted 1 times."})," Each time you refresh the page, the counter should go up by one."]}),"\n",(0,s.jsx)(n.h3,{id:"schema-management",children:"Schema Management"}),"\n",(0,s.jsxs)(n.p,{children:["We strongly recommend you manage your database schema using migrations.\nKnex provides rich native migration support, with documentation ",(0,s.jsx)(n.a,{href:"https://knexjs.org/guide/migrations.html",children:"here"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"You can create a new migration by running:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npx knex migrate:make <migration-name>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will create a new migration file named ",(0,s.jsx)(n.code,{children:"migrations/<timestamp>_<migration-name>.js"}),".\nYou can implement your migration in this file.\nHere is a simple example from the ",(0,s.jsx)(n.a,{href:"/typescript/programming-guide",children:"programming guide"})," of a migration that creates a ",(0,s.jsx)(n.code,{children:"greetings"})," table with ",(0,s.jsx)(n.code,{children:"name"})," and ",(0,s.jsx)(n.code,{children:"note"})," text fields:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"exports.up = function(knex) {\n    return knex.schema.createTable('greetings', table => {\n        table.text('name');\n        table.text('note');\n      });\n};\n\n\nexports.down = function(knex) {\n    return knex.schema.dropTable('greetings');\n};\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"To run your migrations forward, run:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"npx dbos migrate\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-knex",children:"Using Knex"}),"\n",(0,s.jsxs)(n.p,{children:["When using DBOS, database operations are performed in ",(0,s.jsx)(n.a,{href:"../transaction-tutorial",children:"transaction functions"}),". Transaction functions must be annotated with the ",(0,s.jsx)(n.a,{href:"../../reference/transactapi/dbos-class#dbostransaction",children:(0,s.jsx)(n.code,{children:"@DBOS.transaction"})})," decorator."]}),"\n",(0,s.jsxs)(n.p,{children:["Within the transaction function, access your ",(0,s.jsx)(n.a,{href:"https://knexjs.org/guide/query-builder.html",children:"Knex client"})," from ",(0,s.jsx)(n.code,{children:"DBOS.knexClient"}),".\nFor example, this function inserts a new row into the ",(0,s.jsx)(n.code,{children:"greetings"})," table:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"export class Greetings {\n  @DBOS.transaction()\n  static async InsertGreeting(friend: string, note: string) {\n    await DBOS.knexClient('greetings').insert({\n      name: friend,\n      note: note\n    });\n  }\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["DBOS supports the full ",(0,s.jsx)(n.a,{href:"https://knexjs.org/guide/query-builder.html",children:"Knex Postgres API"}),", but doesn't allow manually committing or aborting transactions.\nInstead, transactions automatically commit when the function successfully returns and abort and roll back if the function throws an exception."]}),"\n",(0,s.jsx)(n.h3,{id:"configuring-knex",children:"Configuring Knex"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["If you are using the ",(0,s.jsx)(n.a,{href:"#getting-started",children:"Knex template"}),", this is done for you."]})}),"\n",(0,s.jsxs)(n.p,{children:["To enable Knex, you must set the ",(0,s.jsx)(n.code,{children:"app_db_client"})," field in the ",(0,s.jsx)(n.a,{href:"/typescript/reference/configuration",children:"DBOS configuration file"})," to ",(0,s.jsx)(n.code,{children:"knex"}),".\nYou should also configure Knex migration commands.\nHere is an example of a configuration file set up for Knex:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"language: node\ndatabase:\n  hostname: localhost\n  port: 5432\n  username: postgres\n  password: ${PGPASSWORD}\n  app_db_client: knex\n  migrate:\n    - npx knex migrate:latest\n  rollback:\n    - npx knex migrate:rollback\nruntimeConfig:\n  entrypoints:\n    - dist/operations.js\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Many Knex commands, such as those for ",(0,s.jsx)(n.a,{href:"#schema-management",children:"schema migration"}),", require a ",(0,s.jsx)(n.a,{href:"https://knexjs.org/guide/migrations.html#knexfile-js",children:(0,s.jsx)(n.code,{children:"knexfile.js"})})," configuration file.\nTo avoid managing your configuration in two places, we recommend ",(0,s.jsx)(n.code,{children:"knexfile.js"})," load configuration information from your ",(0,s.jsx)(n.a,{href:"/typescript/reference/configuration",children:"DBOS configuration file"}),".\nHere is an example of a ",(0,s.jsx)(n.code,{children:"knexfile.js"})," that does this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"const { parseConfigFile } = require('@dbos-inc/dbos-sdk');\n\nconst [dbosConfig, ] = parseConfigFile();\n\nconst config = {\n  client: 'pg',\n  connection: {\n    host: dbosConfig.poolConfig.host,\n    port: dbosConfig.poolConfig.port,\n    user: dbosConfig.poolConfig.user,\n    password: dbosConfig.poolConfig.password,\n    database: dbosConfig.poolConfig.database,\n    ssl: dbosConfig.poolConfig.ssl,\n  },\n  migrations: {\n    directory: './migrations'\n  }\n};\n\nmodule.exports = config;\n\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(6540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);