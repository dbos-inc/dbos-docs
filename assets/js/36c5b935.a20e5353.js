"use strict";(self.webpackChunkdbos_docs=self.webpackChunkdbos_docs||[]).push([[6287],{688:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>s,metadata:()=>a,toc:()=>h});var o=t(4848),i=t(8453);const s={sidebar_position:1,title:"Learn DBOS Python",pagination_next:"python/tutorials/workflow-tutorial",pagination_prev:"quickstart"},r=void 0,a={id:"python/programming-guide",title:"Learn DBOS Python",description:"This tutorial shows you how to use DBOS durable execution to make your Python app resilient to any failure.",source:"@site/docs/python/programming-guide.md",sourceDirName:"python",slug:"/python/programming-guide",permalink:"/python/programming-guide",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Learn DBOS Python",pagination_next:"python/tutorials/workflow-tutorial",pagination_prev:"quickstart"},sidebar:"tutorialSidebar",previous:{title:"Get Started with DBOS",permalink:"/quickstart"},next:{title:"Workflows",permalink:"/python/tutorials/workflow-tutorial"}},l={},h=[{value:"1. Setting Up Your App",id:"1-setting-up-your-app",level:2},{value:"2. Durable Execution with Workflows",id:"2-durable-execution-with-workflows",level:2},{value:"3. Optimizing Database Operations",id:"3-optimizing-database-operations",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{BrowserWindow:t,TabItem:s,Tabs:r}=n;return t||g("BrowserWindow",!0),s||g("TabItem",!0),r||g("Tabs",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["This tutorial shows you how to use DBOS durable execution to make your Python app ",(0,o.jsx)(n.strong,{children:"resilient to any failure."}),"\nFirst, without using DBOS, we'll build an app that records greetings to two different systems: Postgres and an online guestbook.\nThen, we'll add DBOS durable execution to the app in ",(0,o.jsx)(n.strong,{children:"just four lines of code"}),".\nThanks to durable execution, the app will always write to both systems consistently, even if it is interrupted or restarted at any point."]}),"\n",(0,o.jsxs)(n.p,{children:["This guide assumes you have a Postgres database running locally.\nIf not, see the ",(0,o.jsx)(n.a,{href:"/quickstart",children:"quickstart"})," for instructions on how to set it up."]}),"\n",(0,o.jsx)(n.h2,{id:"1-setting-up-your-app",children:"1. Setting Up Your App"}),"\n",(0,o.jsx)(n.p,{children:"Create a folder for your app with a virtual environment, then enter the folder and activate the virtual environment."}),"\n",(0,o.jsxs)(r,{groupId:"operating-systems",className:"small-tabs",children:[(0,o.jsx)(s,{value:"maclinux",label:"macOS or Linux",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\nsource .venv/bin/activate\n"})})}),(0,o.jsx)(s,{value:"win-ps",label:"Windows (PowerShell)",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\n.venv\\Scripts\\activate.ps1\n"})})}),(0,o.jsx)(s,{value:"win-cmd",label:"Windows (cmd)",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"python3 -m venv greeting-guestbook/.venv\ncd greeting-guestbook\n.venv\\Scripts\\activate.bat\n"})})})]}),"\n",(0,o.jsx)(n.p,{children:"Then, install and initialize DBOS:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"pip install dbos\ndbos init\ndbos migrate\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next, let's use FastAPI to write a simple app that greets our friends.\nEvery time the app receives a greeting, it performs two steps:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Sign an online guestbook with the greeting."}),"\n",(0,o.jsx)(n.li,{children:"Record the greeting in the database."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["We deliberately ",(0,o.jsx)(n.strong,{children:"won't"})," use DBOS yet so we can show you how easy it is to add later."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"showLineNumbers",children:'import logging\nimport os\n\nimport requests\nfrom fastapi import FastAPI\nfrom sqlalchemy import create_engine\n\nfrom .schema import dbos_hello\n\napp = FastAPI()\nlogging.basicConfig(level=logging.INFO)\n\n# Sign the guestbook using an HTTP POST request\ndef sign_guestbook(name: str):\n    requests.post(\n        "https://demo-guest-book.cloud.dbos.dev/record_greeting",\n        headers={"Content-Type": "application/json"},\n        json={"name": name},\n    )\n    logging.info(f">>> STEP 1: Signed the guestbook for {name}")\n\n# Create a SQLAlchemy engine. Adjust this connection string for your database.\nengine = create_engine(f"postgresql+psycopg://postgres:{os.environ[\'PGPASSWORD\']}@localhost/greeting_guestbook")\n\n# Record the greeting in the database using SQLAlchemy\ndef insert_greeting(name: str) -> str:\n    with engine.begin() as sql_session:\n        query = dbos_hello.insert().values(name=name)\n        sql_session.execute(query)\n    logging.info(f">>> STEP 2: Greeting to {name} recorded in the database!")\n\n@app.get("/greeting/{name}")\ndef greeting_endpoint(name: str):\n    sign_guestbook(name)\n    insert_greeting(name)\n    return f"Thank you for being awesome, {name}!"\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Start your app with ",(0,o.jsx)(n.code,{children:"dbos start"}),".\nTo see that it's is working, visit this URL: ",(0,o.jsx)(n.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"})]}),"\n",(0,o.jsx)(t,{url:"http://localhost:8000/greeting/Mike",children:(0,o.jsx)(n.p,{children:'"Thank you for being awesome, Mike!"'})}),"\n",(0,o.jsx)(n.p,{children:"Each time you visit, your app should log first that it has recorded your greeting in the guestbook, then that it has recorded your greeting in the database."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"INFO:root:>>> STEP 1: Signed the guestbook for Mike\nINFO:root:>>> STEP 2: Greeting to Mike recorded in the database!\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now, this app has a problem: if it is interrupted after signing the guestbook, but before recording the greeting in the database, then ",(0,o.jsx)(n.strong,{children:"the greeting, though sent, will never be recorded"}),".\nThis is bad in many real-world situations, for example if a program fails to record making or receiving a payment.\nTo fix this problem, we'll use DBOS durable execution."]}),"\n",(0,o.jsx)(n.h2,{id:"2-durable-execution-with-workflows",children:"2. Durable Execution with Workflows"}),"\n",(0,o.jsxs)(n.p,{children:["Next, we want to ",(0,o.jsx)(n.strong,{children:"durably execute"})," our application: guarantee that it inserts exactly one database record per guestbook signature, even if interrupted or restarted.\nDBOS makes this easy with ",(0,o.jsx)(n.a,{href:"/python/tutorials/workflow-tutorial",children:"workflows"}),".\nWe can add durable execution to our app with ",(0,o.jsx)(n.strong,{children:"just four lines of code"})," and an import statement.\nCopy the following into your ",(0,o.jsx)(n.code,{children:"main.py"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"showLineNumbers",children:'import logging\nimport os\n\nimport requests\n#highlight-next-line\nfrom dbos import DBOS\nfrom fastapi import FastAPI\nfrom sqlalchemy import create_engine\n\nfrom .schema import dbos_hello\n\napp = FastAPI()\n#highlight-next-line\nDBOS(fastapi=app)\n\nlogging.basicConfig(level=logging.INFO)\n\n# Sign the guestbook using an HTTP POST request\n#highlight-next-line\n@DBOS.step()\ndef sign_guestbook(name: str):\n    requests.post(\n        "https://demo-guest-book.cloud.dbos.dev/record_greeting",\n        headers={"Content-Type": "application/json"},\n        json={"name": name},\n    )\n    logging.info(f">>> STEP 1: Signed the guestbook for {name}")\n\n# Create a SQLAlchemy engine. Adjust this connection string for your database.\nengine = create_engine(f"postgresql+psycopg://postgres:{os.environ[\'PGPASSWORD\']}@localhost/greeting_guestbook")\n\n# Record the greeting in the database using SQLAlchemy\n#highlight-next-line\n@DBOS.step()\ndef insert_greeting(name: str) -> str:\n    with engine.begin() as sql_session:\n        query = dbos_hello.insert().values(name=name)\n        sql_session.execute(query)\n    logging.info(f">>> STEP 2: Greeting to {name} recorded in the database!")\n\n@app.get("/greeting/{name}")\n#highlight-next-line\n@DBOS.workflow()\ndef greeting_endpoint(name: str):\n    sign_guestbook(name)\n    for _ in range(5):\n        logging.info("Press Control + C to stop the app...")\n        DBOS.sleep(1)\n    insert_greeting(name)\n    return f"Thank you for being awesome, {name}!"\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Only the ",(0,o.jsx)(n.strong,{children:"four highlighted lines of code"})," are needed to enable durable execution."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"First, we initialize DBOS on line 12."}),"\n",(0,o.jsxs)(n.li,{children:["Then, we annotate ",(0,o.jsx)(n.code,{children:"sign_guestbook"})," and ",(0,o.jsx)(n.code,{children:"insert_greeting"})," as ",(0,o.jsx)(n.a,{href:"/python/tutorials/step-tutorial",children:(0,o.jsx)(n.em,{children:"workflow steps"})})," on lines 17 and 30."]}),"\n",(0,o.jsxs)(n.li,{children:["Finally, we annotate ",(0,o.jsx)(n.code,{children:"greeting_endpoint"})," as a ",(0,o.jsx)(n.a,{href:"/python/tutorials/workflow-tutorial",children:(0,o.jsx)(n.em,{children:"durable workflow"})})," on line 38."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Because ",(0,o.jsx)(n.code,{children:"greeting_endpoint"})," is now a durably executed workflow, if it's ever interrupted, it automatically resumes from the last completed step.\nTo help demonstrate this, we also add a sleep so you can interrupt your app midway through the workflow."]}),"\n",(0,o.jsxs)(n.p,{children:["To see the power of durable execution, restart your app with ",(0,o.jsx)(n.code,{children:"dbos start"}),".\nThen, visit this URL: ",(0,o.jsx)(n.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"}),".\nIn your terminal, you should see an output like:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)\nINFO:root:>>> STEP 1: Signed the guestbook for Mike\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now, press CTRL+C stop your app. Then, run ",(0,o.jsx)(n.code,{children:"dbos start"})," to restart it. You should see an output like:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:Press Control + C to stop the app...\nINFO:root:>>> STEP 2: Greeting to Mike recorded in the database!\n"})}),"\n",(0,o.jsxs)(n.p,{children:['Without durable execution\u2014if you remove the four highlighted lines\u2014your app would restart with a "clean slate" and completely forget about your interrupted workflow.\nBy contrast, DBOS ',(0,o.jsx)(n.strong,{children:"automatically resumes your workflow from where it left off"})," and correctly completes it by recording the greeting to the database without re-signing the guestbook.\nThis is an incredibly powerful guarantee that helps you build complex, reliable applications without worrying about error handling or interruptions."]}),"\n",(0,o.jsx)(n.h2,{id:"3-optimizing-database-operations",children:"3. Optimizing Database Operations"}),"\n",(0,o.jsxs)(n.p,{children:["For workflow steps that access the database, like ",(0,o.jsx)(n.code,{children:"insert_greeting"})," in the example, DBOS provides powerful optimizations.\nTo see this in action, replace your ",(0,o.jsx)(n.code,{children:"insert_greeting"})," with the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",metastring:"showLineNumbers",children:'@DBOS.transaction()\ndef insert_greeting(name: str) -> str:\n    query = dbos_hello.insert().values(name=name)\n    DBOS.sql_session.execute(query)\n    logging.info(f">>> STEP 2: Greeting to {name} recorded in the database!")\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"/python/tutorials/transaction-tutorial",children:(0,o.jsx)(n.code,{children:"@DBOS.transaction()"})})," is a special annotation for workflow steps that access the database.\nIt executes your function in a single database transaction.\nWe recommend using transactions because:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["They give you access to a pre-configured database client (",(0,o.jsx)(n.code,{children:"DBOS.sql_session"}),"), which is more convenient than connecting to the database yourself. You no longer need to configure a SQLAlchemy engine!"]}),"\n",(0,o.jsxs)(n.li,{children:["Under the hood, transactions are highly optimized because DBOS can update its record of your program's execution ",(0,o.jsx)(n.em,{children:"inside"})," your transaction. For more info, see our ",(0,o.jsx)(n.a,{href:"/explanations/how-workflows-work",children:'"how workflows work"'})," explainer."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Now, restart your app with ",(0,o.jsx)(n.code,{children:"dbos start"})," and visit its URL again: ",(0,o.jsx)(n.a,{href:"http://localhost:8000/greeting/Mike",children:"http://localhost:8000/greeting/Mike"}),".\nThe app should durably execute your workflow the same as before!"]}),"\n",(0,o.jsxs)(n.p,{children:["The code for this guide is available ",(0,o.jsx)(n.a,{href:"https://github.com/dbos-inc/dbos-demo-apps/tree/main/python/greeting-guestbook",children:"on GitHub"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Next, to learn how to build more complex applications, check out our Python tutorials and ",(0,o.jsx)(n.a,{href:"/examples/",children:"example apps"}),"."]})]})}function c(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}function g(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(6540);const i={},s=o.createContext(i);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);